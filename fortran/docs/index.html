<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dice Fortran Backend Documentation: Fortran Developer Documentation Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Dice Fortran Backend Documentation
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Fortran Developer Documentation Main Page </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_repo_FORTRAN_MAINPAGE"></a> <img src="https://i.imgur.com/FXzNrNN.png" alt="" class="inline"/></p>
<p>This is the homepage for the Developer Documentation of the Fortran backend of <em>Dice</em>. On this site, you will find definitions for all of the functions and subroutines that we use to run VQMC simulations on our three currently implemented problems (QHO, H2plus and H2), as well as instructions for integrating support for a new problem into the code (see below).</p>
<h2>Links</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Link   </th><th class="markdownTableHeadNone">Destination    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">GitHub   </td><td class="markdownTableBodyNone"><a href="https://github.com/HetSys/PX915_2021_A">Here</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Dev Documentation Main   </td><td class="markdownTableBodyNone"><a href="https://joegilkes.github.io/PX915-Docs/">Here</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Fortran Dev Documentation   </td><td class="markdownTableBodyNone">You are here    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Python Dev Documentation   </td><td class="markdownTableBodyNone"><a href="https://joegilkes.github.io/PX915-Docs/python/docs/index.html">Here</a>   </td></tr>
</table>
<hr  />
<h2>Adding a new problem to Dice Quantum Monte Carlo (QMC)</h2>
<p>This section presents what the user would need to modify in the Fortran files (.f90) to add a new problem to Dice QMC.</p>
<p>The first step is to add the derived type of the new problem to <code><a class="el" href="shared__data_8f90.html">shared_data.f90</a></code>, under the section "Derived Types". Below is a sample format of how the derived type should look like.</p>
<hr  />
<div class="fragment"><div class="line"><span class="comment">! Sample format of new derived type for new problem</span></div>
<div class="line"><span class="keyword">type</span> :: new_problem_type</div>
<div class="line">        <span class="keywordtype">integer(int32)</span> :: steps=100000_int32         <span class="comment">! Total number of steps for each MMC chain</span></div>
<div class="line">        <span class="keywordtype">integer(int32)</span> :: burn_step=1000_int32       <span class="comment">! Number of steps to be burnt from the start of the MMC chain</span></div>
<div class="line">        <span class="keywordtype">integer(int32)</span> :: thin_step=10_int32         <span class="comment">! Interval of steps by which the MMC chain is thinned</span></div>
<div class="line"><span class="keywordtype">        real</span>(real64) :: rcut=3.0_real64              <span class="comment">! Maximum radius of search around the atoms             </span></div>
<div class="line"><span class="keywordtype">        real</span>(real64) :: sigma=1.8_real64             <span class="comment">! Standard deviation in MMC transition probability</span></div>
<div class="line">        <span class="keywordtype">logical</span> :: auto_params = .true.              <span class="comment">! True runs the automatic gradient search and false runs the grid search</span></div>
<div class="line"><span class="keywordtype">        real</span>(real64) :: parameter_for_new_problem = 0.4_real64      <span class="comment">! One can add more than one parameter in the same format</span></div>
<div class="line"><span class="keywordtype">        real</span>(real64), <span class="keywordtype">dimension(3)</span> :: parameter_grid = (/0,1,10/)   <span class="comment">! Grid of parameter values, format: [min, max, grid points]</span></div>
<div class="line"><span class="keywordtype">        real</span>(real64), <span class="keywordtype">dimension(3)</span> :: bond = (/1,3,10/)             <span class="comment">! Grid of bondlength values, format: [min, max, grid points]</span></div>
<div class="line">    <span class="keyword">end type </span>H2_type</div>
</div><!-- fragment --><p> If the user wants to add any other numerical constants then they can be added to the <code>constants</code> module in <code><a class="el" href="shared__data_8f90.html">shared_data.f90</a></code>.</p>
<p>The next step is to modify <code><a class="el" href="quantum__solvers_8f90.html">quantum_solvers.f90</a></code>. Regardless of the new problem the user will need to implement a function that calculates the transition probability of the current step and the proposed step. Below is a sample format of how the transition probability function should look like.</p>
<hr  />
<div class="fragment"><div class="line"><span class="comment">! Sample format of transition probability function</span></div>
<div class="line"><span class="keyword">function </span>trans_prob(parameters_of_new_problem, &amp;</div>
<div class="line">current_step, next_step, other_constants) <span class="keyword">result</span>(Prob)</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">implicit none</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">        real</span>(real64), <span class="keywordtype">intent(in)</span> :: parameters_of new_problem </div>
<div class="line"><span class="keywordtype">        real</span>(real64), <span class="keywordtype">dimension(3)</span>, <span class="keywordtype">intent(in)</span> :: current_step, next_step</div>
<div class="line"><span class="keywordtype">        real</span>(real64), <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(in)</span> :: other_constants </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">        real</span>(real64) :: Prob</div>
<div class="line"> </div>
<div class="line">        prob = ...</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">end function </span>Trans_Prob</div>
</div><!-- fragment --><p>The other function that is also necessary to be implemented regardless of the problem is one that calculates the local energy of the problem at a given position. Below is a sample format of how the local energy function should look like.</p>
<hr  />
 <div class="fragment"><div class="line"><span class="comment">! Sample format of local energy function </span></div>
<div class="line"><span class="keyword">function </span>local_energy(parameters_of_new_problem, &amp;</div>
<div class="line">position) <span class="keyword">result</span>(E_loc)</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">implicit none</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">        real</span>(real64), <span class="keywordtype">intent(in)</span>, <span class="keywordtype">dimension(:)</span> :: parameters</div>
<div class="line"><span class="keywordtype">        real</span>(real64), <span class="keywordtype">intent(in)</span>, <span class="keywordtype">dimension(:)</span> :: position </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">        real</span>(real64) :: E_loc</div>
<div class="line"> </div>
<div class="line">        e_loc = ...</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">end function </span>Local_Energy</div>
</div><!-- fragment --><p>Most problems will require the user to implement a wave function corresponding to the problem, in order to calculate the transitional probabilities and local energies. The user is free to implement this however they want, as long as the local energy and transitional probability functions have the formats presented above. Another remark for the user is that when calculating the energy, unless the derivatives can be found analytically the user will need to use some numerical method to obtain the derivatives, which they will have to implement themselves. All of the modifications to <code><a class="el" href="quantum__solvers_8f90.html">quantum_solvers.f90</a></code> should be done after the section <code>H_2 Solvers</code>. <br  />
</p>
<p>The next step is to modify the <code><a class="el" href="vqmc_8f90.html">vqmc.f90</a></code> module. The user will need to implement a new VQMC solver for the new problem in this module. The user should use one of the "VQMC_QHO", "VQMC_H_2_plus" or "VQMC_H_2" sub-routines as a template for their VQMC solver. This is because they would only need to modify the transitional probability and local energy functions in the Metropolis algorithm. Below is a sample template of how the Metropolis algorithm should look like.</p>
<hr  />
 <div class="fragment"><div class="line"><span class="comment">! Metropolis Algorithm without burning and thinning for new problem</span></div>
<div class="line"><span class="keywordflow">do</span> i = 2, n            </div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">    <span class="comment">! Modify here the function for transitional probability</span></div>
<div class="line">    log_prob_n = log(trans_prob(parameters, x(i-1), x_n(1)))</div>
<div class="line">            </div>
<div class="line">    ...</div>
<div class="line">            </div>
<div class="line">    <span class="comment">! Compare the drawn sample from the uniform distribution with the acceptance ratio </span></div>
<div class="line">    <span class="keywordflow">if</span> (a_prob_trans &gt;= unif_num) <span class="keywordflow">then</span> </div>
<div class="line">        ...</div>
<div class="line">        <span class="comment">! Modify here the function for local energy  </span></div>
<div class="line">        energy_chain(i) = local_energy(parameters, x_n(1))</div>
<div class="line">    <span class="keywordflow">else</span> </div>
<div class="line">        ... </div>
<div class="line">        </div>
<div class="line">        <span class="comment">! Modify here the function for local energy</span></div>
<div class="line">        energy_chain(i) = local_energy(parameters, x(i-1))</div>
<div class="line"><span class="keywordflow">    end if</span> </div>
<div class="line"><span class="keyword">end </span>do</div>
</div><!-- fragment --><p> If the user uses one of the "VQMC_QHO", "VQMC_H_2_plus" or "VQMC_H_2" sub-routines as a template then the burning and thinning features can be reused for the new problem. It is important to stick to one of the VQMC sub-routines so that the outputs are the same.</p>
<p>The next step is to add the automatic gradient descent-based search (GDBS) to <code><a class="el" href="vqmc_8f90.html">vqmc.f90</a></code>. The user should use "Auto_H_2", "Auto_H_2_plus" sub-routines as a template and should only modify the VQMC solver being called (see below). This modification should be place after the new VQMC solver.</p>
<hr  />
 <div class="fragment"><div class="line"><span class="keyword">subroutine </span>auto_h_2(...)</div>
<div class="line">        ...</div>
<div class="line">        <span class="comment">! Main iteration loop</span></div>
<div class="line">        <span class="keywordflow">do</span> k = cauto_start, maxiter</div>
<div class="line"> </div>
<div class="line">            <span class="comment">! Calculate gradient at current beta</span></div>
<div class="line">            <span class="comment">! This should be modified to the VQMC</span></div>
<div class="line">            <span class="comment">! solver that user created in the </span></div>
<div class="line">            <span class="comment">! last step.</span></div>
<div class="line">            <span class="keyword">call </span>vqmc_h_2(...)</div>
<div class="line">        ...</div>
<div class="line"><span class="keywordflow">        end do</span> </div>
<div class="line">        </div>
<div class="line"><span class="keyword">end subroutine </span>Auto_H_2</div>
</div><!-- fragment --><p> If the user does not want to do a GDBS then they can ignore the previous step. Instead they can add a grid search to <code><a class="el" href="vqmc_8f90.html">vqmc.f90</a></code>. The user should use "Grid_H_2", "Grid_H_2_plus" sub-routines as a template and should only modify the VQMC solver being called (see below). This sub-routine should be placed after the new VQMC solver.</p>
<hr  />
 <div class="fragment"><div class="line"><span class="keyword">subroutine </span>grid_h_2_plus(...)</div>
<div class="line">        ...</div>
<div class="line">    <span class="comment">! Loop over c values</span></div>
<div class="line">    <span class="keywordflow">do</span> i = cgrid_start, <span class="keyword">size</span>(c_array)</div>
<div class="line"> </div>
<div class="line">        <span class="comment">! Calculate energy at current value of c</span></div>
<div class="line">        <span class="comment">! This should be modified to the VQMC</span></div>
<div class="line">        <span class="comment">! solver that user created in the </span></div>
<div class="line">        <span class="comment">! last step.</span></div>
<div class="line">        <span class="keyword">call </span>vqmc_h_2_plus(...)</div>
<div class="line">        ...</div>
<div class="line"><span class="keywordflow">    end do</span></div>
<div class="line">    ...</div>
<div class="line"><span class="keyword">end subroutine </span>Grid_H_2_plus</div>
</div><!-- fragment --><p> The user can of course add both of the search methods mentioned above, but it is important that they at least add one. The final item the user has to add to <code><a class="el" href="vqmc_8f90.html">vqmc.f90</a></code> is the equilibration run subroutine. This can be based off "Equil_QHO" or "Equil_H_2" and the user should only modify the VQMC solver being used like in the previous step. <br  />
</p>
<p>The final step is to modify <code><a class="el" href="driver_8f90.html">driver.f90</a></code>. The user should add a new case with the corresponding problem to the "VQMC Loops" section. The user should use the following "Quantum Harmonic Oscillator" subsection, as a template to write their code. The code should only be modified so that the GDBS or grid search, and equilibration subroutines for the new problem are called (see below).</p>
<hr  />
 <div class="fragment"><div class="line"><span class="comment">case(&#39;New_problem&#39;)</span></div>
<div class="line">    ...</div>
<div class="line">    <span class="comment">! Loop over bond lengths</span></div>
<div class="line">    <span class="keywordflow">do</span> b = 1, int(h2plus%bond(3))</div>
<div class="line">        ...</div>
<div class="line">        <span class="comment">! Main VQMC callers</span></div>
<div class="line">        <span class="keywordflow">if</span> (.not. run_equil) <span class="keywordflow">then</span></div>
<div class="line">            <span class="keywordflow">if</span> (h2plus%auto_params) <span class="keywordflow">then</span></div>
<div class="line">            <span class="comment">! Search for best param at this bond length</span></div>
<div class="line">            <span class="comment">! This should be modified to the </span></div>
<div class="line">            <span class="comment">! GDBS sub-routine for this problem</span></div>
<div class="line">            <span class="keyword">call </span>auto_h_2_plus(...)</div>
<div class="line">            ...</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line"> </div>
<div class="line">            <span class="comment">! Find best param in grid at this bond length</span></div>
<div class="line">            <span class="comment">! This should be modified to the </span></div>
<div class="line">            <span class="comment">! Grid search routine for this problem </span></div>
<div class="line">            <span class="keyword">call </span>grid_h_2_plus(...)</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">            end if</span></div>
<div class="line">        ...</div>
<div class="line"><span class="keywordflow">        end if</span> </div>
<div class="line">        ...</div>
<div class="line">        <span class="keywordflow">if</span> </div>
<div class="line">            ...</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            <span class="comment">! Run equilibrations serially on rank 0</span></div>
<div class="line">            <span class="keywordflow">if</span> (my_rank==0) <span class="keywordflow">then</span></div>
<div class="line">                <span class="comment">! This shoud be modified to </span></div>
<div class="line">                <span class="comment">! the equilibration sub_routine </span></div>
<div class="line">                <span class="comment">! for this new problem</span></div>
<div class="line">                <span class="keyword">call </span>equil_h_2_plus(...)</div>
<div class="line">            ...</div>
<div class="line"><span class="keywordflow">        end if</span></div>
<div class="line">    ...</div>
<div class="line"><span class="keywordflow">    end do</span></div>
<div class="line">...        </div>
</div><!-- fragment --><p>After all the modifications the user should be able to run the code the same way as it is explained in the user manual.</p>
<p>This documentation was generated from commit f6fcd0d </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
