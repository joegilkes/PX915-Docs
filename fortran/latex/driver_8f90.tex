\hypertarget{driver_8f90}{}\doxysection{repo/src/driver.f90 File Reference}
\label{driver_8f90}\index{repo/src/driver.f90@{repo/src/driver.f90}}
\doxysubsection*{Functions/\+Subroutines}
\begin{DoxyCompactItemize}
\item 
program \mbox{\hyperlink{driver_8f90_a8ec2266d83cd6c0b762cbcbc92c0af3d}{main}}
\begin{DoxyCompactList}\small\item\em Main program, contains the driver subroutine that runs all other code. \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{driver_8f90_aae94725eafaedc467ab9bfefcae9769e}{driver}} ()
\begin{DoxyCompactList}\small\item\em Subroutine for running the main code (needed for Doxygen compatability). \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Function/\+Subroutine Documentation}
\mbox{\Hypertarget{driver_8f90_a8ec2266d83cd6c0b762cbcbc92c0af3d}\label{driver_8f90_a8ec2266d83cd6c0b762cbcbc92c0af3d}} 
\index{driver.f90@{driver.f90}!main@{main}}
\index{main@{main}!driver.f90@{driver.f90}}
\doxysubsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily program main}



Main program, contains the driver subroutine that runs all other code. 

Packaged as a separate subroutine within this program so that it remains compatible with Doxygen, which otherwise ignores any further documentation. 

Definition at line 14 of file driver.\+f90.

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=550pt]{driver_8f90_a8ec2266d83cd6c0b762cbcbc92c0af3d_cgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{driver_8f90_aae94725eafaedc467ab9bfefcae9769e}\label{driver_8f90_aae94725eafaedc467ab9bfefcae9769e}} 
\index{driver.f90@{driver.f90}!driver@{driver}}
\index{driver@{driver}!driver.f90@{driver.f90}}
\doxysubsubsection{\texorpdfstring{driver()}{driver()}}
{\footnotesize\ttfamily subroutine main\+::driver}



Subroutine for running the main code (needed for Doxygen compatability). 

The main driver code for the VQMC program. Links all other modules to run VQMC calculations on the Quantum Harmonic Oscillator (QHO), the Hydrogen Molecular Ion (H2plus) and the Hydrogen Molecule (H2).

Reads inputs from a provided input file, either generated by a Python frontend script or handwritten in the Fortran Namelist I/O format. Determines the problem to be solved, then runs VQMC routines. These can be run over a set parameter space, or in the case of the H2plus and H2 problems, can automatically determine the best variational parameter for the current bond length. Outputs results in Net\+CDF format, to be read by a Python frontend visualisation notebook for analysis.

Also includes extensions to start separate equilibration runs for determining optimal burning/thinning parameters for the Markov chain, and to write the energy traces for each parameter / parameter combination. Also capable of logging the full Markov chain to file (slow, should only be used for debug). 

Definition at line 53 of file driver.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{54 }
\DoxyCodeLine{55 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{56 \textcolor{comment}{! SECTION: Variable Declarations}}
\DoxyCodeLine{57 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{58 }
\DoxyCodeLine{59 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: p\_arr}
\DoxyCodeLine{60 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: bonds}
\DoxyCodeLine{61 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: H2plus\_param\_c\_array}
\DoxyCodeLine{62 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: H2\_param\_a\_array}
\DoxyCodeLine{63 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: H2\_param\_beta\_array}
\DoxyCodeLine{64 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energies}
\DoxyCodeLine{65 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: variances}
\DoxyCodeLine{66 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: accept\_rates}
\DoxyCodeLine{68 \textcolor{keywordtype}{    real}(real64) :: H2plus\_param\_c\_guess}
\DoxyCodeLine{69 \textcolor{keywordtype}{    real}(real64) :: H2plus\_param\_c\_opt}
\DoxyCodeLine{70 \textcolor{keywordtype}{    real}(real64) :: H2\_param\_beta\_guess}
\DoxyCodeLine{71 \textcolor{keywordtype}{    real}(real64) :: H2\_param\_beta\_opt}
\DoxyCodeLine{72 \textcolor{keywordtype}{    real}(real64) :: H2\_param\_a}
\DoxyCodeLine{73 \textcolor{keywordtype}{    real}(real64) :: energy}
\DoxyCodeLine{74 \textcolor{keywordtype}{    real}(real64) :: variance}
\DoxyCodeLine{75 \textcolor{keywordtype}{    real}(real64) :: accept\_rate}
\DoxyCodeLine{76     }
\DoxyCodeLine{77     \textcolor{keywordtype}{integer} :: b, i}
\DoxyCodeLine{78     \textcolor{keywordtype}{integer} :: logiostat}
\DoxyCodeLine{79     \textcolor{keywordtype}{integer} :: ierr}
\DoxyCodeLine{80     \textcolor{keywordtype}{character(len=1)} :: H2plus\_c\_converged}
\DoxyCodeLine{81     \textcolor{keywordtype}{character(len=1)} :: H2\_beta\_converged}
\DoxyCodeLine{82 }
\DoxyCodeLine{83 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{84 \textcolor{comment}{! SECTION: Initial Setup}}
\DoxyCodeLine{85 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{86     \textcolor{comment}{! Initialise MPI}}
\DoxyCodeLine{87     \textcolor{comment}{! Initialize MPI}}
\DoxyCodeLine{88     \textcolor{keyword}{call }mpi\_init(mpierr)}
\DoxyCodeLine{89 }
\DoxyCodeLine{90     \textcolor{comment}{! Find number of processors and current rank}}
\DoxyCodeLine{91     \textcolor{keyword}{call }mpi\_comm\_size(mpi\_comm\_world,p,mpierr)}
\DoxyCodeLine{92     \textcolor{keyword}{call }mpi\_comm\_rank(mpi\_comm\_world,my\_rank,mpierr)  }
\DoxyCodeLine{93 }
\DoxyCodeLine{94     \textcolor{comment}{! Read the input parameters.}}
\DoxyCodeLine{95     \textcolor{keyword}{call }read\_inputs()}
\DoxyCodeLine{96     }
\DoxyCodeLine{97     \textcolor{comment}{! File management from rank 0}}
\DoxyCodeLine{98     \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{99 }
\DoxyCodeLine{100         \textcolor{comment}{! Notify user of the system }}
\DoxyCodeLine{101         \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('System: ', A)"{}}) p\_system}
\DoxyCodeLine{102         \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}}) }
\DoxyCodeLine{103 }
\DoxyCodeLine{104         \textcolor{comment}{! Make sure the equilibration output directory exists if needed.}}
\DoxyCodeLine{105         \textcolor{comment}{! There is no simple way to check directory existence that works}}
\DoxyCodeLine{106         \textcolor{comment}{! with both ifort and gfortran, so mkdir is just run with stderr}}
\DoxyCodeLine{107         \textcolor{comment}{! suppressed instead.}}
\DoxyCodeLine{108         \textcolor{keywordflow}{if} (run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{109             \textcolor{keyword}{call }system(\textcolor{stringliteral}{'mkdir ./equil\_out 2>/dev/null'})}
\DoxyCodeLine{110             \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Dice QMC started in Equilibration Mode')"{}})}
\DoxyCodeLine{111             \textcolor{comment}{! Check step length}}
\DoxyCodeLine{112             \textcolor{keywordflow}{if}(run\_steps>max\_chain\_len) \textcolor{keywordflow}{then} }
\DoxyCodeLine{113                 \textcolor{keyword}{write}(*,\textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{114                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('A, I7, A')"{}}) \textcolor{stringliteral}{'WARNING: The program will be slow at writing equilibration files, \&}}
\DoxyCodeLine{115 \textcolor{stringliteral}{}\textcolor{stringliteral}{                           \&as the requested number of steps exceeds the recommended \&}}
\DoxyCodeLine{116 \textcolor{stringliteral}{}\textcolor{stringliteral}{                           \&upper limit of '}, max\_chain\_len, \textcolor{stringliteral}{' steps. Refer to the user manual for details.'}}
\DoxyCodeLine{117                 \textcolor{keyword}{write}(*,\textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{118 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{119 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{120 }
\DoxyCodeLine{121         \textcolor{comment}{! Same directory check as above for write\_chains.}}
\DoxyCodeLine{122         \textcolor{keywordflow}{if} (write\_chains) \textcolor{keywordflow}{then}}
\DoxyCodeLine{123             \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{124                 \textcolor{keyword}{call }system(\textcolor{stringliteral}{'mkdir ./chains\_out 2>/dev/null'})}
\DoxyCodeLine{125                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Dice QMC started in full VQMC mode with additional Markov chain outputting')"{}}) }
\DoxyCodeLine{126                 \textcolor{comment}{! Check step length}}
\DoxyCodeLine{127                 \textcolor{keywordflow}{if}(run\_steps>max\_chain\_len) \textcolor{keywordflow}{then} }
\DoxyCodeLine{128                     \textcolor{keyword}{write}(*,*) \textcolor{stringliteral}{'NOTE: For efficiency, only the first '}, max\_chain\_len,\textcolor{stringliteral}{' entries of the Markov chain \&}}
\DoxyCodeLine{129 \textcolor{stringliteral}{}\textcolor{stringliteral}{                               \&(after burning and thinning) will be written out to the chains\_out folder.'}}
\DoxyCodeLine{130 \textcolor{keywordflow}{                endif}}
\DoxyCodeLine{131             \textcolor{keywordflow}{else}}
\DoxyCodeLine{132                 error stop \textcolor{stringliteral}{"{}Dice QMC cannot be started with both run\_equil and write\_chains set \&}}
\DoxyCodeLine{133 \textcolor{stringliteral}{}\textcolor{stringliteral}{                \&to TRUE. Check your input params.txt and try again."{}}}
\DoxyCodeLine{134 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{135 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{136 }
\DoxyCodeLine{137         \textcolor{comment}{! Initialise the log file if required.}}
\DoxyCodeLine{138         \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{139 }
\DoxyCodeLine{140             \textcolor{comment}{! Open the logfile}}
\DoxyCodeLine{141             \textcolor{keyword}{open}(logid, file=logfile, status=\textcolor{stringliteral}{'unknown'}, access=\textcolor{stringliteral}{'sequential'}, \&}
\DoxyCodeLine{142                 form=\textcolor{stringliteral}{'formatted'}, iostat=logiostat)}
\DoxyCodeLine{143             \textcolor{keywordflow}{if} (logiostat .ne. 0) \textcolor{keyword}{write}(0, *) \textcolor{stringliteral}{'Error opening log file '}, logfile}
\DoxyCodeLine{144 }
\DoxyCodeLine{145             \textcolor{comment}{! Write program details to logfile}}
\DoxyCodeLine{146             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('*** Dice QMC log file ***')"{}}) \textcolor{comment}{! include date/time?}}
\DoxyCodeLine{147             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{148             \textcolor{keyword}{write}(logid, *) \textcolor{stringliteral}{'System: '}, p\_system}
\DoxyCodeLine{149             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{150 }
\DoxyCodeLine{151             \textcolor{comment}{! Update log-\/writer tag for rank 0}}
\DoxyCodeLine{152             i\_log = .true.}
\DoxyCodeLine{153             }
\DoxyCodeLine{154 \textcolor{keywordflow}{        endif} }
\DoxyCodeLine{155     }
\DoxyCodeLine{156 \textcolor{keywordflow}{    endif}}
\DoxyCodeLine{157 }
\DoxyCodeLine{158     \textcolor{comment}{! If p\_system='test', run test module.}}
\DoxyCodeLine{159     \textcolor{keywordflow}{if} (trim(p\_system)==\textcolor{stringliteral}{'test'}) \textcolor{keywordflow}{then}}
\DoxyCodeLine{160         \textcolor{comment}{! Tests need to run on a single processor}}
\DoxyCodeLine{161         \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{162             \textcolor{keyword}{call }unit\_tests()}
\DoxyCodeLine{163 \textcolor{keywordflow}{        endif}}
\DoxyCodeLine{164         \textcolor{comment}{! Exit the program}}
\DoxyCodeLine{165         \textcolor{keyword}{call }mpi\_finalize(mpierr)}
\DoxyCodeLine{166         \textcolor{keyword}{call }exit()}
\DoxyCodeLine{167 \textcolor{keywordflow}{    endif}}
\DoxyCodeLine{168 }
\DoxyCodeLine{169     \textcolor{comment}{! If not a test job, setup MPI worksharing.}}
\DoxyCodeLine{170     \textcolor{comment}{! Equilibrations will be run serially on rank 0.}}
\DoxyCodeLine{171     \textcolor{comment}{! For non-\/equilibration runs:}}
\DoxyCodeLine{172     \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{173 }
\DoxyCodeLine{174         \textcolor{comment}{! Split workload for VQMC runs}}
\DoxyCodeLine{175         my\_steps = run\_steps / p \textcolor{comment}{! Integer division}}
\DoxyCodeLine{176         \textcolor{keywordflow}{if} (my\_rank < (run\_steps-\/(my\_steps*p))) \textcolor{keywordflow}{then}}
\DoxyCodeLine{177             my\_steps = my\_steps+1}
\DoxyCodeLine{178 \textcolor{keywordflow}{        endif} }
\DoxyCodeLine{179 }
\DoxyCodeLine{180         \textcolor{comment}{! Pre-\/calculate frequently used factors.}}
\DoxyCodeLine{181         my\_size = my\_steps/tstep \textcolor{comment}{! Integer division}}
\DoxyCodeLine{182         \textcolor{keyword}{call }mpi\_reduce(my\_size,tot\_size,1,mpi\_integer,mpi\_sum,0,mpi\_comm\_world,mpierr)}
\DoxyCodeLine{183         \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{184             \textcolor{comment}{! Factor representing division by total chain size after burning \& thinning}}
\DoxyCodeLine{185             per\_step = 1.0\_real64 / real(tot\_size,kind=real64)}
\DoxyCodeLine{186             \textcolor{comment}{! Factor representing division by number of processors}}
\DoxyCodeLine{187             per\_proc = 1.0\_real64 / real(p,kind=real64)}
\DoxyCodeLine{188             \textcolor{comment}{! Factor representing division by square of number of processors}}
\DoxyCodeLine{189             per\_proc2 = per\_proc**2}
\DoxyCodeLine{190 \textcolor{keywordflow}{        endif}}
\DoxyCodeLine{191         \textcolor{comment}{! The factor 'per\_proc' is required on all ranks for auto\_grad calculations.}}
\DoxyCodeLine{192         \textcolor{comment}{! To ensure floating point agreement, broadcaste it from rank 0, rather than re-\/calculating on every rank.}}
\DoxyCodeLine{193         \textcolor{keyword}{call }mpi\_bcast(per\_proc,1,mpi\_double\_precision,0,mpi\_comm\_world,mpierr)}
\DoxyCodeLine{194     }
\DoxyCodeLine{195 \textcolor{keywordflow}{    endif}}
\DoxyCodeLine{196 }
\DoxyCodeLine{197     \textcolor{comment}{! Initialise the random number generator}}
\DoxyCodeLine{198     \textcolor{keywordflow}{if} (run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{199         \textcolor{comment}{! Run calculations on one processor (rank 0)}}
\DoxyCodeLine{200         p = 1}
\DoxyCodeLine{201         \textcolor{keywordflow}{if}(my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{202             \textcolor{comment}{! Initialise the seed on rank 0}}
\DoxyCodeLine{203             \textcolor{keyword}{call }init\_ran1() }
\DoxyCodeLine{204             \textcolor{comment}{! Update logfile if required}}
\DoxyCodeLine{205             \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{206                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Initial seed from /dev/urandom: ', I20)"{}}) seed}
\DoxyCodeLine{207                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{208 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{209             \textcolor{comment}{! Ensure auto\_params is disabled}}
\DoxyCodeLine{210             \textcolor{keywordflow}{if} (trim(p\_system) .eq. \textcolor{stringliteral}{'H2plus'} .and. h2plus\%auto\_params) \textcolor{keywordflow}{then}}
\DoxyCodeLine{211                 h2plus\%auto\_params = .false.}
\DoxyCodeLine{212                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('WARNING: H2plus\%auto\_params should not be .TRUE. when in Equilibration Mode, disabling...')"{}})}
\DoxyCodeLine{213             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (trim(p\_system) .eq. \textcolor{stringliteral}{'H2'} .and. h2\%auto\_params) \textcolor{keywordflow}{then}}
\DoxyCodeLine{214                 h2\%auto\_params = .false.}
\DoxyCodeLine{215                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('WARNING: H2plus\%auto\_params should not be .TRUE. when in Equilibration Mode, disabling...')"{}})}
\DoxyCodeLine{216 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{217 \textcolor{keywordflow}{        endif}}
\DoxyCodeLine{218     \textcolor{keywordflow}{else}}
\DoxyCodeLine{219         \textcolor{comment}{! For non-\/equil VQMC runs,}}
\DoxyCodeLine{220         \textcolor{comment}{! Initialise a seed on each MPI rank}}
\DoxyCodeLine{221         \textcolor{keyword}{call }init\_ran1() }
\DoxyCodeLine{222         \textcolor{comment}{! Update logfile if required}}
\DoxyCodeLine{223         \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{224             \textcolor{keywordflow}{if} (my\_rank>0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{225                 \textcolor{comment}{! Send the seeds to rank 0}}
\DoxyCodeLine{226                 \textcolor{keyword}{call }mpi\_send(seed,1,mpi\_integer,0,tag\_seed,mpi\_comm\_world,mpierr)}
\DoxyCodeLine{227             \textcolor{keywordflow}{else}}
\DoxyCodeLine{228                 \textcolor{comment}{! Write seed of rank=0 to logfile}}
\DoxyCodeLine{229                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Rank ',I2,'. Initial seed from /dev/urandom: ', I20)"{}}) my\_rank, seed}
\DoxyCodeLine{230                 \textcolor{keywordflow}{do} ip = 1, p-\/1}
\DoxyCodeLine{231                     \textcolor{comment}{! Receive seed value from rank=ip}}
\DoxyCodeLine{232                     \textcolor{keyword}{call }mpi\_recv(ip\_seed,1,mpi\_integer,ip,tag\_seed,mpi\_comm\_world,status,mpierr) }
\DoxyCodeLine{233                     \textcolor{comment}{! Write seed of rank=ip to logfile}}
\DoxyCodeLine{234                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Rank ',I2,'. Initial seed from /dev/urandom: ', I20)"{}}) ip, ip\_seed}
\DoxyCodeLine{235 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{236                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{237 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{238 \textcolor{keywordflow}{        endif} }
\DoxyCodeLine{239 }
\DoxyCodeLine{240 \textcolor{keywordflow}{    endif} }
\DoxyCodeLine{241 }
\DoxyCodeLine{242 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{243 \textcolor{comment}{! SECTION: VQMC Loops}}
\DoxyCodeLine{244 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{245 }
\DoxyCodeLine{246     \textcolor{comment}{! Execute problem-\/dependent routines.}}
\DoxyCodeLine{247     \textcolor{keywordflow}{select case}(trim(p\_system))}
\DoxyCodeLine{248 }
\DoxyCodeLine{249     \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{250     \textcolor{comment}{!   SUBSECTION: Quantum Harmonic Oscillator}}
\DoxyCodeLine{251     \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{252 }
\DoxyCodeLine{253         \textcolor{keywordflow}{case}(\textcolor{stringliteral}{'QHO'})}
\DoxyCodeLine{254 }
\DoxyCodeLine{255             \textcolor{comment}{! Print out system info.}}
\DoxyCodeLine{256             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{257                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Doing VQMC runs across ', I3, ' parameter(s).')"{}}) int(qho\%alpha(3))}
\DoxyCodeLine{258                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Steps: ', I10, ', Burn Steps: ', I7, ', Thin Every ', I7, ' Steps.')"{}}) \&}
\DoxyCodeLine{259                     qho\%steps, qho\%burn\_step, qho\%thin\_step}
\DoxyCodeLine{260                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{261 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{262 }
\DoxyCodeLine{263             \textcolor{comment}{! Set up alpha array.}}
\DoxyCodeLine{264             p\_arr = linspace(qho\%alpha(1), qho\%alpha(2), qho\%alpha(3))}
\DoxyCodeLine{265 }
\DoxyCodeLine{266             \textcolor{keywordflow}{if}(my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{267                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Grid search across linearly spaced parameters enabled.')"{}})}
\DoxyCodeLine{268                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{269                 \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{270                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Grid search across linearly spaced parameters enabled.')"{}})}
\DoxyCodeLine{271                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Array of alpha values: ')"{}})}
\DoxyCodeLine{272                     \textcolor{keywordflow}{do} i = 1, int(qho\%alpha(3))}
\DoxyCodeLine{273                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(F12.8)"{}}) p\_arr(i)}
\DoxyCodeLine{274 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{275                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{276 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{277 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{278 }
\DoxyCodeLine{279             \textcolor{comment}{! Main VQMC callers.}}
\DoxyCodeLine{280             \textcolor{keywordflow}{if} (run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{281                 \textcolor{comment}{! For restarts, input\_parser would have already set alpha\_start}}
\DoxyCodeLine{282                 \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{283                     \textcolor{keyword}{call }equil\_qho(p\_arr)}
\DoxyCodeLine{284 \textcolor{keywordflow}{                endif} }
\DoxyCodeLine{285             \textcolor{keywordflow}{else}}
\DoxyCodeLine{286                 \textcolor{comment}{! Initialise arrays}}
\DoxyCodeLine{287                 \textcolor{keyword}{allocate}(energies(int(qho\%alpha(3)))); energies(:) = 0.0\_real64}
\DoxyCodeLine{288                 \textcolor{keyword}{allocate}(variances(int(qho\%alpha(3)))); variances(:) = 0.0\_real64}
\DoxyCodeLine{289                 \textcolor{keyword}{allocate}(accept\_rates(int(qho\%alpha(3)))); accept\_rates(:) = 0.0\_real64}
\DoxyCodeLine{290 }
\DoxyCodeLine{291                 \textcolor{comment}{! Sort out restarting}}
\DoxyCodeLine{292                 \textcolor{keywordflow}{if} (run\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{293                     \textcolor{comment}{! Insert optimised parameters, energies, accept\_rates, and variances into arrays}}
\DoxyCodeLine{294                     \textcolor{keyword}{call }read\_energies(resfile\_etot, energies, variances, accept\_rates)}
\DoxyCodeLine{295 \textcolor{keywordflow}{                endif} }
\DoxyCodeLine{296 }
\DoxyCodeLine{297                 \textcolor{comment}{! Run the grid evaluation}}
\DoxyCodeLine{298                 \textcolor{keyword}{call }grid\_qho(p\_arr, energies, accept\_rates, variances)}
\DoxyCodeLine{299 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{300 }
\DoxyCodeLine{301     \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{302     \textcolor{comment}{!   SUBSECTION: Hydrogen Molecular Ion}}
\DoxyCodeLine{303     \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{304 }
\DoxyCodeLine{305         \textcolor{keywordflow}{case}(\textcolor{stringliteral}{'H2plus'})}
\DoxyCodeLine{306 }
\DoxyCodeLine{307             \textcolor{comment}{! Initialise arrays}}
\DoxyCodeLine{308             \textcolor{keyword}{allocate}(energies(int(h2plus\%bond(3))))}
\DoxyCodeLine{309             \textcolor{keyword}{allocate}(variances(int(h2plus\%bond(3))))}
\DoxyCodeLine{310             \textcolor{keyword}{allocate}(accept\_rates(int(h2plus\%bond(3))))}
\DoxyCodeLine{311             \textcolor{keyword}{allocate}(h2plus\_param\_c\_array(int(h2plus\%bond(3))))}
\DoxyCodeLine{312 }
\DoxyCodeLine{313             \textcolor{comment}{! Print out system info.}}
\DoxyCodeLine{314             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{315                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Doing VQMC runs across ', I7, ' bond lengths.')"{}}) int(h2plus\%bond(3))}
\DoxyCodeLine{316                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Steps: ', I10, ', Burn Steps: ', I7, ', Thin Every ', \&}}
\DoxyCodeLine{317 \textcolor{stringliteral}{}\textcolor{stringliteral}{                    \& I7, ' Steps.')"{}}) h2plus\%steps, h2plus\%burn\_step, h2plus\%thin\_step}
\DoxyCodeLine{318                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{319 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{320 }
\DoxyCodeLine{321             \textcolor{comment}{! Set up bond length array}}
\DoxyCodeLine{322             bonds = linspace(h2plus\%bond(1), h2plus\%bond(2), h2plus\%bond(3))}
\DoxyCodeLine{323             \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{324                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Array of bond lengths: ')"{}})}
\DoxyCodeLine{325                 \textcolor{keywordflow}{do} i = 1, int(h2plus\%bond(3))}
\DoxyCodeLine{326                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Bond length ', I4, ': ', F7.4)"{}}) i, bonds(i)}
\DoxyCodeLine{327 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{328                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{329 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{330 }
\DoxyCodeLine{331             \textcolor{comment}{! Set up parameter array, if doing a grid search}}
\DoxyCodeLine{332             \textcolor{keywordflow}{if} (h2plus\%auto\_params .eqv. .false.) \textcolor{keywordflow}{then}}
\DoxyCodeLine{333                 p\_arr = linspace(h2plus\%c\_grid(1), h2plus\%c\_grid(2), h2plus\%c\_grid(3))}
\DoxyCodeLine{334 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{335 }
\DoxyCodeLine{336             \textcolor{comment}{! Update user from rank 0}}
\DoxyCodeLine{337             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{338                 \textcolor{keywordflow}{if} (h2plus\%auto\_params .eqv. .false.) \textcolor{keywordflow}{then}}
\DoxyCodeLine{339                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Grid search across linearly spaced parameters enabled.')"{}})}
\DoxyCodeLine{340                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{341                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{342                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Grid search across linearly spaced parameters enabled.')"{}})}
\DoxyCodeLine{343                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Array of c values: ')"{}})}
\DoxyCodeLine{344                         \textcolor{keywordflow}{do} i = 1, int(h2plus\%c\_grid(3))}
\DoxyCodeLine{345                             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(F12.8)"{}}) p\_arr(i)}
\DoxyCodeLine{346 \textcolor{keywordflow}{                        end do}}
\DoxyCodeLine{347                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{348 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{349                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{350                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Automatic search across parameters enabled.')"{}})}
\DoxyCodeLine{351                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{352                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{353                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Automatic search across parameters enabled.')"{}})}
\DoxyCodeLine{354                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{355 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{356 \textcolor{keywordflow}{                endif}}
\DoxyCodeLine{357 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{358 }
\DoxyCodeLine{359             \textcolor{comment}{! Sort out restarting}}
\DoxyCodeLine{360             \textcolor{keywordflow}{if} (run\_restart .and. (.not. run\_equil)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{361                 \textcolor{comment}{! Insert optimised parameters, energies, accept\_rates, and variances into arrays}}
\DoxyCodeLine{362                 \textcolor{keyword}{call }read\_energies\_h2plus(resfile\_etot, energies, variances, accept\_rates,h2plus\_param\_c\_array)}
\DoxyCodeLine{363 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{364 }
\DoxyCodeLine{365             \textcolor{comment}{! Set starting guess value}}
\DoxyCodeLine{366             \textcolor{keywordflow}{if} ((.not. run\_equil) .and. h2plus\%auto\_params) \textcolor{keywordflow}{then}}
\DoxyCodeLine{367                 \textcolor{keywordflow}{if} ( run\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{368                     \textcolor{keywordflow}{if} (.not. res\%auto) error stop \textcolor{stringliteral}{'Error: Inconsistency in auto\_params setting between params.txt and res\_nml.txt.'}}
\DoxyCodeLine{369                     h2plus\_param\_c\_guess = res\%guess}
\DoxyCodeLine{370                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{371                     h2plus\_param\_c\_guess = h2plus\%c}
\DoxyCodeLine{372 \textcolor{keywordflow}{                endif}}
\DoxyCodeLine{373 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{374 }
\DoxyCodeLine{375             \textcolor{comment}{! Set up printed output for the loop.}}
\DoxyCodeLine{376             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{377                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Begin VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{378                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Bond Length    Converged?    Optimised c       Energy')"{}})}
\DoxyCodeLine{379                 \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{380                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Begin VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{381 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{382 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{383 }
\DoxyCodeLine{384             \textcolor{comment}{! Loop over bond lengths}}
\DoxyCodeLine{385             \textcolor{keywordflow}{do} b = bond\_start, int(h2plus\%bond(3))}
\DoxyCodeLine{386 }
\DoxyCodeLine{387                 \textcolor{comment}{! Store bond index for restart writing}}
\DoxyCodeLine{388                 i\_bond = b}
\DoxyCodeLine{389 }
\DoxyCodeLine{390                 \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{391                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('  -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Bond Length = ', F7.4, ' -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/  ')"{}}) \&}
\DoxyCodeLine{392                         bonds(b)}
\DoxyCodeLine{393 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{394 }
\DoxyCodeLine{395                 \textcolor{comment}{! Main VQMC callers}}
\DoxyCodeLine{396                 \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{397 }
\DoxyCodeLine{398                     \textcolor{keywordflow}{if} (h2plus\%auto\_params) \textcolor{keywordflow}{then}}
\DoxyCodeLine{399 }
\DoxyCodeLine{400                         \textcolor{comment}{! Search for best param at this bond length}}
\DoxyCodeLine{401                         \textcolor{keyword}{call }auto\_h\_2\_plus(h2plus\_param\_c\_guess, bonds(b), h2plus\_param\_c\_opt, \&}
\DoxyCodeLine{402                         energy, variance, accept\_rate, h2plus\_c\_converged)}
\DoxyCodeLine{403 }
\DoxyCodeLine{404                         \textcolor{comment}{! Reset start counter}}
\DoxyCodeLine{405                         auto\_start=1}
\DoxyCodeLine{406 }
\DoxyCodeLine{407                         \textcolor{comment}{! Use current optimised value of c as guess for next bond length's c,}}
\DoxyCodeLine{408                         \textcolor{comment}{! provided calculations converged this loop}}
\DoxyCodeLine{409                         \textcolor{keywordflow}{if} (h2plus\_c\_converged .eq. \textcolor{stringliteral}{'Y'}) h2plus\_param\_c\_guess = h2plus\_param\_c\_opt}
\DoxyCodeLine{410 }
\DoxyCodeLine{411                         \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{412                         \textcolor{keywordflow}{if} (write\_restart .and. my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{413                             \textcolor{keyword}{call }write\_h2plus\_main(h2plus\_param\_c\_array, bonds, energies, variances, \&}
\DoxyCodeLine{414                         resfile\_etot, ierr, h2plus, accept\_rates)}
\DoxyCodeLine{415                             \textcolor{keyword}{call }write\_res\_nml(b+1,1,h2plus\%auto\_params,h2plus\_param\_c\_guess)}
\DoxyCodeLine{416 \textcolor{keywordflow}{                        endif} }
\DoxyCodeLine{417 }
\DoxyCodeLine{418 }
\DoxyCodeLine{419                     \textcolor{keywordflow}{else}}
\DoxyCodeLine{420 }
\DoxyCodeLine{421                         \textcolor{comment}{! Find best param in grid at this bond length}}
\DoxyCodeLine{422                         \textcolor{keyword}{call }grid\_h\_2\_plus(p\_arr, bonds(b), h2plus\_param\_c\_opt, energy, \&}
\DoxyCodeLine{423                             variance, accept\_rate)}
\DoxyCodeLine{424 }
\DoxyCodeLine{425                         \textcolor{comment}{! Reset start counter}}
\DoxyCodeLine{426                         grid\_start=1}
\DoxyCodeLine{427 }
\DoxyCodeLine{428                         \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{429                         \textcolor{keywordflow}{if} (write\_restart .and. my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{430                             \textcolor{keyword}{call }write\_h2plus\_main(h2plus\_param\_c\_array, bonds, energies, variances, \&}
\DoxyCodeLine{431                         resfile\_etot, ierr, h2plus, accept\_rates)}
\DoxyCodeLine{432                             \textcolor{keyword}{call }write\_res\_nml(b+1,1,h2plus\%auto\_params)}
\DoxyCodeLine{433 \textcolor{keywordflow}{                        endif} }
\DoxyCodeLine{434 }
\DoxyCodeLine{435 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{436 }
\DoxyCodeLine{437                     \textcolor{comment}{! Append energy and parameters to arrays, on rank 0}}
\DoxyCodeLine{438                     \textcolor{keywordflow}{if}(my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{439                         h2plus\_param\_c\_array(b) = h2plus\_param\_c\_opt}
\DoxyCodeLine{440                         energies(b) = energy}
\DoxyCodeLine{441                         variances(b) = variance}
\DoxyCodeLine{442                         accept\_rates(b) = accept\_rate}
\DoxyCodeLine{443 \textcolor{keywordflow}{                    endif}}
\DoxyCodeLine{444 }
\DoxyCodeLine{445                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{446                     \textcolor{comment}{! Run equilibrations serially on rank 0}}
\DoxyCodeLine{447                     \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{448                         \textcolor{keyword}{call }equil\_h\_2\_plus(p\_arr, bonds(b), b)}
\DoxyCodeLine{449                         \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{450                         \textcolor{keywordflow}{if} (write\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{451                             \textcolor{keyword}{call }write\_res\_nml(b+1,1,h2plus\%auto\_params)}
\DoxyCodeLine{452 \textcolor{keywordflow}{                        endif}}
\DoxyCodeLine{453 }
\DoxyCodeLine{454 \textcolor{keywordflow}{                    endif}}
\DoxyCodeLine{455 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{456 }
\DoxyCodeLine{457 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{458 }
\DoxyCodeLine{459             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{460 }
\DoxyCodeLine{461                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ End VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{462                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{463 }
\DoxyCodeLine{464                 \textcolor{comment}{! If not in equilibration mode, write results}}
\DoxyCodeLine{465                 \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{466                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Calculations finished, writing results to NetCDF output file '}, \&}
\DoxyCodeLine{467                         outfile}
\DoxyCodeLine{468                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{469                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Calculations finished, writing results to NetCDF \&}}
\DoxyCodeLine{470 \textcolor{stringliteral}{}\textcolor{stringliteral}{                            \&output file '}, outfile}
\DoxyCodeLine{471 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{472 }
\DoxyCodeLine{473                     \textcolor{keyword}{call }write\_h2plus\_main(h2plus\_param\_c\_array, bonds, energies, variances, \&}
\DoxyCodeLine{474                         outfile, ierr, h2plus, accept\_rates)}
\DoxyCodeLine{475 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{476 }
\DoxyCodeLine{477 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{478 }
\DoxyCodeLine{479 }
\DoxyCodeLine{480     \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{481     \textcolor{comment}{!   SUBSECTION: Hydrogen Molecule}}
\DoxyCodeLine{482     \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{483 }
\DoxyCodeLine{484         \textcolor{keywordflow}{case}(\textcolor{stringliteral}{'H2'})}
\DoxyCodeLine{485 }
\DoxyCodeLine{486             \textcolor{comment}{! Initialise arrays}}
\DoxyCodeLine{487             \textcolor{keyword}{allocate}(energies(int(h2\%bond(3))))}
\DoxyCodeLine{488             \textcolor{keyword}{allocate}(variances(int(h2\%bond(3))))}
\DoxyCodeLine{489             \textcolor{keyword}{allocate}(accept\_rates(int(h2\%bond(3))))}
\DoxyCodeLine{490             \textcolor{keyword}{allocate}(h2\_param\_a\_array(int(h2\%bond(3))))}
\DoxyCodeLine{491             \textcolor{keyword}{allocate}(h2\_param\_beta\_array(int(h2\%bond(3))))}
\DoxyCodeLine{492 }
\DoxyCodeLine{493             \textcolor{comment}{! Print out system info.}}
\DoxyCodeLine{494             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{495                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Doing VQMC runs across ', I7, ' bond lengths.')"{}}) int(h2\%bond(3))}
\DoxyCodeLine{496                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Steps: ', I10, ', Burn Steps: ', I7, ', Thin Every ', I7, ' Steps.')"{}}) \&}
\DoxyCodeLine{497                         h2\%steps, h2\%burn\_step, h2\%thin\_step}
\DoxyCodeLine{498                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{499 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{500 }
\DoxyCodeLine{501             \textcolor{comment}{! Set up bond length array}}
\DoxyCodeLine{502             bonds = linspace(h2\%bond(1), h2\%bond(2), h2\%bond(3))}
\DoxyCodeLine{503             \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{504                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Array of bond lengths: ')"{}})}
\DoxyCodeLine{505                 \textcolor{keywordflow}{do} i = 1, int(h2\%bond(3))}
\DoxyCodeLine{506                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Bond length ', I4, ': ', F7.4)"{}}) i, bonds(i)}
\DoxyCodeLine{507 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{508                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{509 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{510 }
\DoxyCodeLine{511             \textcolor{comment}{! Set up parameter array, if doing a grid search}}
\DoxyCodeLine{512             \textcolor{keywordflow}{if} (h2\%auto\_params .eqv. .false.) \textcolor{keywordflow}{then}}
\DoxyCodeLine{513                 p\_arr = linspace(h2\%beta\_grid(1), h2\%beta\_grid(2), h2\%beta\_grid(3))}
\DoxyCodeLine{514 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{515 }
\DoxyCodeLine{516             \textcolor{comment}{! Update user from rank 0}}
\DoxyCodeLine{517             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{518                 \textcolor{keywordflow}{if} (h2\%auto\_params .eqv. .false.) \textcolor{keywordflow}{then}}
\DoxyCodeLine{519                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Grid search across linearly spaced parameters enabled.')"{}})}
\DoxyCodeLine{520                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{521                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{522                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Grid search across linearly spaced parameters enabled.')"{}})}
\DoxyCodeLine{523                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Array of beta values: ')"{}})}
\DoxyCodeLine{524                         \textcolor{keywordflow}{do} i = 1, int(h2\%beta\_grid(3))}
\DoxyCodeLine{525                             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(F12.8)"{}}) p\_arr(i)}
\DoxyCodeLine{526 \textcolor{keywordflow}{                        end do}}
\DoxyCodeLine{527                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{528 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{529                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{530                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Automatic search across parameters enabled.')"{}})}
\DoxyCodeLine{531                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{532                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{533                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Automatic search across parameters enabled.')"{}})}
\DoxyCodeLine{534                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{535 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{536 \textcolor{keywordflow}{                endif}}
\DoxyCodeLine{537 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{538 }
\DoxyCodeLine{539             \textcolor{comment}{! Sort out restarting}}
\DoxyCodeLine{540             \textcolor{keywordflow}{if} (run\_restart .and. (.not. run\_equil)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{541                 \textcolor{comment}{! Insert optimised parameters, energies, accept\_rates, and variances into arrays}}
\DoxyCodeLine{542                 \textcolor{keyword}{call }read\_energies\_h2(resfile\_etot, energies, variances, accept\_rates,h2\_param\_a\_array,h2\_param\_beta\_array)}
\DoxyCodeLine{543 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{544 }
\DoxyCodeLine{545             \textcolor{comment}{! Set starting guess value}}
\DoxyCodeLine{546             \textcolor{keywordflow}{if} ((.not. run\_equil) .and. h2\%auto\_params) \textcolor{keywordflow}{then}}
\DoxyCodeLine{547                 \textcolor{keywordflow}{if} (run\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{548                     \textcolor{keywordflow}{if} (.not. res\%auto) error stop \textcolor{stringliteral}{'Error: Inconsistency in auto\_params setting between params.txt and res\_nml.txt.'}}
\DoxyCodeLine{549                     h2\_param\_beta\_guess = res\%guess}
\DoxyCodeLine{550                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{551                     h2\_param\_beta\_guess = h2\%beta}
\DoxyCodeLine{552 \textcolor{keywordflow}{                endif}}
\DoxyCodeLine{553 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{554 }
\DoxyCodeLine{555             \textcolor{comment}{! Set up printed output for the loop.}}
\DoxyCodeLine{556             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{557                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Begin VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{558                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Bond Length    Converged?    Optimised Beta    Energy')"{}})}
\DoxyCodeLine{559                 \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{560                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Begin VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{561 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{562 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{563 }
\DoxyCodeLine{564             \textcolor{comment}{! Loop over bond lengths}}
\DoxyCodeLine{565             \textcolor{keywordflow}{do} b = bond\_start, int(h2\%bond(3))}
\DoxyCodeLine{566 }
\DoxyCodeLine{567                 \textcolor{comment}{! Store bond index for restart writing}}
\DoxyCodeLine{568                 i\_bond = b}
\DoxyCodeLine{569 }
\DoxyCodeLine{570                 \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{571                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('  -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Bond Length = ', F7.4, ' -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/  ')"{}}) \&}
\DoxyCodeLine{572                         bonds(b)}
\DoxyCodeLine{573 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{574 }
\DoxyCodeLine{575                 \textcolor{comment}{! Calculate parameter a at this bond length by Newton-\/Raphson iteration.}}
\DoxyCodeLine{576                 h2\_param\_a = h\_2\_cusp(bonds(b))}
\DoxyCodeLine{577 }
\DoxyCodeLine{578                 \textcolor{comment}{! Main VQMC callers}}
\DoxyCodeLine{579                 \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{580 }
\DoxyCodeLine{581                     \textcolor{comment}{! Either iterate through beta values, or automatically search for best beta.}}
\DoxyCodeLine{582                     \textcolor{keywordflow}{if} (h2\%auto\_params) \textcolor{keywordflow}{then} \textcolor{comment}{! ie. if auto searching}}
\DoxyCodeLine{583 }
\DoxyCodeLine{584                         \textcolor{comment}{! Solve value of beta at this bond length.}}
\DoxyCodeLine{585                         \textcolor{keyword}{call }auto\_h\_2(h2\_param\_a, h2\_param\_beta\_guess, bonds(b), h2\_param\_beta\_opt, \&}
\DoxyCodeLine{586                             energy, variance, accept\_rate, h2\_beta\_converged)}
\DoxyCodeLine{587 }
\DoxyCodeLine{588                         \textcolor{comment}{! Use current optimised value of beta as guess for next bond length's beta,}}
\DoxyCodeLine{589                         \textcolor{comment}{! provided calculations converged this loop}}
\DoxyCodeLine{590                         \textcolor{keywordflow}{if} (h2\_beta\_converged .eq. \textcolor{stringliteral}{'Y'}) h2\_param\_beta\_guess = h2\_param\_beta\_opt}
\DoxyCodeLine{591 }
\DoxyCodeLine{592                         \textcolor{comment}{! Reset start counter}}
\DoxyCodeLine{593                         auto\_start=1}
\DoxyCodeLine{594 }
\DoxyCodeLine{595                         \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{596                         \textcolor{keywordflow}{if} (write\_restart .and. my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{597                             \textcolor{keyword}{call }write\_h2\_main(h2\_param\_a\_array, h2\_param\_beta\_array, bonds, \&}
\DoxyCodeLine{598                         energies, variances, resfile\_etot, ierr, h2, accept\_rates)}
\DoxyCodeLine{599                             \textcolor{keyword}{call }write\_res\_nml(b+1,1,h2\%auto\_params,h2\_param\_beta\_guess)}
\DoxyCodeLine{600 \textcolor{keywordflow}{                        endif} }
\DoxyCodeLine{601                     }
\DoxyCodeLine{602                     \textcolor{keywordflow}{else} \textcolor{comment}{! ie. if doing a grid search}}
\DoxyCodeLine{603 }
\DoxyCodeLine{604                         \textcolor{comment}{! Get best value of beta at this bond length}}
\DoxyCodeLine{605                         \textcolor{keyword}{call }grid\_h\_2(h2\_param\_a, p\_arr, bonds(b), h2\_param\_beta\_opt, energy, \&}
\DoxyCodeLine{606                         variance, accept\_rate)}
\DoxyCodeLine{607 }
\DoxyCodeLine{608                         \textcolor{comment}{! Reset start counter}}
\DoxyCodeLine{609                         grid\_start=1}
\DoxyCodeLine{610 }
\DoxyCodeLine{611                         \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{612                         \textcolor{keywordflow}{if} (write\_restart .and. my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{613                             \textcolor{keyword}{call }write\_h2\_main(h2\_param\_a\_array, h2\_param\_beta\_array, bonds, \&}
\DoxyCodeLine{614                         energies, variances, resfile\_etot, ierr, h2, accept\_rates)}
\DoxyCodeLine{615                             \textcolor{keyword}{call }write\_res\_nml(b+1,1,h2\%auto\_params)}
\DoxyCodeLine{616 \textcolor{keywordflow}{                        endif} }
\DoxyCodeLine{617 }
\DoxyCodeLine{618 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{619 }
\DoxyCodeLine{620                     \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{621                         \textcolor{comment}{! Append energy and parameters to arrays}}
\DoxyCodeLine{622                         h2\_param\_a\_array(b) = h2\_param\_a}
\DoxyCodeLine{623                         h2\_param\_beta\_array(b) = h2\_param\_beta\_opt}
\DoxyCodeLine{624                         energies(b) = energy}
\DoxyCodeLine{625                         variances(b) = variance}
\DoxyCodeLine{626                         accept\_rates(b) = accept\_rate}
\DoxyCodeLine{627 \textcolor{keywordflow}{                    endif}}
\DoxyCodeLine{628 }
\DoxyCodeLine{629                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{630 }
\DoxyCodeLine{631                     \textcolor{comment}{! Run equilibrations}}
\DoxyCodeLine{632                     \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{633                         \textcolor{keyword}{call }equil\_h\_2(h2\_param\_a, p\_arr, bonds(b), b)}
\DoxyCodeLine{634                         \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{635                         \textcolor{keywordflow}{if} (write\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{636                             \textcolor{keyword}{call }write\_res\_nml(b+1,1,h2\%auto\_params)}
\DoxyCodeLine{637 \textcolor{keywordflow}{                        endif}}
\DoxyCodeLine{638 \textcolor{keywordflow}{                    endif}}
\DoxyCodeLine{639 }
\DoxyCodeLine{640 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{641 }
\DoxyCodeLine{642 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{643 }
\DoxyCodeLine{644             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{645 }
\DoxyCodeLine{646                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ End VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{647                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{648 }
\DoxyCodeLine{649                 \textcolor{comment}{! If not in equilibration mode, write results}}
\DoxyCodeLine{650                 \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{651 }
\DoxyCodeLine{652                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Calculations finished, writing results to NetCDF output file '}, \&}
\DoxyCodeLine{653                         outfile}
\DoxyCodeLine{654 }
\DoxyCodeLine{655                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{656                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Calculations finished, writing results to NetCDF \&}}
\DoxyCodeLine{657 \textcolor{stringliteral}{}\textcolor{stringliteral}{                            \&output file '}, outfile}
\DoxyCodeLine{658 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{659 }
\DoxyCodeLine{660                     \textcolor{keyword}{call }write\_h2\_main(h2\_param\_a\_array, h2\_param\_beta\_array, bonds, \&}
\DoxyCodeLine{661                         energies, variances, outfile, ierr, h2, accept\_rates)}
\DoxyCodeLine{662 }
\DoxyCodeLine{663 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{664 }
\DoxyCodeLine{665 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{666 }
\DoxyCodeLine{667         \textcolor{comment}{! Default case, for if none of the cases match. Should be invalidated by checks in input\_parser.}}
\DoxyCodeLine{668 \textcolor{keywordflow}{        case default}}
\DoxyCodeLine{669             error stop \textcolor{stringliteral}{'Unknown case. How did you get here?'}}
\DoxyCodeLine{670 \textcolor{keywordflow}{    end select}}
\DoxyCodeLine{671 }
\DoxyCodeLine{672     \textcolor{comment}{! Close logfile from rank 0}}
\DoxyCodeLine{673     \textcolor{keywordflow}{if} (i\_log) \textcolor{keyword}{close}(logid)}
\DoxyCodeLine{674 }
\DoxyCodeLine{675     \textcolor{comment}{! Remove restart files if complete}}
\DoxyCodeLine{676     \textcolor{keyword}{call }system(\textcolor{stringliteral}{'rm res\_etot.nc 2>/dev/null'})}
\DoxyCodeLine{677     \textcolor{keyword}{call }system(\textcolor{stringliteral}{'rm res\_nml.txt 2>/dev/null'})}
\DoxyCodeLine{678     \textcolor{keyword}{call }system(\textcolor{stringliteral}{'rm res\_epar.nc 2>/dev/null'})}
\DoxyCodeLine{679 }
\DoxyCodeLine{680     \textcolor{comment}{! End MPI parallelism}}
\DoxyCodeLine{681     \textcolor{keyword}{call }mpi\_finalize(mpierr)}
\DoxyCodeLine{682 }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=550pt]{driver_8f90_aae94725eafaedc467ab9bfefcae9769e_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=195pt]{driver_8f90_aae94725eafaedc467ab9bfefcae9769e_icgraph}
\end{center}
\end{figure}
