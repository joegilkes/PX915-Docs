\hypertarget{driver_8f90}{}\doxysection{repo/src/driver.f90 File Reference}
\label{driver_8f90}\index{repo/src/driver.f90@{repo/src/driver.f90}}
\doxysubsection*{Functions/\+Subroutines}
\begin{DoxyCompactItemize}
\item 
program \mbox{\hyperlink{driver_8f90_a8ec2266d83cd6c0b762cbcbc92c0af3d}{main}}
\begin{DoxyCompactList}\small\item\em Main program, contains the driver subroutine that runs all other code. \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{driver_8f90_aae94725eafaedc467ab9bfefcae9769e}{driver}} ()
\begin{DoxyCompactList}\small\item\em Subroutine for running the main code (needed for Doxygen compatability). \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Function/\+Subroutine Documentation}
\mbox{\Hypertarget{driver_8f90_a8ec2266d83cd6c0b762cbcbc92c0af3d}\label{driver_8f90_a8ec2266d83cd6c0b762cbcbc92c0af3d}} 
\index{driver.f90@{driver.f90}!main@{main}}
\index{main@{main}!driver.f90@{driver.f90}}
\doxysubsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily program main}



Main program, contains the driver subroutine that runs all other code. 

Packaged as a separate subroutine within this program so that it remains compatible with Doxygen, which otherwise ignores any further documentation. 

Definition at line 14 of file driver.\+f90.

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=550pt]{driver_8f90_a8ec2266d83cd6c0b762cbcbc92c0af3d_cgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{driver_8f90_aae94725eafaedc467ab9bfefcae9769e}\label{driver_8f90_aae94725eafaedc467ab9bfefcae9769e}} 
\index{driver.f90@{driver.f90}!driver@{driver}}
\index{driver@{driver}!driver.f90@{driver.f90}}
\doxysubsubsection{\texorpdfstring{driver()}{driver()}}
{\footnotesize\ttfamily subroutine main\+::driver}



Subroutine for running the main code (needed for Doxygen compatability). 

The main driver code for the VQMC program. Links all other modules to run VQMC calculations on the Quantum Harmonic Oscillator (QHO), the Hydrogen Molecular Ion (H2plus) and the Hydrogen Molecule (H2).

Reads inputs from a provided input file, either generated by a Python frontend script or handwritten in the Fortran Namelist I/O format. Determines the problem to be solved, then runs VQMC routines. These can be run over a set parameter space, or in the case of the H2plus and H2 problems, can automatically determine the best variational parameter for the current bond length. Outputs results in Net\+CDF format, to be read by a Python frontend visualisation notebook for analysis.

Also includes extensions to start separate equilibration runs for determining optimal burning/thinning parameters for the Markov chain, and to write the energy traces for each parameter / parameter combination. Also capable of logging the full Markov chain to file (slow, should only be used for debug). 

Definition at line 53 of file driver.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{54 }
\DoxyCodeLine{55 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{56 \textcolor{comment}{! SECTION: Variable Declarations}}
\DoxyCodeLine{57 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{58 }
\DoxyCodeLine{59 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: p\_arr}
\DoxyCodeLine{60 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: bonds}
\DoxyCodeLine{61 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: H2plus\_param\_c\_array}
\DoxyCodeLine{62 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: H2\_param\_a\_array}
\DoxyCodeLine{63 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: H2\_param\_beta\_array}
\DoxyCodeLine{64 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energies}
\DoxyCodeLine{65 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: variances}
\DoxyCodeLine{66 \textcolor{keywordtype}{    real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: accept\_rates}
\DoxyCodeLine{68 \textcolor{keywordtype}{    real}(real64) :: H2plus\_param\_c\_guess}
\DoxyCodeLine{69 \textcolor{keywordtype}{    real}(real64) :: H2plus\_param\_c\_opt}
\DoxyCodeLine{70 \textcolor{keywordtype}{    real}(real64) :: H2\_param\_beta\_guess}
\DoxyCodeLine{71 \textcolor{keywordtype}{    real}(real64) :: H2\_param\_beta\_opt}
\DoxyCodeLine{72 \textcolor{keywordtype}{    real}(real64) :: H2\_param\_a}
\DoxyCodeLine{73 \textcolor{keywordtype}{    real}(real64) :: energy}
\DoxyCodeLine{74 \textcolor{keywordtype}{    real}(real64) :: variance}
\DoxyCodeLine{75 \textcolor{keywordtype}{    real}(real64) :: accept\_rate}
\DoxyCodeLine{76     }
\DoxyCodeLine{77     \textcolor{keywordtype}{integer} :: b, i}
\DoxyCodeLine{78     \textcolor{keywordtype}{integer} :: logiostat}
\DoxyCodeLine{79     \textcolor{keywordtype}{integer} :: ierr}
\DoxyCodeLine{80     \textcolor{keywordtype}{character(len=1)} :: H2plus\_c\_converged}
\DoxyCodeLine{81     \textcolor{keywordtype}{character(len=1)} :: H2\_beta\_converged}
\DoxyCodeLine{82 }
\DoxyCodeLine{83 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{84 \textcolor{comment}{! SECTION: Initial Setup}}
\DoxyCodeLine{85 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{86     \textcolor{comment}{! Initialise MPI}}
\DoxyCodeLine{87     \textcolor{comment}{! Initialize MPI}}
\DoxyCodeLine{88     \textcolor{keyword}{call }mpi\_init(mpierr)}
\DoxyCodeLine{89 }
\DoxyCodeLine{90     \textcolor{comment}{! Find number of processors and current rank}}
\DoxyCodeLine{91     \textcolor{keyword}{call }mpi\_comm\_size(mpi\_comm\_world,p,mpierr)}
\DoxyCodeLine{92     \textcolor{keyword}{call }mpi\_comm\_rank(mpi\_comm\_world,my\_rank,mpierr)  }
\DoxyCodeLine{93 }
\DoxyCodeLine{94     \textcolor{comment}{! Read the input parameters.}}
\DoxyCodeLine{95     \textcolor{keyword}{call }read\_inputs()}
\DoxyCodeLine{96     }
\DoxyCodeLine{97     \textcolor{comment}{! File management from rank 0}}
\DoxyCodeLine{98     \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{99 }
\DoxyCodeLine{100         \textcolor{comment}{! Notify user of the system }}
\DoxyCodeLine{101         \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('System: ', A)"{}}) p\_system}
\DoxyCodeLine{102         \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}}) }
\DoxyCodeLine{103 }
\DoxyCodeLine{104         \textcolor{comment}{! Make sure the equilibration output directory exists if needed.}}
\DoxyCodeLine{105         \textcolor{comment}{! There is no simple way to check directory existence that works}}
\DoxyCodeLine{106         \textcolor{comment}{! with both ifort and gfortran, so mkdir is just run with stderr}}
\DoxyCodeLine{107         \textcolor{comment}{! suppressed instead.}}
\DoxyCodeLine{108         \textcolor{keywordflow}{if} (run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{109             \textcolor{keyword}{call }system(\textcolor{stringliteral}{'mkdir ./equil\_out 2>/dev/null'})}
\DoxyCodeLine{110             \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Dice QMC started in Equilibration Mode')"{}})}
\DoxyCodeLine{111             \textcolor{comment}{! Check step length}}
\DoxyCodeLine{112             \textcolor{keywordflow}{if}(run\_steps>max\_chain\_len) \textcolor{keywordflow}{then} }
\DoxyCodeLine{113                 \textcolor{keyword}{write}(*,\textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{114                 \textcolor{keyword}{write}(*,*) \textcolor{stringliteral}{'WARNING: The program will be slow at writing equilibration files, \&}}
\DoxyCodeLine{115 \textcolor{stringliteral}{}\textcolor{stringliteral}{                           \&as the requested number of steps exceeds the recommended \&}}
\DoxyCodeLine{116 \textcolor{stringliteral}{}\textcolor{stringliteral}{                           \&upper limit of '}, max\_chain\_len, \textcolor{stringliteral}{' steps. Refer to the user manual for details.'}}
\DoxyCodeLine{117                 \textcolor{keyword}{write}(*,\textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{118 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{119 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{120 }
\DoxyCodeLine{121         \textcolor{comment}{! Same directory check as above for write\_chains.}}
\DoxyCodeLine{122         \textcolor{keywordflow}{if} (write\_chains) \textcolor{keywordflow}{then}}
\DoxyCodeLine{123             \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{124                 \textcolor{keyword}{call }system(\textcolor{stringliteral}{'mkdir ./chains\_out 2>/dev/null'})}
\DoxyCodeLine{125                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Dice QMC started in full VQMC mode with additional Markov chain outputting')"{}}) }
\DoxyCodeLine{126                 \textcolor{comment}{! Check step length}}
\DoxyCodeLine{127                 \textcolor{keywordflow}{if}(run\_steps>max\_chain\_len) \textcolor{keywordflow}{then} }
\DoxyCodeLine{128                     \textcolor{keyword}{write}(*,*) \textcolor{stringliteral}{'NOTE: For efficiency, only the first '}, max\_chain\_len,\textcolor{stringliteral}{' entries of the Markov chain \&}}
\DoxyCodeLine{129 \textcolor{stringliteral}{}\textcolor{stringliteral}{                               \&(after burning and thinning) will be written out to the chains\_out folder.'}}
\DoxyCodeLine{130 \textcolor{keywordflow}{                endif}}
\DoxyCodeLine{131             \textcolor{keywordflow}{else}}
\DoxyCodeLine{132                 error stop \textcolor{stringliteral}{"{}Dice QMC cannot be started with both run\_equil and write\_chains set \&}}
\DoxyCodeLine{133 \textcolor{stringliteral}{}\textcolor{stringliteral}{                \&to TRUE. Check your input params.txt and try again."{}}}
\DoxyCodeLine{134 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{135 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{136 }
\DoxyCodeLine{137         \textcolor{comment}{! Initialise the log file if required.}}
\DoxyCodeLine{138         \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{139 }
\DoxyCodeLine{140             \textcolor{comment}{! Open the logfile}}
\DoxyCodeLine{141             \textcolor{keyword}{open}(logid, file=logfile, status=\textcolor{stringliteral}{'unknown'}, access=\textcolor{stringliteral}{'sequential'}, \&}
\DoxyCodeLine{142                 form=\textcolor{stringliteral}{'formatted'}, iostat=logiostat)}
\DoxyCodeLine{143             \textcolor{keywordflow}{if} (logiostat .ne. 0) \textcolor{keyword}{write}(0, *) \textcolor{stringliteral}{'Error opening log file '}, logfile}
\DoxyCodeLine{144 }
\DoxyCodeLine{145             \textcolor{comment}{! Write program details to logfile}}
\DoxyCodeLine{146             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('*** Dice QMC log file ***')"{}}) \textcolor{comment}{! include date/time?}}
\DoxyCodeLine{147             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{148             \textcolor{keyword}{write}(logid, *) \textcolor{stringliteral}{'System: '}, p\_system}
\DoxyCodeLine{149             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{150 }
\DoxyCodeLine{151             \textcolor{comment}{! Update log-\/writer tag for rank 0}}
\DoxyCodeLine{152             i\_log = .true.}
\DoxyCodeLine{153             }
\DoxyCodeLine{154 \textcolor{keywordflow}{        endif} }
\DoxyCodeLine{155     }
\DoxyCodeLine{156 \textcolor{keywordflow}{    endif}}
\DoxyCodeLine{157 }
\DoxyCodeLine{158     \textcolor{comment}{! If p\_system='test', run test module.}}
\DoxyCodeLine{159     \textcolor{keywordflow}{if} (trim(p\_system)==\textcolor{stringliteral}{'test'}) \textcolor{keywordflow}{then}}
\DoxyCodeLine{160         \textcolor{comment}{! Tests need to run on a single processor}}
\DoxyCodeLine{161         \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{162             \textcolor{keyword}{call }unit\_tests()}
\DoxyCodeLine{163 \textcolor{keywordflow}{        endif}}
\DoxyCodeLine{164         \textcolor{comment}{! Exit the program}}
\DoxyCodeLine{165         \textcolor{keyword}{call }mpi\_finalize(mpierr)}
\DoxyCodeLine{166         \textcolor{keyword}{call }exit()}
\DoxyCodeLine{167 \textcolor{keywordflow}{    endif}}
\DoxyCodeLine{168 }
\DoxyCodeLine{169     \textcolor{comment}{! If not a test job, setup MPI worksharing.}}
\DoxyCodeLine{170     \textcolor{comment}{! Equilibrations will be run serially on rank 0.}}
\DoxyCodeLine{171     \textcolor{comment}{! For non-\/equilibration runs:}}
\DoxyCodeLine{172     \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{173 }
\DoxyCodeLine{174         \textcolor{comment}{! Split workload for VQMC runs}}
\DoxyCodeLine{175         my\_steps = run\_steps / p \textcolor{comment}{! Integer division}}
\DoxyCodeLine{176         \textcolor{keywordflow}{if} (my\_rank < (run\_steps-\/(my\_steps*p))) \textcolor{keywordflow}{then}}
\DoxyCodeLine{177             my\_steps = my\_steps+1}
\DoxyCodeLine{178 \textcolor{keywordflow}{        endif} }
\DoxyCodeLine{179 }
\DoxyCodeLine{180         \textcolor{comment}{! Pre-\/calculate frequently used factors.}}
\DoxyCodeLine{181         my\_size = my\_steps/tstep \textcolor{comment}{! Integer division}}
\DoxyCodeLine{182         \textcolor{keyword}{call }mpi\_reduce(my\_size,tot\_size,1,mpi\_integer,mpi\_sum,0,mpi\_comm\_world,mpierr)}
\DoxyCodeLine{183         \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{184             \textcolor{comment}{! Factor representing division by total chain size after burning \& thinning}}
\DoxyCodeLine{185             per\_step = 1.0\_real64 / real(tot\_size,kind=real64)}
\DoxyCodeLine{186             \textcolor{comment}{! Factor representing division by number of processors}}
\DoxyCodeLine{187             per\_proc = 1.0\_real64 / real(p,kind=real64)}
\DoxyCodeLine{188             \textcolor{comment}{! Factor representing division by square of number of processors}}
\DoxyCodeLine{189             per\_proc2 = per\_proc**2}
\DoxyCodeLine{190 \textcolor{keywordflow}{        endif}}
\DoxyCodeLine{191         \textcolor{comment}{! The factor 'per\_proc' is required on all ranks for auto\_grad calculations.}}
\DoxyCodeLine{192         \textcolor{comment}{! To ensure floating point agreement, broadcaste it from rank 0, rather than re-\/calculating on every rank.}}
\DoxyCodeLine{193         \textcolor{keyword}{call }mpi\_bcast(per\_proc,1,mpi\_double\_precision,0,mpi\_comm\_world,mpierr)}
\DoxyCodeLine{194     }
\DoxyCodeLine{195 \textcolor{keywordflow}{    endif}}
\DoxyCodeLine{196 }
\DoxyCodeLine{197     \textcolor{comment}{! Initialise the random number generator}}
\DoxyCodeLine{198     \textcolor{keywordflow}{if} (run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{199         \textcolor{comment}{! Only rank 0 runs equilibrations}}
\DoxyCodeLine{200         \textcolor{keywordflow}{if}(my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{201             \textcolor{comment}{! Initialise the seed on rank 0}}
\DoxyCodeLine{202             \textcolor{keyword}{call }init\_ran1() }
\DoxyCodeLine{203             \textcolor{comment}{! Update logfile if required}}
\DoxyCodeLine{204             \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{205                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Initial seed from /dev/urandom: ', I20)"{}}) seed}
\DoxyCodeLine{206                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{207 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{208             \textcolor{comment}{! Ensure auto\_params is disabled}}
\DoxyCodeLine{209             \textcolor{keywordflow}{if} (trim(p\_system) .eq. \textcolor{stringliteral}{'H2plus'} .and. h2plus\%auto\_params) \textcolor{keywordflow}{then}}
\DoxyCodeLine{210                 h2plus\%auto\_params = .false.}
\DoxyCodeLine{211                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('WARNING: H2plus\%auto\_params should not be .TRUE. when in Equilibration Mode, disabling...')"{}})}
\DoxyCodeLine{212             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (trim(p\_system) .eq. \textcolor{stringliteral}{'H2'} .and. h2\%auto\_params) \textcolor{keywordflow}{then}}
\DoxyCodeLine{213                 h2\%auto\_params = .false.}
\DoxyCodeLine{214                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('WARNING: H2plus\%auto\_params should not be .TRUE. when in Equilibration Mode, disabling...')"{}})}
\DoxyCodeLine{215 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{216 \textcolor{keywordflow}{        endif}}
\DoxyCodeLine{217     \textcolor{keywordflow}{else}}
\DoxyCodeLine{218         \textcolor{comment}{! For non-\/equil VQMC runs,}}
\DoxyCodeLine{219         \textcolor{comment}{! Initialise a seed on each MPI rank}}
\DoxyCodeLine{220         \textcolor{keyword}{call }init\_ran1() }
\DoxyCodeLine{221         \textcolor{comment}{! Update logfile if required}}
\DoxyCodeLine{222         \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{223             \textcolor{keywordflow}{if} (my\_rank>0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{224                 \textcolor{comment}{! Send the seeds to rank 0}}
\DoxyCodeLine{225                 \textcolor{keyword}{call }mpi\_send(seed,1,mpi\_integer,0,tag\_seed,mpi\_comm\_world,mpierr)}
\DoxyCodeLine{226             \textcolor{keywordflow}{else}}
\DoxyCodeLine{227                 \textcolor{comment}{! Write seed of rank=0 to logfile}}
\DoxyCodeLine{228                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Rank ',I2,'. Initial seed from /dev/urandom: ', I20)"{}}) my\_rank, seed}
\DoxyCodeLine{229                 \textcolor{keywordflow}{do} ip = 1, p-\/1}
\DoxyCodeLine{230                     \textcolor{comment}{! Receive seed value from rank=ip}}
\DoxyCodeLine{231                     \textcolor{keyword}{call }mpi\_recv(ip\_seed,1,mpi\_integer,ip,tag\_seed,mpi\_comm\_world,status,mpierr) }
\DoxyCodeLine{232                     \textcolor{comment}{! Write seed of rank=ip to logfile}}
\DoxyCodeLine{233                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Rank ',I2,'. Initial seed from /dev/urandom: ', I20)"{}}) ip, ip\_seed}
\DoxyCodeLine{234 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{235                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{236 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{237 \textcolor{keywordflow}{        endif} }
\DoxyCodeLine{238 }
\DoxyCodeLine{239 \textcolor{keywordflow}{    endif} }
\DoxyCodeLine{240 }
\DoxyCodeLine{241 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{242 \textcolor{comment}{! SECTION: VQMC Loops}}
\DoxyCodeLine{243 \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{244 }
\DoxyCodeLine{245     \textcolor{comment}{! Execute problem-\/dependent routines.}}
\DoxyCodeLine{246     \textcolor{keywordflow}{select case}(trim(p\_system))}
\DoxyCodeLine{247 }
\DoxyCodeLine{248     \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{249     \textcolor{comment}{!   SUBSECTION: Quantum Harmonic Oscillator}}
\DoxyCodeLine{250     \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{251 }
\DoxyCodeLine{252         \textcolor{keywordflow}{case}(\textcolor{stringliteral}{'QHO'})}
\DoxyCodeLine{253 }
\DoxyCodeLine{254             \textcolor{comment}{! Initialise arrays}}
\DoxyCodeLine{255             \textcolor{keyword}{allocate}(energies(int(qho\%alpha(3)))); energies(:) = 0.0\_real64}
\DoxyCodeLine{256             \textcolor{keyword}{allocate}(variances(int(qho\%alpha(3)))); variances(:) = 0.0\_real64}
\DoxyCodeLine{257             \textcolor{keyword}{allocate}(accept\_rates(int(qho\%alpha(3)))); accept\_rates(:) = 0.0\_real64}
\DoxyCodeLine{258 }
\DoxyCodeLine{259             \textcolor{comment}{! Print out system info.}}
\DoxyCodeLine{260             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{261                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Doing VQMC runs across ', I3, ' parameter(s).')"{}}) int(qho\%alpha(3))}
\DoxyCodeLine{262                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Steps: ', I10, ', Burn Steps: ', I7, ', Thin Every ', I7, ' Steps.')"{}}) \&}
\DoxyCodeLine{263                     qho\%steps, qho\%burn\_step, qho\%thin\_step}
\DoxyCodeLine{264                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{265 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{266 }
\DoxyCodeLine{267             \textcolor{comment}{! Set up alpha array.}}
\DoxyCodeLine{268             p\_arr = linspace(qho\%alpha(1), qho\%alpha(2), qho\%alpha(3))}
\DoxyCodeLine{269 }
\DoxyCodeLine{270             \textcolor{keywordflow}{if}(my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{271                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Grid search across linearly spaced parameters enabled.')"{}})}
\DoxyCodeLine{272                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{273                 \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{274                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Grid search across linearly spaced parameters enabled.')"{}})}
\DoxyCodeLine{275                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Array of alpha values: ')"{}})}
\DoxyCodeLine{276                     \textcolor{keywordflow}{do} i = 1, int(qho\%alpha(3))}
\DoxyCodeLine{277                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(F12.8)"{}}) p\_arr(i)}
\DoxyCodeLine{278 \textcolor{keywordflow}{                    end do}}
\DoxyCodeLine{279                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{280 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{281 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{282 }
\DoxyCodeLine{283             \textcolor{comment}{! Sort out restarting}}
\DoxyCodeLine{284             \textcolor{keywordflow}{if} (run\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{285                 \textcolor{comment}{! Insert optimised parameters, energies, accept\_rates, and variances into arrays}}
\DoxyCodeLine{286 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{287 }
\DoxyCodeLine{288             \textcolor{comment}{! Main VQMC callers.}}
\DoxyCodeLine{289             \textcolor{keywordflow}{if} (run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{290                 \textcolor{comment}{!if (my\_rank==0) then}}
\DoxyCodeLine{291                 \textcolor{keyword}{call }equil\_qho(p\_arr, energies)}
\DoxyCodeLine{292                 \textcolor{comment}{!endif }}
\DoxyCodeLine{293             \textcolor{keywordflow}{else}}
\DoxyCodeLine{294                 \textcolor{keyword}{call }grid\_qho(p\_arr, energies, accept\_rates, variances)}
\DoxyCodeLine{295 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{296 }
\DoxyCodeLine{297     \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{298     \textcolor{comment}{!   SUBSECTION: Hydrogen Molecular Ion}}
\DoxyCodeLine{299     \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{300 }
\DoxyCodeLine{301         \textcolor{keywordflow}{case}(\textcolor{stringliteral}{'H2plus'})}
\DoxyCodeLine{302 }
\DoxyCodeLine{303             \textcolor{comment}{! Initialise}}
\DoxyCodeLine{304             \textcolor{keyword}{allocate}(energies(int(h2plus\%bond(3))))}
\DoxyCodeLine{305             \textcolor{keyword}{allocate}(variances(int(h2plus\%bond(3))))}
\DoxyCodeLine{306             \textcolor{keyword}{allocate}(h2plus\_param\_c\_array(int(h2plus\%bond(3))))}
\DoxyCodeLine{307             \textcolor{keyword}{allocate}(accept\_rates(int(h2plus\%bond(3))))}
\DoxyCodeLine{308             h2plus\_param\_c\_guess = h2plus\%c}
\DoxyCodeLine{309 }
\DoxyCodeLine{310             \textcolor{comment}{! Print out system info.}}
\DoxyCodeLine{311             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{312                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Doing VQMC runs across ', I7, ' bond lengths.')"{}}) int(h2plus\%bond(3))}
\DoxyCodeLine{313                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Steps: ', I10, ', Burn Steps: ', I7, ', Thin Every ', \&}}
\DoxyCodeLine{314 \textcolor{stringliteral}{}\textcolor{stringliteral}{                    \& I7, ' Steps.')"{}}) h2plus\%steps, h2plus\%burn\_step, h2plus\%thin\_step}
\DoxyCodeLine{315                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{316 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{317 }
\DoxyCodeLine{318             \textcolor{comment}{! Set up bond length array}}
\DoxyCodeLine{319             bonds = linspace(h2plus\%bond(1), h2plus\%bond(2), h2plus\%bond(3))}
\DoxyCodeLine{320             \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{321                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Array of bond lengths: ')"{}})}
\DoxyCodeLine{322                 \textcolor{keywordflow}{do} i = 1, int(h2plus\%bond(3))}
\DoxyCodeLine{323                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Bond length ', I4, ': ', F7.4)"{}}) i, bonds(i)}
\DoxyCodeLine{324 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{325                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{326 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{327 }
\DoxyCodeLine{328             \textcolor{comment}{! Set up parameter array, if doing a grid search}}
\DoxyCodeLine{329             \textcolor{keywordflow}{if} (h2plus\%auto\_params .eqv. .false.) \textcolor{keywordflow}{then}}
\DoxyCodeLine{330                 p\_arr = linspace(h2plus\%c\_grid(1), h2plus\%c\_grid(2), h2plus\%c\_grid(3))}
\DoxyCodeLine{331 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{332 }
\DoxyCodeLine{333             \textcolor{comment}{! Update user from rank 0}}
\DoxyCodeLine{334             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{335                 \textcolor{keywordflow}{if} (h2plus\%auto\_params .eqv. .false.) \textcolor{keywordflow}{then}}
\DoxyCodeLine{336                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Grid search across linearly spaced parameters enabled.')"{}})}
\DoxyCodeLine{337                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{338                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{339                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Grid search across linearly spaced parameters enabled.')"{}})}
\DoxyCodeLine{340                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Array of c values: ')"{}})}
\DoxyCodeLine{341                         \textcolor{keywordflow}{do} i = 1, int(h2plus\%c\_grid(3))}
\DoxyCodeLine{342                             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(F12.8)"{}}) p\_arr(i)}
\DoxyCodeLine{343 \textcolor{keywordflow}{                        end do}}
\DoxyCodeLine{344                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{345 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{346                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{347                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Automatic search across parameters enabled.')"{}})}
\DoxyCodeLine{348                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{349                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{350                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Automatic search across parameters enabled.')"{}})}
\DoxyCodeLine{351                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{352 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{353 \textcolor{keywordflow}{                endif}}
\DoxyCodeLine{354 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{355 }
\DoxyCodeLine{356             \textcolor{comment}{! Sort out restarting}}
\DoxyCodeLine{357             \textcolor{keywordflow}{if} (run\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{358                 \textcolor{comment}{! Insert optimised parameters, energies, accept\_rates, and variances into arrays}}
\DoxyCodeLine{359 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{360 }
\DoxyCodeLine{361             \textcolor{comment}{! Set up printed output for the loop.}}
\DoxyCodeLine{362             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{363                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Begin VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{364                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Bond Length    Converged?    Optimised c       Energy')"{}})}
\DoxyCodeLine{365                 \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{366                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Begin VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{367 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{368 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{369 }
\DoxyCodeLine{370             \textcolor{comment}{! Loop over bond lengths}}
\DoxyCodeLine{371             \textcolor{keywordflow}{do} b = 1, int(h2plus\%bond(3))}
\DoxyCodeLine{372 }
\DoxyCodeLine{373                 \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{374                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('  -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Bond Length = ', F7.4, ' -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/  ')"{}}) \&}
\DoxyCodeLine{375                         bonds(b)}
\DoxyCodeLine{376 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{377 }
\DoxyCodeLine{378                 \textcolor{comment}{! Main VQMC callers}}
\DoxyCodeLine{379                 \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{380                     \textcolor{keywordflow}{if} (h2plus\%auto\_params) \textcolor{keywordflow}{then}}
\DoxyCodeLine{381 }
\DoxyCodeLine{382                         \textcolor{comment}{! Search for best param at this bond length}}
\DoxyCodeLine{383                         \textcolor{keyword}{call }auto\_h\_2\_plus(h2plus\_param\_c\_guess, bonds(b), h2plus\_param\_c\_opt, \&}
\DoxyCodeLine{384                         energy, variance, accept\_rate, h2plus\_c\_converged)}
\DoxyCodeLine{385 }
\DoxyCodeLine{386                         \textcolor{comment}{! Use current optimised value of c as guess for next bond length's c,}}
\DoxyCodeLine{387                         \textcolor{comment}{! provided calculations converged this loop}}
\DoxyCodeLine{388                         \textcolor{keywordflow}{if} (h2plus\_c\_converged .eq. \textcolor{stringliteral}{'Y'}) h2plus\_param\_c\_guess = h2plus\_param\_c\_opt}
\DoxyCodeLine{389 }
\DoxyCodeLine{390                     \textcolor{keywordflow}{else}}
\DoxyCodeLine{391 }
\DoxyCodeLine{392                         \textcolor{comment}{! Find best param in grid at this bond length}}
\DoxyCodeLine{393                         \textcolor{keyword}{call }grid\_h\_2\_plus(p\_arr, bonds(b), h2plus\_param\_c\_opt, energy, \&}
\DoxyCodeLine{394                             variance, accept\_rate)}
\DoxyCodeLine{395 }
\DoxyCodeLine{396 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{397 }
\DoxyCodeLine{398                     \textcolor{comment}{! Append energy and parameters to arrays, on rank 0}}
\DoxyCodeLine{399                     \textcolor{keywordflow}{if}(my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{400                         h2plus\_param\_c\_array(b) = h2plus\_param\_c\_opt}
\DoxyCodeLine{401                         energies(b) = energy}
\DoxyCodeLine{402                         variances(b) = variance}
\DoxyCodeLine{403                         accept\_rates(b) = accept\_rate}
\DoxyCodeLine{404 }
\DoxyCodeLine{405                         \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{406                         \textcolor{keywordflow}{if} (write\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{407                             \textcolor{comment}{! TO DO -\/ write bond\_start, c\_opt and the arrays for energy, variance \& accept\_rate}}
\DoxyCodeLine{408 \textcolor{keywordflow}{                        endif}}
\DoxyCodeLine{409 }
\DoxyCodeLine{410 \textcolor{keywordflow}{                    endif}}
\DoxyCodeLine{411 }
\DoxyCodeLine{412                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{413                     \textcolor{comment}{! Run equilibrations serially on rank 0}}
\DoxyCodeLine{414                     \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{415                         \textcolor{keyword}{call }equil\_h\_2\_plus(p\_arr, bonds(b), b)}
\DoxyCodeLine{416 }
\DoxyCodeLine{417                         \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{418                         \textcolor{keywordflow}{if} (write\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{419                             \textcolor{comment}{! TO DO -\/ write bond\_start, cgrid\_start, and the bond-\/search energy array}}
\DoxyCodeLine{420 \textcolor{keywordflow}{                        endif}}
\DoxyCodeLine{421 }
\DoxyCodeLine{422 \textcolor{keywordflow}{                    endif}}
\DoxyCodeLine{423 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{424 }
\DoxyCodeLine{425 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{426 }
\DoxyCodeLine{427             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{428 }
\DoxyCodeLine{429                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ End VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{430                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{431 }
\DoxyCodeLine{432                 \textcolor{comment}{! If not in equilibration mode, write results}}
\DoxyCodeLine{433                 \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{434                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Calculations finished, writing results to NetCDF output file '}, \&}
\DoxyCodeLine{435                         outfile}
\DoxyCodeLine{436                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{437                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Calculations finished, writing results to NetCDF \&}}
\DoxyCodeLine{438 \textcolor{stringliteral}{}\textcolor{stringliteral}{                            \&output file '}, outfile}
\DoxyCodeLine{439 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{440 }
\DoxyCodeLine{441                     \textcolor{keyword}{call }write\_h2plus\_main(h2plus\_param\_c\_array, bonds, energies, variances, \&}
\DoxyCodeLine{442                         outfile, ierr, h2plus, accept\_rates)}
\DoxyCodeLine{443 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{444 }
\DoxyCodeLine{445 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{446 }
\DoxyCodeLine{447 }
\DoxyCodeLine{448     \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{449     \textcolor{comment}{!   SUBSECTION: Hydrogen Molecule}}
\DoxyCodeLine{450     \textcolor{comment}{! -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{451 }
\DoxyCodeLine{452         \textcolor{keywordflow}{case}(\textcolor{stringliteral}{'H2'})}
\DoxyCodeLine{453 }
\DoxyCodeLine{454             \textcolor{comment}{! Initialise}}
\DoxyCodeLine{455             \textcolor{keyword}{allocate}(h2\_param\_a\_array(int(h2\%bond(3))))}
\DoxyCodeLine{456             \textcolor{keyword}{allocate}(h2\_param\_beta\_array(int(h2\%bond(3))))}
\DoxyCodeLine{457             \textcolor{keyword}{allocate}(energies(int(h2\%bond(3))))}
\DoxyCodeLine{458             \textcolor{keyword}{allocate}(variances(int(h2\%bond(3))))}
\DoxyCodeLine{459             \textcolor{keyword}{allocate}(accept\_rates(int(h2\%bond(3))))}
\DoxyCodeLine{460             h2\_param\_beta\_guess = h2\%beta}
\DoxyCodeLine{461 }
\DoxyCodeLine{462             \textcolor{comment}{! Print out system info.}}
\DoxyCodeLine{463             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{464                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Doing VQMC runs across ', I7, ' bond lengths.')"{}}) int(h2\%bond(3))}
\DoxyCodeLine{465                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Steps: ', I10, ', Burn Steps: ', I7, ', Thin Every ', I7, ' Steps.')"{}}) \&}
\DoxyCodeLine{466                         h2\%steps, h2\%burn\_step, h2\%thin\_step}
\DoxyCodeLine{467                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{468 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{469 }
\DoxyCodeLine{470             \textcolor{comment}{! Set up bond length array}}
\DoxyCodeLine{471             bonds = linspace(h2\%bond(1), h2\%bond(2), h2\%bond(3))}
\DoxyCodeLine{472             \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{473                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Array of bond lengths: ')"{}})}
\DoxyCodeLine{474                 \textcolor{keywordflow}{do} i = 1, int(h2\%bond(3))}
\DoxyCodeLine{475                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Bond length ', I4, ': ', F7.4)"{}}) i, bonds(i)}
\DoxyCodeLine{476 \textcolor{keywordflow}{                end do}}
\DoxyCodeLine{477                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{478 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{479 }
\DoxyCodeLine{480             \textcolor{comment}{! Set up parameter array, if doing a grid search}}
\DoxyCodeLine{481             \textcolor{keywordflow}{if} (h2\%auto\_params .eqv. .false.) \textcolor{keywordflow}{then}}
\DoxyCodeLine{482                 p\_arr = linspace(h2\%beta\_grid(1), h2\%beta\_grid(2), h2\%beta\_grid(3))}
\DoxyCodeLine{483 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{484 }
\DoxyCodeLine{485             \textcolor{comment}{! Update user from rank 0}}
\DoxyCodeLine{486             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{487                 \textcolor{keywordflow}{if} (h2\%auto\_params .eqv. .false.) \textcolor{keywordflow}{then}}
\DoxyCodeLine{488                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Grid search across linearly spaced parameters enabled.')"{}})}
\DoxyCodeLine{489                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{490                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{491                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Grid search across linearly spaced parameters enabled.')"{}})}
\DoxyCodeLine{492                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Array of beta values: ')"{}})}
\DoxyCodeLine{493                         \textcolor{keywordflow}{do} i = 1, int(h2\%beta\_grid(3))}
\DoxyCodeLine{494                             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(F12.8)"{}}) p\_arr(i)}
\DoxyCodeLine{495 \textcolor{keywordflow}{                        end do}}
\DoxyCodeLine{496                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{497 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{498                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{499                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Automatic search across parameters enabled.')"{}})}
\DoxyCodeLine{500                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{501                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{502                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Automatic search across parameters enabled.')"{}})}
\DoxyCodeLine{503                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{504 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{505 \textcolor{keywordflow}{                endif}}
\DoxyCodeLine{506 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{507 }
\DoxyCodeLine{508             \textcolor{comment}{! Sort out restarting}}
\DoxyCodeLine{509             \textcolor{keywordflow}{if} (run\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{510                 \textcolor{comment}{! Insert optimised parameters, energies, accept\_rates, and variances into arrays}}
\DoxyCodeLine{511 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{512 }
\DoxyCodeLine{513             \textcolor{comment}{! Set up printed output for the loop.}}
\DoxyCodeLine{514             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{515                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Begin VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{516                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Bond Length    Converged?    Optimised Beta    Energy')"{}})}
\DoxyCodeLine{517                 \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{518                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Begin VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{519 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{520 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{521 }
\DoxyCodeLine{522             \textcolor{comment}{! Loop over bond lengths}}
\DoxyCodeLine{523             \textcolor{keywordflow}{do} b = 1, int(h2\%bond(3))}
\DoxyCodeLine{524 }
\DoxyCodeLine{525                 \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{526                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('  -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Bond Length = ', F7.4, ' -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/  ')"{}}) \&}
\DoxyCodeLine{527                         bonds(b)}
\DoxyCodeLine{528 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{529 }
\DoxyCodeLine{530                 \textcolor{comment}{! Calculate parameter a at this bond length by Newton-\/Raphson iteration.}}
\DoxyCodeLine{531                 h2\_param\_a = h\_2\_cusp(bonds(b))}
\DoxyCodeLine{532 }
\DoxyCodeLine{533                 \textcolor{comment}{! Main VQMC callers}}
\DoxyCodeLine{534                 \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{535                     \textcolor{comment}{! Either iterate through beta values, or automatically search for best c.}}
\DoxyCodeLine{536                     \textcolor{keywordflow}{if} (h2\%auto\_params) \textcolor{keywordflow}{then} \textcolor{comment}{! ie. if auto searching}}
\DoxyCodeLine{537 }
\DoxyCodeLine{538                         \textcolor{comment}{! Solve value of beta at this bond length.}}
\DoxyCodeLine{539                         \textcolor{keyword}{call }auto\_h\_2(h2\_param\_a, h2\_param\_beta\_guess, bonds(b), h2\_param\_beta\_opt, \&}
\DoxyCodeLine{540                             energy, variance, accept\_rate, h2\_beta\_converged)}
\DoxyCodeLine{541 }
\DoxyCodeLine{542                         \textcolor{comment}{! Use current optimised value of beta as guess for next bond length's beta,}}
\DoxyCodeLine{543                         \textcolor{comment}{! provided calculations converged this loop}}
\DoxyCodeLine{544                         \textcolor{keywordflow}{if} (h2\_beta\_converged .eq. \textcolor{stringliteral}{'Y'}) h2\_param\_beta\_guess = h2\_param\_beta\_opt}
\DoxyCodeLine{545                     }
\DoxyCodeLine{546                     \textcolor{keywordflow}{else} \textcolor{comment}{! ie. if doing a grid search}}
\DoxyCodeLine{547 }
\DoxyCodeLine{548                         \textcolor{comment}{! Get best value of beta at this bond length}}
\DoxyCodeLine{549                         \textcolor{keyword}{call }grid\_h\_2(h2\_param\_a, p\_arr, bonds(b), h2\_param\_beta\_opt, energy, \&}
\DoxyCodeLine{550                         variance, accept\_rate)}
\DoxyCodeLine{551 }
\DoxyCodeLine{552 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{553 }
\DoxyCodeLine{554                     \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{555                         \textcolor{comment}{! Append energy and parameters to arrays}}
\DoxyCodeLine{556                         h2\_param\_a\_array(b) = h2\_param\_a}
\DoxyCodeLine{557                         h2\_param\_beta\_array(b) = h2\_param\_beta\_opt}
\DoxyCodeLine{558                         energies(b) = energy}
\DoxyCodeLine{559                         variances(b) = variance}
\DoxyCodeLine{560                         accept\_rates(b) = accept\_rate}
\DoxyCodeLine{561 }
\DoxyCodeLine{562                         \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{563                         \textcolor{keywordflow}{if} (write\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{564                             \textcolor{comment}{! TO DO -\/ write bond\_start, beta\_opt and the arrays for energy, variance \& accept\_rate}}
\DoxyCodeLine{565 \textcolor{keywordflow}{                        endif}}
\DoxyCodeLine{566 }
\DoxyCodeLine{567 \textcolor{keywordflow}{                    endif}}
\DoxyCodeLine{568 }
\DoxyCodeLine{569                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{570 }
\DoxyCodeLine{571                     \textcolor{comment}{! Run equilibrations}}
\DoxyCodeLine{572                     \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{573                         \textcolor{keyword}{call }equil\_h\_2(h2\_param\_a, p\_arr, bonds(b), b)}
\DoxyCodeLine{574 }
\DoxyCodeLine{575                         \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{576                         \textcolor{keywordflow}{if} (write\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{577                             \textcolor{comment}{! TO DO -\/ write bond\_start, cgrid\_start, and the bond-\/search energy array}}
\DoxyCodeLine{578 \textcolor{keywordflow}{                        endif}}
\DoxyCodeLine{579 \textcolor{keywordflow}{                    endif}}
\DoxyCodeLine{580 }
\DoxyCodeLine{581 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{582 }
\DoxyCodeLine{583 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{584 }
\DoxyCodeLine{585             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{586 }
\DoxyCodeLine{587                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ End VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{588                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{589 }
\DoxyCodeLine{590                 \textcolor{comment}{! If not in equilibration mode, write results}}
\DoxyCodeLine{591                 \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{592 }
\DoxyCodeLine{593                     \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Calculations finished, writing results to NetCDF output file '}, \&}
\DoxyCodeLine{594                         outfile}
\DoxyCodeLine{595 }
\DoxyCodeLine{596                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{597                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Calculations finished, writing results to NetCDF \&}}
\DoxyCodeLine{598 \textcolor{stringliteral}{}\textcolor{stringliteral}{                            \&output file '}, outfile}
\DoxyCodeLine{599 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{600 }
\DoxyCodeLine{601                     \textcolor{keyword}{call }write\_h2\_main(h2\_param\_a\_array, h2\_param\_beta\_array, bonds, \&}
\DoxyCodeLine{602                         energies, variances, outfile, ierr, h2, accept\_rates)}
\DoxyCodeLine{603 }
\DoxyCodeLine{604 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{605 }
\DoxyCodeLine{606 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{607 }
\DoxyCodeLine{608         \textcolor{comment}{! Default case, for if none of the cases match. Should be invalidated by checks in input\_parser.}}
\DoxyCodeLine{609 \textcolor{keywordflow}{        case default}}
\DoxyCodeLine{610             error stop \textcolor{stringliteral}{'Unknown case. How did you get here?'}}
\DoxyCodeLine{611 \textcolor{keywordflow}{    end select}}
\DoxyCodeLine{612 }
\DoxyCodeLine{613     \textcolor{comment}{! Close logfile from rank 0}}
\DoxyCodeLine{614     \textcolor{keywordflow}{if} (i\_log) \textcolor{keyword}{close}(logid)}
\DoxyCodeLine{615 }
\DoxyCodeLine{616     \textcolor{comment}{! End MPI parallelism}}
\DoxyCodeLine{617     \textcolor{keyword}{call }mpi\_finalize(mpierr)}
\DoxyCodeLine{618 }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=550pt]{driver_8f90_aae94725eafaedc467ab9bfefcae9769e_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=195pt]{driver_8f90_aae94725eafaedc467ab9bfefcae9769e_icgraph}
\end{center}
\end{figure}
