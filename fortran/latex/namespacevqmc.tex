\hypertarget{namespacevqmc}{}\doxysection{vqmc Module Reference}
\label{namespacevqmc}\index{vqmc@{vqmc}}


Contains routines for handline random number generation, the main VQMC algorithms and routines for determining ideal parameters.  


\doxysubsection*{Functions/\+Subroutines}
\begin{DoxyCompactItemize}
\item 
subroutine \mbox{\hyperlink{namespacevqmc_aed182179994b5465f5466b4d909a764e}{init\+\_\+ran1}} ()
\begin{DoxyCompactList}\small\item\em Initialiser for the random number generator. \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{namespacevqmc_a01b80444204a0cd0b5cddde82cbc7651}{ran1}} (sample, dseed)
\begin{DoxyCompactList}\small\item\em Implementation of Press et al\textquotesingle{}s random number generator. \end{DoxyCompactList}\item 
real(real64) function, dimension(\+:), allocatable \mbox{\hyperlink{namespacevqmc_a6b89c5b7a64a3e438695787b90a62359}{linspace}} (start, end, num)
\begin{DoxyCompactList}\small\item\em Adaptation of numpy\textquotesingle{}s linspace function. \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{namespacevqmc_a62ec9b662e5d9b46ec37d52ff93cb335}{random\+\_\+normal}} (dim, x)
\begin{DoxyCompactList}\small\item\em Draws a sample from a normal distribution using the Box-\/\+Muller transform. \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{namespacevqmc_a05315751002a983c9976851c9f21f0f0}{vqmc\+\_\+qho}} (sigma, N, burn, thin, alpha\+\_\+const, X\+\_\+burnt, accept\+\_\+rate, energy\+\_\+chain, energy\+\_\+mean, energy\+\_\+variance, x\+\_\+start)
\begin{DoxyCompactList}\small\item\em Performs VQMC for the QHO system. \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{namespacevqmc_a726aff689b64924586b655d2e8a846d1}{grid\+\_\+qho}} (alpha\+\_\+array, energies, acc\+\_\+rates, variances)
\begin{DoxyCompactList}\small\item\em Performs VQMC on an array of values for the variational parameter $ \alpha $. \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{namespacevqmc_a5d73324fcbe9c3ef7fe11309581af529}{equil\+\_\+qho}} (alpha\+\_\+array)
\begin{DoxyCompactList}\small\item\em Performs VQMC on an array of values for the variational parameter $ \alpha $, outputting energy traces for each. \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{namespacevqmc_a8213f95bb390d7a9eff8260f527c00b8}{vqmc\+\_\+h\+\_\+2\+\_\+plus}} (sigma, N, burn, thin, c\+\_\+const, R\+\_\+a, R\+\_\+b, X\+\_\+burnt, accept\+\_\+rate, energy\+\_\+chain, energy\+\_\+mean, energy\+\_\+variance, Dphi\+Dc\+\_\+chain, x\+\_\+start)
\begin{DoxyCompactList}\small\item\em Performs VQMC for the $ H_{2}^{+} $ system. ~\newline
 \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{namespacevqmc_a0a07ef5b098cdc478b253de26c49aadc}{auto\+\_\+h\+\_\+2\+\_\+plus}} (c\+\_\+in, bond\+\_\+length, c\+\_\+out, energy\+\_\+out, variance\+\_\+out, accept\+\_\+out, converged)
\begin{DoxyCompactList}\small\item\em Automatically finds the best variational parameter $ c $ for the $ H_{2}^{+} $ problem at given bond length. \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{namespacevqmc_a70c9fcecdf5f2a6ffea7dd3c4f0c1eeb}{grid\+\_\+h\+\_\+2\+\_\+plus}} (c\+\_\+array, bond\+\_\+length, c\+\_\+out, energy\+\_\+out, variance\+\_\+out, accept\+\_\+out)
\begin{DoxyCompactList}\small\item\em Performs a grid search to find the optimal value for the variational parameter $ c $ in the $ H_{2}^{+} $ problem. \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{namespacevqmc_a169c06cb168984ca6285231ad80a0243}{equil\+\_\+h\+\_\+2\+\_\+plus}} (c\+\_\+array, bond\+\_\+length, bonds\+\_\+pos)
\begin{DoxyCompactList}\small\item\em Performs VQMC on an array of values for the variational parameter $ c $, outputting energy traces for each. \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{namespacevqmc_a12f60b20a934a7eb8c6e3cdaaac0b1cc}{vqmc\+\_\+h\+\_\+2}} (sigma, N, burn, thin, a, beta, R\+\_\+a, R\+\_\+b, X\+\_\+1\+\_\+burnt, X\+\_\+2\+\_\+burnt, accept\+\_\+rate, energy\+\_\+chain, energy\+\_\+mean, energy\+\_\+variance, Dphi\+Dbeta\+\_\+chain, x\+\_\+start\+\_\+1, x\+\_\+start\+\_\+2)
\begin{DoxyCompactList}\small\item\em Performs VQMC for the $ H_{2}^{+} $ system. ~\newline
 \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{namespacevqmc_a70dc752a6b037f137c1264dd8753bac2}{auto\+\_\+h\+\_\+2}} (a, beta\+\_\+in, bond\+\_\+length, beta\+\_\+out, energy\+\_\+out, variance\+\_\+out, accept\+\_\+out, converged)
\begin{DoxyCompactList}\small\item\em Automatically finds the best variational parameter $ \beta $ for the $ H_{2}^{+} $ problem at a given bond length. \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{namespacevqmc_a08bc46270707aab6c2d5114b589c176c}{grid\+\_\+h\+\_\+2}} (a, beta\+\_\+array, bond\+\_\+length, beta\+\_\+out, energy\+\_\+out, variance\+\_\+out, accept\+\_\+out)
\begin{DoxyCompactList}\small\item\em Performs a grid search to find the optimal value for the variational parameter $ \beta $ in the $ H_{2} $ problem. \end{DoxyCompactList}\item 
subroutine \mbox{\hyperlink{namespacevqmc_ab066adc59fec1fcaaba764a46128c935}{equil\+\_\+h\+\_\+2}} (a, beta\+\_\+array, bond\+\_\+length, bonds\+\_\+pos)
\begin{DoxyCompactList}\small\item\em Performs VQMC on an array of values for the variational parameter $ \beta $, outputting energy traces for each. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
integer, parameter \mbox{\hyperlink{namespacevqmc_a4acb6b64bbac5c4684654d00393f7f24}{ntab}} = 32
\begin{DoxyCompactList}\small\item\em Variable controlling the RNG sequence. \end{DoxyCompactList}\item 
integer(int64), dimension(\mbox{\hyperlink{namespacevqmc_a4acb6b64bbac5c4684654d00393f7f24}{ntab}}), save \mbox{\hyperlink{namespacevqmc_a86db46440794b9ef7cfd9fbf1fd69930}{iv}} = 0
\begin{DoxyCompactList}\small\item\em Variable controlling the RNG sequence. \end{DoxyCompactList}\item 
integer(int64), save \mbox{\hyperlink{namespacevqmc_a1608372d703310a49afc4243ccf27368}{iy}} = 0
\begin{DoxyCompactList}\small\item\em Variable controlling the RNG sequence. \end{DoxyCompactList}\item 
integer \mbox{\hyperlink{namespacevqmc_a4f41e2c494f06da125bf9a56314161b5}{logfrac}} = 10
\begin{DoxyCompactList}\small\item\em 1/logfrac is the fraction of samples to report in the log, if \mbox{\hyperlink{namespaceshared__data_acf2cbacc5b2b4d8ee26c96dc7062aa9b}{shared\+\_\+data\+::write\+\_\+log}} is {\itshape TRUE}. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Contains routines for handline random number generation, the main VQMC algorithms and routines for determining ideal parameters. 

This module contains the VQMC solvers for the quantum harmonic oscillator (QHO), hydrogen ion (H\+\_\+2\+\_\+plus) and hydrogen molecule (H\+\_\+2) problems. It also has the subroutine random normal which generates a sample from a normal distribution using the Box-\/\+Muller transfrom, which is needed for the Metropolis algorithm used in VQMC. This uses a random number generator which is initially seeded by environmental noise through /dev/urandom, and then propagated by an algorithm from {\itshape  Numerical Recipes } by Press et al. (2007)

The VQMC algorithms use the \mbox{\hyperlink{namespacesolvers}{solvers}} module to obtain the transition probabilities needed for the Metropolis algorithm and to calculate the local energies given the position of the random walker(s).

The module also contains routines for running these VQMC algorithms across a range of parameters. The {\itshape Grid} routines are used to do a search for the best variational parameter on a user-\/defined grid, while the {\itshape Auto} routines utilise the gradients calculated by the local energy routines to automatically determine the best variational parameter from a suitable guess. {\itshape Equil} routines are also included to run VQMC over a parameter grid, but to output the position and energy traces from VQMC rather than a total energy. These traces can then be used to determine optimal burning/thinning parameters for the Markov chains, using tools in the Python frontend. 

\doxysubsection{Function/\+Subroutine Documentation}
\mbox{\Hypertarget{namespacevqmc_aed182179994b5465f5466b4d909a764e}\label{namespacevqmc_aed182179994b5465f5466b4d909a764e}} 
\index{vqmc@{vqmc}!init\_ran1@{init\_ran1}}
\index{init\_ran1@{init\_ran1}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{init\_ran1()}{init\_ran1()}}
{\footnotesize\ttfamily subroutine vqmc\+::init\+\_\+ran1}



Initialiser for the random number generator. 

Initialises the random number generator by drawing a seed from the environmental noise in /dev/urandom. Cuts down this seed to a smaller integer to prevent overflows in \mbox{\hyperlink{namespacevqmc_a01b80444204a0cd0b5cddde82cbc7651}{ran1}} when the seed is converted to a double-\/precision float. 

Definition at line 68 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{69 }
\DoxyCodeLine{70         \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{71 }
\DoxyCodeLine{72         \textcolor{keywordtype}{integer} :: fu       \textcolor{comment}{! File unit}}
\DoxyCodeLine{73         \textcolor{keywordtype}{integer} :: rc       \textcolor{comment}{! I/O status of read from /dev/urandom}}
\DoxyCodeLine{74         \textcolor{keywordtype}{integer} :: l\_seed   \textcolor{comment}{! Length of unshortened seed}}
\DoxyCodeLine{75         \textcolor{keywordtype}{character(len=30)} :: c\_seed     \textcolor{comment}{! Character value of seed}}
\DoxyCodeLine{76 }
\DoxyCodeLine{77         \textcolor{comment}{! Read pseudorandom noise from /dev/urandom}}
\DoxyCodeLine{78         \textcolor{keyword}{open} (access=\textcolor{stringliteral}{'stream'}, action=\textcolor{stringliteral}{'read'}, file=\textcolor{stringliteral}{'/dev/urandom'}, \&}
\DoxyCodeLine{79         form=\textcolor{stringliteral}{'unformatted'}, iostat=rc, newunit=fu)}
\DoxyCodeLine{80 }
\DoxyCodeLine{81         \textcolor{keywordflow}{if} (rc == 0) \textcolor{keyword}{read} (fu) seed}
\DoxyCodeLine{82 }
\DoxyCodeLine{83         \textcolor{keyword}{close} (fu)}
\DoxyCodeLine{84 }
\DoxyCodeLine{85         \textcolor{comment}{! Convert long seed to characters, shorten and convert back into an integer}}
\DoxyCodeLine{86         \textcolor{keyword}{write}(c\_seed, \textcolor{stringliteral}{"{}(I30)"{}}) seed}
\DoxyCodeLine{87         l\_seed = len(c\_seed)}
\DoxyCodeLine{88         c\_seed = adjustl(c\_seed)}
\DoxyCodeLine{89         c\_seed = c\_seed(7:l\_seed)}
\DoxyCodeLine{90         \textcolor{keyword}{read}(c\_seed, *) seed}
\DoxyCodeLine{91 }
\DoxyCodeLine{92         \textcolor{comment}{! Ensure seed is negative for compatability with ran1}}
\DoxyCodeLine{93         \textcolor{keywordflow}{if} (seed .gt. 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{94             seed = -\/seed}
\DoxyCodeLine{95 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{96 }

\end{DoxyCode}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=313pt]{namespacevqmc_aed182179994b5465f5466b4d909a764e_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_a01b80444204a0cd0b5cddde82cbc7651}\label{namespacevqmc_a01b80444204a0cd0b5cddde82cbc7651}} 
\index{vqmc@{vqmc}!ran1@{ran1}}
\index{ran1@{ran1}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{ran1()}{ran1()}}
{\footnotesize\ttfamily subroutine vqmc\+::ran1 (\begin{DoxyParamCaption}\item[{real(real64), intent(out)}]{sample,  }\item[{integer(int64), intent(inout)}]{dseed }\end{DoxyParamCaption})}



Implementation of Press et al\textquotesingle{}s random number generator. 

Update to David Quigley\textquotesingle{}s implementation of Press et al\textquotesingle{}s random number generator (originally from {\itshape  Numerical Methods }), as seem in PX425 Assignment 3, to be Fortran 2008 compliant.

\begin{DoxyRemark}{Remarks}
NOTE\+: The variable dseed must be a negative integer when this routine is first called, otherwise the generator will not initialise properly. 
\end{DoxyRemark}

\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in,out}}  & {\em dseed} & Current value of seed. Must be a negative integer on first call of this routine. \\
\hline
\mbox{\texttt{ out}}  & {\em sample} & Uniform random number. \\
\hline
\end{DoxyParams}


Definition at line 118 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{119 }
\DoxyCodeLine{120         \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{121 }
\DoxyCodeLine{122         \textcolor{keywordtype}{integer(int64)}, \textcolor{keywordtype}{intent(inout)} :: dseed}
\DoxyCodeLine{123 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: sample}
\DoxyCodeLine{124 }
\DoxyCodeLine{125         \textcolor{comment}{! Constants defined in Press et al}}
\DoxyCodeLine{126         \textcolor{keywordtype}{integer(int64)}, \textcolor{keywordtype}{parameter} :: ia = 16807, im = 2147483647, iq = 1\textcolor{comment}{27773}}
\DoxyCodeLine{127 \textcolor{comment}{}        \textcolor{keywordtype}{integer(int64)}, \textcolor{keywordtype}{parameter} :: ir = 2836, \&}
\DoxyCodeLine{128                                      ndiv = 1 + floor((real(im, kind=real64\textcolor{comment}{)-\/1.0)/ntab)}}
\DoxyCodeLine{129 \textcolor{comment}{}\textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{parameter} :: am = 1.0/real(im, kind=real64), eps =\textcolor{comment}{ 1.2e-\/7, \&}}
\DoxyCodeLine{130 \textcolor{comment}{}                                   rnmx = 1.0-\/eps}
\DoxyCodeLine{131 }
\DoxyCodeLine{132         \textcolor{comment}{! Loop counters}}
\DoxyCodeLine{133         \textcolor{keywordtype}{integer(int64)} :: j, k}
\DoxyCodeLine{134 }
\DoxyCodeLine{135         \textcolor{comment}{! The following is transcribed directly from Press et al}}
\DoxyCodeLine{136         \textcolor{keywordflow}{if} (dseed<=0 .or. iy==0) \textcolor{keywordflow}{then} \textcolor{comment}{! initialization}}
\DoxyCodeLine{137                                       \textcolor{comment}{! NB this may need to be modified to allow for restarting as iy will be 0}}
\DoxyCodeLine{138             dseed = max(-\/dseed,1)}
\DoxyCodeLine{139 }
\DoxyCodeLine{140             \textcolor{keywordflow}{do} j = ntab+8, 1, -\/1}
\DoxyCodeLine{141                 k = floor(real(dseed, kind=real64)/real(iq, kind=real64)\textcolor{comment}{)}}
\DoxyCodeLine{142 \textcolor{comment}{}                dseed = ia * (dseed-\/k*iq) -\/ ir * k}
\DoxyCodeLine{143                 \textcolor{keywordflow}{if} (dseed < 0) dseed = dseed + im}
\DoxyCodeLine{144                 \textcolor{keywordflow}{if} (j <= ntab) iv(j) = dseed}
\DoxyCodeLine{145 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{146 }
\DoxyCodeLine{147             iy = iv(1)}
\DoxyCodeLine{148 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{149 }
\DoxyCodeLine{150         k = floor(real(dseed, kind=real64)/real(iq, kind=real64))}
\DoxyCodeLine{151         dseed = ia * (dseed-\/k*iq) -\/ ir * k}
\DoxyCodeLine{152         \textcolor{keywordflow}{if} (dseed < 0) dseed = dseed + im}
\DoxyCodeLine{153         j = 1\_int64 + iy / ndiv}
\DoxyCodeLine{154         iy = iv(j)}
\DoxyCodeLine{155         iv(j) = dseed}
\DoxyCodeLine{156         sample = min(am*iy, rnmx)}
\DoxyCodeLine{157 }

\end{DoxyCode}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a01b80444204a0cd0b5cddde82cbc7651_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_a6b89c5b7a64a3e438695787b90a62359}\label{namespacevqmc_a6b89c5b7a64a3e438695787b90a62359}} 
\index{vqmc@{vqmc}!linspace@{linspace}}
\index{linspace@{linspace}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{linspace()}{linspace()}}
{\footnotesize\ttfamily real(real64) function, dimension(\+:), allocatable vqmc\+::linspace (\begin{DoxyParamCaption}\item[{real(real64), intent(in)}]{start,  }\item[{real(real64), intent(in)}]{end,  }\item[{real(real64), intent(in)}]{num }\end{DoxyParamCaption})}



Adaptation of numpy\textquotesingle{}s linspace function. 

Uses a REAL value for num for compatability with parameter arrays, then converts to int internally. Returns a length 1 array just containing the start value if num is equal to 1. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em start} & Starting value of the sequence \\
\hline
\mbox{\texttt{ in}}  & {\em end} & End value of the sequence \\
\hline
\mbox{\texttt{ in}}  & {\em num} & Number of samples to generate between start and end value ~\newline
 \\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{Return values}
{\em ls\+\_\+array} & An array with evenly specified numbers over an interval \\
\hline
\end{DoxyRetVals}


Definition at line 182 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{183 }
\DoxyCodeLine{184         \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{185 }
\DoxyCodeLine{186 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: start, end, num}
\DoxyCodeLine{187 }
\DoxyCodeLine{188 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: ls\_array}
\DoxyCodeLine{189 }
\DoxyCodeLine{190         \textcolor{keywordtype}{integer} :: inum                                         \textcolor{comment}{! The integer type of num}}
\DoxyCodeLine{191         \textcolor{keywordtype}{integer} :: i                                            \textcolor{comment}{! Loop variable }}
\DoxyCodeLine{192 \textcolor{keywordtype}{        real}(real64) :: step                                    \textcolor{comment}{! Spacing between two numbers in the array}}
\DoxyCodeLine{193 }
\DoxyCodeLine{194         \textcolor{comment}{! Handle real value for num}}
\DoxyCodeLine{195         inum = int(num)}
\DoxyCodeLine{196         \textcolor{comment}{! Handle single values}}
\DoxyCodeLine{197         \textcolor{keywordflow}{if} (inum .eq. 1) \textcolor{keywordflow}{then}}
\DoxyCodeLine{198             \textcolor{keyword}{allocate}(ls\_array(inum))}
\DoxyCodeLine{199             ls\_array(1) = start}
\DoxyCodeLine{200         \textcolor{comment}{! Handle multiple values}}
\DoxyCodeLine{201         \textcolor{keywordflow}{else}}
\DoxyCodeLine{202             \textcolor{comment}{! Generate array}}
\DoxyCodeLine{203             \textcolor{keyword}{allocate}(ls\_array(inum))}
\DoxyCodeLine{204             \textcolor{comment}{! Find step size}}
\DoxyCodeLine{205             step = (\textcolor{keyword}{end }-\/ start) / real(inum-\/1, kind=real64)}
\DoxyCodeLine{206             \textcolor{comment}{! Fill array}}
\DoxyCodeLine{207             \textcolor{keywordflow}{do} i = 1, inum}
\DoxyCodeLine{208                 ls\_array(i) = start + (i-\/1)*step}
\DoxyCodeLine{209 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{210 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{211 }

\end{DoxyCode}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a6b89c5b7a64a3e438695787b90a62359_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_a62ec9b662e5d9b46ec37d52ff93cb335}\label{namespacevqmc_a62ec9b662e5d9b46ec37d52ff93cb335}} 
\index{vqmc@{vqmc}!random\_normal@{random\_normal}}
\index{random\_normal@{random\_normal}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{random\_normal()}{random\_normal()}}
{\footnotesize\ttfamily subroutine vqmc\+::random\+\_\+normal (\begin{DoxyParamCaption}\item[{integer, intent(in)}]{dim,  }\item[{real(real64), dimension(\+:), intent(out)}]{x }\end{DoxyParamCaption})}



Draws a sample from a normal distribution using the Box-\/\+Muller transform. 

Uses the uniform random number generator \mbox{\hyperlink{namespacevqmc_a01b80444204a0cd0b5cddde82cbc7651}{ran1}} to generate an array of normally distributed numbers, by means of the Box-\/\+Muller transform. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em dim} & The dimension of the random vector to be generated. \\
\hline
\mbox{\texttt{ out}}  & {\em x} & The vector sample from the normal distribution. \\
\hline
\end{DoxyParams}


Definition at line 228 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{229         }
\DoxyCodeLine{230         \textcolor{keywordtype}{implicit none} }
\DoxyCodeLine{231 }
\DoxyCodeLine{232         \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: dim}
\DoxyCodeLine{233 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)}, \textcolor{keywordtype}{dimension(:)} :: x }
\DoxyCodeLine{234         }
\DoxyCodeLine{235 \textcolor{keywordtype}{        real}(real64) :: u\_1, u\_2                        \textcolor{comment}{! Samples from uniform distribution }}
\DoxyCodeLine{236         \textcolor{keywordtype}{integer} :: i                                    \textcolor{comment}{! Loop variable }}
\DoxyCodeLine{237 }
\DoxyCodeLine{238         \textcolor{comment}{! Generate vector containg samples from normal distributions }}
\DoxyCodeLine{239         \textcolor{keywordflow}{do} i = 1, dim}
\DoxyCodeLine{240             \textcolor{comment}{! This can be done the Fortran intrinsic random number generator but this }}
\DoxyCodeLine{241             \textcolor{comment}{! is not a good random number generator }}
\DoxyCodeLine{242             \textcolor{comment}{! call random\_number(u\_1)}}
\DoxyCodeLine{243             \textcolor{comment}{! call random\_number(u\_2)}}
\DoxyCodeLine{244 }
\DoxyCodeLine{245             \textcolor{comment}{! Draws from uniform distribution}}
\DoxyCodeLine{246             \textcolor{keyword}{call }ran1(u\_1, seed)}
\DoxyCodeLine{247             \textcolor{keyword}{call }ran1(u\_2, seed)}
\DoxyCodeLine{248 }
\DoxyCodeLine{249             \textcolor{comment}{! Calculate the sample from the normal distribution using the Box-\/Muller transform }}
\DoxyCodeLine{250             x(i) = sqrt(-\/2*log(u\_1))*cos(2*pi*u\_2)}
\DoxyCodeLine{251 \textcolor{keywordflow}{        end do} }
\DoxyCodeLine{252 }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=292pt]{namespacevqmc_a62ec9b662e5d9b46ec37d52ff93cb335_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a62ec9b662e5d9b46ec37d52ff93cb335_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_a05315751002a983c9976851c9f21f0f0}\label{namespacevqmc_a05315751002a983c9976851c9f21f0f0}} 
\index{vqmc@{vqmc}!vqmc\_qho@{vqmc\_qho}}
\index{vqmc\_qho@{vqmc\_qho}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{vqmc\_qho()}{vqmc\_qho()}}
{\footnotesize\ttfamily subroutine vqmc\+::vqmc\+\_\+qho (\begin{DoxyParamCaption}\item[{real(real64), intent(in)}]{sigma,  }\item[{integer, intent(in)}]{N,  }\item[{integer, intent(in)}]{burn,  }\item[{integer, intent(in)}]{thin,  }\item[{real(real64), intent(in)}]{alpha\+\_\+const,  }\item[{real(real64), dimension(\+:), intent(out), allocatable}]{X\+\_\+burnt,  }\item[{real(real64), intent(out)}]{accept\+\_\+rate,  }\item[{real(real64), dimension(\+:), intent(out), allocatable}]{energy\+\_\+chain,  }\item[{real(real64), intent(out)}]{energy\+\_\+mean,  }\item[{real(real64), intent(out)}]{energy\+\_\+variance,  }\item[{real(real64), optional}]{x\+\_\+start }\end{DoxyParamCaption})}



Performs VQMC for the QHO system. 

Computes the total energy of a trial wavefunction by averaging over a Markov chain of local energies generated by \mbox{\hyperlink{namespacesolvers_a4f0054c0d0d2f5080c92a04557feaf52}{QHO\+\_\+\+Energy}}, with random move acceptance/rejection probability determined by \mbox{\hyperlink{namespacesolvers_a722edf182d188ad1db7fa6a675fea13c}{QHO\+\_\+\+Prob}}.

Allows for modification of total Markov chain length, as well as the number of steps to be \textquotesingle{}burned\textquotesingle{} while the chain is equilibrating and the interval to \textquotesingle{}thin\textquotesingle{} the chain over to reduce correlation of samples. The size of the proposed random moves can be controlled by modifying the {\bfseries{sigma}} parameter to get an ideal move acceptance rate. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em sigma} & Step size \\
\hline
\mbox{\texttt{ in}}  & {\em N} & Number of steps to take \\
\hline
\mbox{\texttt{ in}}  & {\em burn} & Number of sample to discard at the beginning \\
\hline
\mbox{\texttt{ in}}  & {\em thin} & The frequency at which we discard the samples from the MCMC chain after burning ~\newline
 \\
\hline
\mbox{\texttt{ in}}  & {\em alpha\+\_\+const} & Parameter \\
\hline
\mbox{\texttt{ in}}  & {\em x\+\_\+start} & Starting point of MCMC chain (optional, default is randomly generated) \\
\hline
\mbox{\texttt{ out}}  & {\em X\+\_\+burnt} & The burnt and thinned MCMC chain for the random walker \\
\hline
\mbox{\texttt{ out}}  & {\em accept\+\_\+rate} & The acceptance rate of the MCMC chain \\
\hline
\mbox{\texttt{ out}}  & {\em energy\+\_\+chain} & An array with the local energies of the each points in the MCMC chain \\
\hline
\mbox{\texttt{ out}}  & {\em energy\+\_\+mean} & The average of the local energies recorded in {\bfseries{energy\+\_\+chain}} \\
\hline
\mbox{\texttt{ out}}  & {\em energy\+\_\+variance} & The variance of the local energies recorded in {\bfseries{energy\+\_\+chain}} \\
\hline
\end{DoxyParams}


Definition at line 289 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{291 }
\DoxyCodeLine{292         \textcolor{keywordtype}{implicit none} }
\DoxyCodeLine{293 }
\DoxyCodeLine{294 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: sigma, alpha\_const}
\DoxyCodeLine{295         \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: N, burn, thin }
\DoxyCodeLine{296 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{optional} :: x\_start }
\DoxyCodeLine{297          }
\DoxyCodeLine{298 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: accept\_rate, energy\_mean, energy\_variance}
\DoxyCodeLine{299 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: X\_burnt,\textcolor{comment}{ energy\_chain }}
\DoxyCodeLine{300 \textcolor{comment}{        }}
\DoxyCodeLine{301 \textcolor{comment}{}\textcolor{keywordtype}{        real}(real64) :: log\_prob\_n                      \textcolor{comment}{! The natural logarithm of the transition probability}}
\DoxyCodeLine{302 \textcolor{keywordtype}{        real}(real64) :: a\_prob\_trans                    \textcolor{comment}{! Acceptance ratio of the transition probability }}
\DoxyCodeLine{303 \textcolor{keywordtype}{        real}(real64) :: unif\_num                        \textcolor{comment}{! A random sample from the uniform distribution }}
\DoxyCodeLine{304 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(1)} :: start             \textcolor{comment}{! The starting point of the MCMC chain }}
\DoxyCodeLine{305 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(1)} :: X\_n               \textcolor{comment}{! The proposed step }}
\DoxyCodeLine{306 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(1)} :: sample\_normal     \textcolor{comment}{! A sample from the normal distribution }}
\DoxyCodeLine{307 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: X    \textcolor{comment}{! Non-\/burnt or thinned MCMC chain}}
\DoxyCodeLine{308         \textcolor{keywordtype}{integer} :: thin\_counter                         \textcolor{comment}{! Counter to keep track of the thinning process}}
\DoxyCodeLine{309         \textcolor{keywordtype}{integer} :: reset\_counter                        \textcolor{comment}{! Counts how many times thin counter was reset}}
\DoxyCodeLine{310         \textcolor{keywordtype}{integer} :: accept                               \textcolor{comment}{! Number of accepted steps }}
\DoxyCodeLine{311         \textcolor{keywordtype}{integer} :: i                                    \textcolor{comment}{! Loop variable }}
\DoxyCodeLine{312         \textcolor{keywordtype}{integer} :: i\_bt                                 \textcolor{comment}{! Burned/thinned value of i}}
\DoxyCodeLine{313         \textcolor{keywordtype}{integer} :: re\_size                              \textcolor{comment}{! The size of the burnt and thinned array}}
\DoxyCodeLine{314         \textcolor{keywordtype}{character(len=1)} :: acceptance                  \textcolor{comment}{! Yes/No signpost for acceptance}}
\DoxyCodeLine{315 }
\DoxyCodeLine{316         \textcolor{comment}{! Adjust the output array to be of the burnt and thinned array}}
\DoxyCodeLine{317         re\_size = (n -\/ burn) / thin}
\DoxyCodeLine{318         }
\DoxyCodeLine{319         \textcolor{keyword}{allocate}(x(1: n+1)); x(:) = 0.0\_real64}
\DoxyCodeLine{320         \textcolor{keyword}{allocate}(x\_burnt(1: re\_size)); x\_burnt(:) = 0.0\_real64}
\DoxyCodeLine{321         \textcolor{keyword}{allocate}(energy\_chain(1: re\_size)); energy\_chain(:) = 0.0\_real64}
\DoxyCodeLine{322         }
\DoxyCodeLine{323         \textcolor{comment}{! Allow the starting position to take the defualt value }}
\DoxyCodeLine{324         \textcolor{keywordflow}{if} (\textcolor{keyword}{present}(x\_start)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{325             start = x\_start}
\DoxyCodeLine{326             x(1) = start(1)}
\DoxyCodeLine{327             \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{328                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Starting from provided Markov chain position', F12.8)"{}}\textcolor{comment}{) x(1)}}
\DoxyCodeLine{329 \textcolor{comment}{}\textcolor{keywordflow}{            end if}}
\DoxyCodeLine{330         \textcolor{keywordflow}{else} }
\DoxyCodeLine{331             \textcolor{comment}{! Creates the initial position of the random walker that is within a certain radius  }}
\DoxyCodeLine{332             \textcolor{keyword}{call }random\_normal(1, sample\_normal)}
\DoxyCodeLine{333             \textcolor{keywordflow}{do} \textcolor{keywordflow}{while}(norm2(sample\_normal) >= qho\%rcut)}
\DoxyCodeLine{334                 \textcolor{keyword}{call }random\_normal(1, sample\_normal)}
\DoxyCodeLine{335 \textcolor{keywordflow}{            end do} }
\DoxyCodeLine{336             start = sample\_normal}
\DoxyCodeLine{337             x(1) = start(1)}
\DoxyCodeLine{338             \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{339                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Generated random Markov chain start position', F12.8)"{}}\textcolor{comment}{) x(1)}}
\DoxyCodeLine{340 \textcolor{comment}{}\textcolor{keywordflow}{            end if}}
\DoxyCodeLine{341 \textcolor{keywordflow}{        end if} }
\DoxyCodeLine{342 }
\DoxyCodeLine{343         \textcolor{comment}{! Start the counter for the number of accepted moves}}
\DoxyCodeLine{344         accept = 0 }
\DoxyCodeLine{345         \textcolor{comment}{! Start the counter for the thinning process}}
\DoxyCodeLine{346         thin\_counter = 0}
\DoxyCodeLine{347         \textcolor{comment}{! Start the reset counter }}
\DoxyCodeLine{348         reset\_counter = 0}
\DoxyCodeLine{349 }
\DoxyCodeLine{350         \textcolor{comment}{!Write initial conditions to the output file}}
\DoxyCodeLine{351         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{352             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Markov chain for alpha = ', F7.4)"{}}) alpha\_const}
\DoxyCodeLine{353             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Sample     Position       Local Energy     Accepted?')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{354 \textcolor{comment}{}            \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.6)"{}}) 1, x(1), energy\_chain\textcolor{comment}{(1)}}
\DoxyCodeLine{355 \textcolor{comment}{}\textcolor{keywordflow}{        end if}}
\DoxyCodeLine{356 }
\DoxyCodeLine{357         \textcolor{comment}{! In case burn = 0 to start calculating the chain from the beginning }}
\DoxyCodeLine{358         \textcolor{keywordflow}{if} (burn == 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{359             energy\_chain(1) = qho\_energy(alpha\_const, x(1))}
\DoxyCodeLine{360             x\_burnt(1) = x(1)}
\DoxyCodeLine{361 }
\DoxyCodeLine{362             \textcolor{keywordflow}{do} i = 2, n }
\DoxyCodeLine{363                 \textcolor{comment}{! Add one to the thin counter }}
\DoxyCodeLine{364                 thin\_counter = 1 + thin\_counter           }
\DoxyCodeLine{365                 \textcolor{comment}{! Propose the next step}}
\DoxyCodeLine{366                 \textcolor{keyword}{call }random\_normal(1, sample\_normal)}
\DoxyCodeLine{367                 x\_n = x(i-\/1) + sigma * sample\_normal}
\DoxyCodeLine{368 }
\DoxyCodeLine{369                 \textcolor{comment}{! Calculate the transition probability between proposed step and current step}}
\DoxyCodeLine{370                 log\_prob\_n = log(qho\_prob(alpha\_const, x(i-\/1), x\_n(1)))}
\DoxyCodeLine{371             }
\DoxyCodeLine{372                 \textcolor{comment}{! Calculate the acceptance ratio}}
\DoxyCodeLine{373                 a\_prob\_trans = min(1.0\_real64, exp(log\_prob\_n))}
\DoxyCodeLine{374 }
\DoxyCodeLine{375                 \textcolor{comment}{! Generate sample from uniform distribution }}
\DoxyCodeLine{376                 \textcolor{keyword}{call }ran1(unif\_num, seed)}
\DoxyCodeLine{377             }
\DoxyCodeLine{378                 \textcolor{comment}{! Compare the drawn sample from the uniform distribution with the acceptance ratio }}
\DoxyCodeLine{379                 \textcolor{keywordflow}{if} (a\_prob\_trans >= unif\_num) \textcolor{keywordflow}{then} }
\DoxyCodeLine{380                     \textcolor{comment}{! If accepted add proposed position to the MCMC chain}}
\DoxyCodeLine{381                     x(i) = x\_n(1) }
\DoxyCodeLine{382 }
\DoxyCodeLine{383                     \textcolor{comment}{! To determine whether this point should be added to the burnt and thinned MCMC chain}}
\DoxyCodeLine{384                     \textcolor{keywordflow}{if} (thin\_counter == thin) \textcolor{keywordflow}{then}}
\DoxyCodeLine{385                         \textcolor{comment}{! Increment the reset counter }}
\DoxyCodeLine{386                         reset\_counter = 1 + reset\_counter}
\DoxyCodeLine{387                         \textcolor{comment}{! Precalculate i\_bt for shorthand}}
\DoxyCodeLine{388                         i\_bt = i -\/ burn -\/ (reset\_counter * (thin -\/ 1))}
\DoxyCodeLine{389                         \textcolor{comment}{! Add to the burn and thinned MCMC chain}}
\DoxyCodeLine{390                         x\_burnt(i\_bt) = x\_n(1)}
\DoxyCodeLine{391                         \textcolor{comment}{! Calculate the local energy at this point }}
\DoxyCodeLine{392                         energy\_chain(i\_bt) = qho\_energy(alpha\_const, x\_n\textcolor{comment}{(1))}}
\DoxyCodeLine{393 \textcolor{comment}{}                        \textcolor{comment}{! Resetting the thin counter }}
\DoxyCodeLine{394                         thin\_counter = 0}
\DoxyCodeLine{395 }
\DoxyCodeLine{396                         acceptance = \textcolor{stringliteral}{'Y'}}
\DoxyCodeLine{397                         \textcolor{comment}{! Increment the number of accepted steps }}
\DoxyCodeLine{398                         accept = 1 + accept }
\DoxyCodeLine{399 }
\DoxyCodeLine{400                         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{401                             \textcolor{keywordflow}{if} (mod(i\_bt, re\_size/logfrac) .le. 1e-\/6\_real64\textcolor{comment}{) }\textcolor{keywordflow}{then}}
\DoxyCodeLine{402                                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.6, '     ', A1)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{403 \textcolor{comment}{}                                    (i\_bt), x\_burnt(i\_bt), energy\_chain(i\_bt\textcolor{comment}{), acceptance}}
\DoxyCodeLine{404 \textcolor{comment}{}\textcolor{keywordflow}{                            end if}}
\DoxyCodeLine{405 \textcolor{keywordflow}{                        end if}}
\DoxyCodeLine{406 \textcolor{keywordflow}{                    end if} }
\DoxyCodeLine{407                 \textcolor{keywordflow}{else} }
\DoxyCodeLine{408                     \textcolor{comment}{! If rejected the proposed step is the current step}}
\DoxyCodeLine{409                     x(i) = x(i-\/1)}
\DoxyCodeLine{410 }
\DoxyCodeLine{411                     \textcolor{comment}{! To determine whether this point should be added to the burnt and thinned MCMC chain }}
\DoxyCodeLine{412                     \textcolor{keywordflow}{if} ((i > (burn + 1)) .and. (thin\_counter == thin)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{413                         \textcolor{comment}{! Increment the reset counter }}
\DoxyCodeLine{414                         reset\_counter = 1 + reset\_counter}
\DoxyCodeLine{415                         \textcolor{comment}{! Precalculate i\_bt for shorthand}}
\DoxyCodeLine{416                         i\_bt = i -\/ burn -\/ (reset\_counter * (thin -\/ 1))}
\DoxyCodeLine{417                         \textcolor{comment}{! Add to the burn and thinned MCMC chain}}
\DoxyCodeLine{418                         x\_burnt(i\_bt) = x(i-\/1)}
\DoxyCodeLine{419                         \textcolor{comment}{! Calculate the local energy at this point}}
\DoxyCodeLine{420                         energy\_chain(i\_bt) = qho\_energy(alpha\_const, x(i\textcolor{comment}{-\/1))}}
\DoxyCodeLine{421 \textcolor{comment}{}                        \textcolor{comment}{! Reseting the thin counter }}
\DoxyCodeLine{422                         thin\_counter = 0 }
\DoxyCodeLine{423 }
\DoxyCodeLine{424                         acceptance = \textcolor{stringliteral}{'N'}}
\DoxyCodeLine{425 }
\DoxyCodeLine{426                         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{427                             \textcolor{keywordflow}{if} (mod(i\_bt, re\_size/logfrac) .le. 1e-\/6\_real64\textcolor{comment}{) }\textcolor{keywordflow}{then}}
\DoxyCodeLine{428                                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.6, '     ', A1)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{429 \textcolor{comment}{}                                    (i\_bt), x\_burnt(i\_bt), energy\_chain(i\_bt\textcolor{comment}{), acceptance}}
\DoxyCodeLine{430 \textcolor{comment}{}\textcolor{keywordflow}{                            end if}}
\DoxyCodeLine{431 \textcolor{keywordflow}{                        end if}}
\DoxyCodeLine{432 }
\DoxyCodeLine{433 \textcolor{keywordflow}{                    end if} }
\DoxyCodeLine{434 \textcolor{keywordflow}{                end if} }
\DoxyCodeLine{435 }
\DoxyCodeLine{436 \textcolor{keywordflow}{            end do} }
\DoxyCodeLine{437         \textcolor{comment}{! Loop to advance the chain to the final burn step and not save any of the outputs}}
\DoxyCodeLine{438         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (burn >= 2) \textcolor{keywordflow}{then}}
\DoxyCodeLine{439             \textcolor{keywordflow}{do} i = 2, burn}
\DoxyCodeLine{440                 \textcolor{comment}{! Propose the next step}}
\DoxyCodeLine{441                 \textcolor{keyword}{call }random\_normal(1, sample\_normal)}
\DoxyCodeLine{442                 x\_n = x(i-\/1) + sigma * sample\_normal}
\DoxyCodeLine{443                 \textcolor{comment}{! Calculate the transition probability between proposed step and current step}}
\DoxyCodeLine{444                 log\_prob\_n = log(qho\_prob(alpha\_const, x(i-\/1), x\_n(1)))}
\DoxyCodeLine{445                 \textcolor{comment}{! Calculate the acceptance ratio}}
\DoxyCodeLine{446                 a\_prob\_trans = min(1.0\_real64, exp(log\_prob\_n))}
\DoxyCodeLine{447                 \textcolor{comment}{! Generate sample from uniform distribution }}
\DoxyCodeLine{448                 \textcolor{keyword}{call }ran1(unif\_num, seed)}
\DoxyCodeLine{449             }
\DoxyCodeLine{450                 \textcolor{comment}{! Compare the drawn sample from the uniform distribution with the acceptance ratio }}
\DoxyCodeLine{451                 \textcolor{keywordflow}{if} (a\_prob\_trans >= unif\_num) \textcolor{keywordflow}{then} }
\DoxyCodeLine{452                     \textcolor{comment}{! If accepted add proposed position to the MCMC chain}}
\DoxyCodeLine{453                     x(i) = x\_n(1) }
\DoxyCodeLine{454                 \textcolor{keywordflow}{else} }
\DoxyCodeLine{455                     \textcolor{comment}{! If rejected the proposed step is the current step}}
\DoxyCodeLine{456                     x(i) = x(i-\/1)}
\DoxyCodeLine{457 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{458 \textcolor{keywordflow}{            end do} }
\DoxyCodeLine{459 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{460        }
\DoxyCodeLine{461         \textcolor{comment}{! Metropolis Algorithm to calculate the burnt and thinned MCMC chain }}
\DoxyCodeLine{462         \textcolor{keywordflow}{if} (burn >=1) \textcolor{keywordflow}{then} }
\DoxyCodeLine{463             \textcolor{keywordflow}{do} i = burn + 1, n+1 }
\DoxyCodeLine{464                 \textcolor{comment}{! Add one to the thin counter }}
\DoxyCodeLine{465                 thin\_counter = 1 + thin\_counter           }
\DoxyCodeLine{466                 \textcolor{comment}{! Propose the next step}}
\DoxyCodeLine{467                 \textcolor{keyword}{call }random\_normal(1, sample\_normal)}
\DoxyCodeLine{468                 x\_n = x(i-\/1) + sigma * sample\_normal}
\DoxyCodeLine{469 }
\DoxyCodeLine{470                 \textcolor{comment}{! Calculate the transition probability between proposed step and current step}}
\DoxyCodeLine{471                 log\_prob\_n = log(qho\_prob(alpha\_const, x(i-\/1), x\_n(1)))}
\DoxyCodeLine{472             }
\DoxyCodeLine{473                 \textcolor{comment}{! Calculate the acceptance ratio}}
\DoxyCodeLine{474                 a\_prob\_trans = min(1.0\_real64, exp(log\_prob\_n))}
\DoxyCodeLine{475 }
\DoxyCodeLine{476                 \textcolor{comment}{! Generate sample from uniform distribution }}
\DoxyCodeLine{477                 \textcolor{keyword}{call }ran1(unif\_num, seed)}
\DoxyCodeLine{478             }
\DoxyCodeLine{479                 \textcolor{comment}{! Compare the drawn sample from the uniform distribution with the acceptance ratio }}
\DoxyCodeLine{480                 \textcolor{keywordflow}{if} (a\_prob\_trans >= unif\_num) \textcolor{keywordflow}{then} }
\DoxyCodeLine{481                     \textcolor{comment}{! If accepted add proposed position to the MCMC chain}}
\DoxyCodeLine{482                     x(i) = x\_n(1) }
\DoxyCodeLine{483 }
\DoxyCodeLine{484                     \textcolor{comment}{! To determine whether this point should be added to the burnt and thinned MCMC chain}}
\DoxyCodeLine{485                     \textcolor{keywordflow}{if} ((i > (burn + 1)) .and. (thin\_counter == thin)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{486                         \textcolor{comment}{! Increment the reset counter }}
\DoxyCodeLine{487                         reset\_counter = 1 + reset\_counter}
\DoxyCodeLine{488                         \textcolor{comment}{! Precalculate i\_bt for shorthand}}
\DoxyCodeLine{489                         i\_bt = i -\/ burn -\/ (reset\_counter * (thin -\/ 1))}
\DoxyCodeLine{490                         \textcolor{comment}{! Add to the burn and thinned MCMC chain}}
\DoxyCodeLine{491                         x\_burnt(i\_bt) = x\_n(1)}
\DoxyCodeLine{492                         \textcolor{comment}{! Calculate the local energy at this point }}
\DoxyCodeLine{493                         energy\_chain(i\_bt) = qho\_energy(alpha\_const, x\_n\textcolor{comment}{(1))}}
\DoxyCodeLine{494 \textcolor{comment}{}                        \textcolor{comment}{! Resetting the thin counter }}
\DoxyCodeLine{495                         thin\_counter = 0}
\DoxyCodeLine{496 }
\DoxyCodeLine{497                         acceptance = \textcolor{stringliteral}{'Y'}}
\DoxyCodeLine{498                         \textcolor{comment}{! Increment the number of accepted steps }}
\DoxyCodeLine{499                         accept = 1 + accept }
\DoxyCodeLine{500 }
\DoxyCodeLine{501                         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{502                             \textcolor{keywordflow}{if} (mod(i\_bt, re\_size/logfrac) .le. 1e-\/6\_real64\textcolor{comment}{) }\textcolor{keywordflow}{then}}
\DoxyCodeLine{503                                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.6, '     ', A1)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{504 \textcolor{comment}{}                                    (i\_bt), x\_burnt(i\_bt), energy\_chain(i\_bt\textcolor{comment}{), acceptance}}
\DoxyCodeLine{505 \textcolor{comment}{}\textcolor{keywordflow}{                            end if}}
\DoxyCodeLine{506 \textcolor{keywordflow}{                        end if}}
\DoxyCodeLine{507 }
\DoxyCodeLine{508 \textcolor{keywordflow}{                    end if} }
\DoxyCodeLine{509 }
\DoxyCodeLine{510                 \textcolor{keywordflow}{else} }
\DoxyCodeLine{511                     \textcolor{comment}{! If rejected the proposed step is the current step}}
\DoxyCodeLine{512                     x(i) = x(i-\/1)}
\DoxyCodeLine{513 }
\DoxyCodeLine{514                     \textcolor{comment}{! To determine whether this point should be added to the burnt and thinned MCMC chain }}
\DoxyCodeLine{515                     \textcolor{keywordflow}{if} ((i > (burn + 1)) .and. (thin\_counter == thin)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{516                         \textcolor{comment}{! Increment the reset counter }}
\DoxyCodeLine{517                         reset\_counter = 1 + reset\_counter}
\DoxyCodeLine{518                         \textcolor{comment}{! Precalculate i\_bt for shorthand}}
\DoxyCodeLine{519                         i\_bt = i -\/ burn -\/ (reset\_counter * (thin -\/ 1))}
\DoxyCodeLine{520                         \textcolor{comment}{! Add to the burn and thinned MCMC chain}}
\DoxyCodeLine{521                         x\_burnt(i\_bt) = x(i-\/1)}
\DoxyCodeLine{522                         \textcolor{comment}{! Calculate the local energy at this point}}
\DoxyCodeLine{523                         energy\_chain(i\_bt) = qho\_energy(alpha\_const, x(i\textcolor{comment}{-\/1))}}
\DoxyCodeLine{524 \textcolor{comment}{}                        \textcolor{comment}{! Reseting the thin counter }}
\DoxyCodeLine{525                         thin\_counter = 0 }
\DoxyCodeLine{526 }
\DoxyCodeLine{527                         acceptance = \textcolor{stringliteral}{'N'}}
\DoxyCodeLine{528 }
\DoxyCodeLine{529                         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{530                             \textcolor{keywordflow}{if} (mod(i\_bt, re\_size/logfrac) .le. 1e-\/6\_real64\textcolor{comment}{) }\textcolor{keywordflow}{then}}
\DoxyCodeLine{531                                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.6, '     ', A1)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{532 \textcolor{comment}{}                                    (i\_bt), x\_burnt(i\_bt), energy\_chain(i\_bt\textcolor{comment}{), acceptance}}
\DoxyCodeLine{533 \textcolor{comment}{}\textcolor{keywordflow}{                            end if}}
\DoxyCodeLine{534 \textcolor{keywordflow}{                        end if}}
\DoxyCodeLine{535 }
\DoxyCodeLine{536 \textcolor{keywordflow}{                    end if} }
\DoxyCodeLine{537 \textcolor{keywordflow}{                end if} }
\DoxyCodeLine{538 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{539 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{540 }
\DoxyCodeLine{541         \textcolor{comment}{! Calculate the acceptance ratio }}
\DoxyCodeLine{542         accept\_rate = (real(accept, kind=real64) / real(re\_size, kind=real64\textcolor{comment}{))}}
\DoxyCodeLine{543 \textcolor{comment}{}}
\DoxyCodeLine{544         \textcolor{comment}{! Calculate the mean energy and the variance in the energy}}
\DoxyCodeLine{545         energy\_mean = sum(energy\_chain) / real(re\_size, kind=real64)}
\DoxyCodeLine{546         energy\_variance = 0.0\_real64}
\DoxyCodeLine{547         \textcolor{keywordflow}{do} i = 1, re\_size}
\DoxyCodeLine{548             energy\_variance = energy\_variance + ((1.0\_real64 / real(re\_size\textcolor{comment}{ -\/ 1, kind=real64)) * \&}}
\DoxyCodeLine{549 \textcolor{comment}{}            (energy\_chain(i) -\/ energy\_mean) * (energy\_chain(i) -\/ energy\_mean\textcolor{comment}{)) }}
\DoxyCodeLine{550 \textcolor{comment}{}\textcolor{keywordflow}{        end do}}
\DoxyCodeLine{551         energy\_variance = (1.0\_real64 / real(re\_size, kind=real64)) * energy\_variance}
\DoxyCodeLine{552 }
\DoxyCodeLine{553         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{554             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Local energy = ', F12.8)"{}}) energy\_mean}
\DoxyCodeLine{555             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Variance = ', F12.8)"{}}) energy\_variance}
\DoxyCodeLine{556             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Acceptance rate = ', F12.8)"{}}) accept\_rate}
\DoxyCodeLine{557             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{558 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{559 }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a05315751002a983c9976851c9f21f0f0_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a05315751002a983c9976851c9f21f0f0_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_a726aff689b64924586b655d2e8a846d1}\label{namespacevqmc_a726aff689b64924586b655d2e8a846d1}} 
\index{vqmc@{vqmc}!grid\_qho@{grid\_qho}}
\index{grid\_qho@{grid\_qho}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{grid\_qho()}{grid\_qho()}}
{\footnotesize\ttfamily subroutine vqmc\+::grid\+\_\+qho (\begin{DoxyParamCaption}\item[{real(real64), dimension(\+:), intent(in)}]{alpha\+\_\+array,  }\item[{real(real64), dimension(\+:), intent(inout)}]{energies,  }\item[{real(real64), dimension(\+:), intent(inout)}]{acc\+\_\+rates,  }\item[{real(real64), dimension(\+:), intent(inout)}]{variances }\end{DoxyParamCaption})}



Performs VQMC on an array of values for the variational parameter $ \alpha $. 

Evaluates energy of the QHO trial wavefunction at each value of the parameter $ \alpha $ in {\bfseries{alpha\+\_\+array}}. Also evaluates variances in these energies as a measure of uncertainty. Writes these results to a Net\+CDF file. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em alpha\+\_\+array} & The array of alpha values to obtain energies for \\
\hline
\mbox{\texttt{ in,out}}  & {\em energies} & Array of size({\bfseries{alpha\+\_\+array}}) to contain total energies \\
\hline
\mbox{\texttt{ in,out}}  & {\em acc\+\_\+rates} & Array of size({\bfseries{alpha\+\_\+array}}) to contain acceptance rates \\
\hline
\mbox{\texttt{ in,out}}  & {\em variances} & Array of size({\bfseries{alpha\+\_\+array}}) to contain variances \\
\hline
\end{DoxyParams}


Definition at line 579 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{580 }
\DoxyCodeLine{581         \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{582 }
\DoxyCodeLine{583 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{intent(in)} :: alpha\_array}
\DoxyCodeLine{584 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{intent(inout)} :: energies}
\DoxyCodeLine{585 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{intent(inout)} :: acc\_rates}
\DoxyCodeLine{586 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{intent(inout)} :: variances}
\DoxyCodeLine{587 }
\DoxyCodeLine{588 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energy\_chain, trimmed\_energy\_chain}
\DoxyCodeLine{589 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: pos\_chain, trimmed\_pos\_chain}
\DoxyCodeLine{590 \textcolor{keywordtype}{        real}(real64) :: accept\_rate}
\DoxyCodeLine{591 \textcolor{keywordtype}{        real}(real64) :: energy\_mean}
\DoxyCodeLine{592 \textcolor{keywordtype}{        real}(real64) :: energy\_variance}
\DoxyCodeLine{593         \textcolor{keywordtype}{integer} :: i, ierr}
\DoxyCodeLine{594         \textcolor{keywordtype}{character(len=3)} :: str\_i}
\DoxyCodeLine{595         \textcolor{keywordtype}{character(len=40)} :: chainfile}
\DoxyCodeLine{596 }
\DoxyCodeLine{597         \textcolor{comment}{! MPI variables}}
\DoxyCodeLine{598 \textcolor{keywordtype}{        real}(real64)    :: my\_ensum}
\DoxyCodeLine{599 }
\DoxyCodeLine{600         \textcolor{comment}{! Set up printed output for the loop, from rank 0.}}
\DoxyCodeLine{601         \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{602             \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Begin VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{603 \textcolor{comment}{}            \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Alpha       Energy            Acceptance Rate')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{604 \textcolor{comment}{}            \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{605                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Begin VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{606 \textcolor{comment}{}                \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keywordflow}{then}}
\DoxyCodeLine{607                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{608                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Logging the chains from Rank 0.')"{}})}
\DoxyCodeLine{609                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{610 \textcolor{keywordflow}{                endif} }
\DoxyCodeLine{611 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{612 \textcolor{keywordflow}{        endif} }
\DoxyCodeLine{613 }
\DoxyCodeLine{614         \textcolor{comment}{! Loop over values of alpha}}
\DoxyCodeLine{615         \textcolor{keywordflow}{do} i = alpha\_start, \textcolor{keyword}{size}(alpha\_array)}
\DoxyCodeLine{616 }
\DoxyCodeLine{617             \textcolor{comment}{! Calculate energy at current value of alpha}}
\DoxyCodeLine{618             \textcolor{keyword}{call }vqmc\_qho(qho\%sigma, my\_steps+qho\%burn\_step, qho\%burn\_step\textcolor{comment}{, qho\%thin\_step, \&}}
\DoxyCodeLine{619 \textcolor{comment}{}                alpha\_array(i), pos\_chain, accept\_rate, energy\_chain, energy\_mean\textcolor{comment}{, \&}}
\DoxyCodeLine{620 \textcolor{comment}{}                energy\_variance)}
\DoxyCodeLine{621             }
\DoxyCodeLine{622             \textcolor{comment}{! Save energy -\/ serial version}}
\DoxyCodeLine{623             \textcolor{comment}{!energies(i) = energy\_mean}}
\DoxyCodeLine{624             \textcolor{comment}{!variances(i) = energy\_variance}}
\DoxyCodeLine{625             \textcolor{comment}{!acc\_rates(i) = accept\_rate}}
\DoxyCodeLine{626             \textcolor{comment}{!write(*, "{}(F7.4, '     ', F12.8, '      ', F12.8)"{}) alpha\_array(i), \&}}
\DoxyCodeLine{627             \textcolor{comment}{!    energy\_mean, accept\_rate}}
\DoxyCodeLine{628 }
\DoxyCodeLine{629             \textcolor{comment}{! Sum energy sums across ranks and save to rank 0 }}
\DoxyCodeLine{630             my\_ensum = sum(energy\_chain)}
\DoxyCodeLine{631             \textcolor{keyword}{call }mpi\_reduce(my\_ensum,energies(i),1,mpi\_double\_precision,mpi\_sum\textcolor{comment}{,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{632 \textcolor{comment}{}}
\DoxyCodeLine{633             \textcolor{comment}{! Sum accept rates across ranks, to find average in rank 0}}
\DoxyCodeLine{634             \textcolor{keyword}{call }mpi\_reduce(accept\_rate,acc\_rates(i),1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{635 \textcolor{comment}{}}
\DoxyCodeLine{636             \textcolor{comment}{! Sum variances acros ranks, to find average in rank 0}}
\DoxyCodeLine{637             \textcolor{keyword}{call }mpi\_reduce(energy\_variance,variances(i),1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{638 \textcolor{comment}{}}
\DoxyCodeLine{639             \textcolor{comment}{! Print results from all ranks for checking}}
\DoxyCodeLine{640             \textcolor{comment}{!write(*, "{}(F7.4, '     ', F12.8, '      ', F12.8, '      ', F12.8, '      ', I4)"{}) alpha\_array(i), \&}}
\DoxyCodeLine{641             \textcolor{comment}{!    energy\_mean, accept\_rate, energy\_variance, my\_rank}}
\DoxyCodeLine{642 }
\DoxyCodeLine{643             \textcolor{comment}{! Compute and print combined results in rank 0}}
\DoxyCodeLine{644             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{645                 \textcolor{comment}{!print*, 'tot\_ensum=',tot\_ensum,' ,tot\_size=',tot\_size}}
\DoxyCodeLine{646                 energies(i) = energies(i) * per\_step}
\DoxyCodeLine{647                 acc\_rates(i) = acc\_rates(i) * per\_proc}
\DoxyCodeLine{648                 variances(i) = variances(i) * per\_proc \textcolor{comment}{! CHECK FORMULA!}}
\DoxyCodeLine{649                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(F7.4, '     ', F12.8, '      ', F12.8)"{}}) alpha\_array\textcolor{comment}{(i), \&}}
\DoxyCodeLine{650 \textcolor{comment}{}                    energies(i), acc\_rates(i)}
\DoxyCodeLine{651 }
\DoxyCodeLine{652                 \textcolor{comment}{! Write energy chain from rank 0, if required}}
\DoxyCodeLine{653                 \textcolor{keywordflow}{if} (write\_chains) \textcolor{keywordflow}{then}}
\DoxyCodeLine{654 }
\DoxyCodeLine{655                     \textcolor{comment}{! Setup filename}}
\DoxyCodeLine{656                     \textcolor{keyword}{write}(str\_i, \textcolor{stringliteral}{"{}(I3)"{}}) i}
\DoxyCodeLine{657                     \textcolor{keyword}{write}(chainfile, \textcolor{stringliteral}{"{}(3A)"{}}) \textcolor{stringliteral}{'./chains\_out/alpha\_'}, trim\textcolor{comment}{(adjustl(str\_i)), }\textcolor{stringliteral}{'.nc'}}
\DoxyCodeLine{658 }
\DoxyCodeLine{659                     \textcolor{comment}{! Check chain length}}
\DoxyCodeLine{660                     \textcolor{keywordflow}{if} (\textcolor{keyword}{size}(energy\_chain) < max\_chain\_len) \textcolor{keywordflow}{then}}
\DoxyCodeLine{661                         \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Writing Markov chain to from rank 0 to'}\textcolor{comment}{, chainfile}}
\DoxyCodeLine{662 \textcolor{comment}{}                        \textcolor{keyword}{call }write\_qho\_equilibration(pos\_chain, energy\_chain\textcolor{comment}{, chainfile, ierr, \&}}
\DoxyCodeLine{663 \textcolor{comment}{}                            qho, accept\_rate, alpha\_array(i))}
\DoxyCodeLine{664                     \textcolor{keywordflow}{else}}
\DoxyCodeLine{665                         \textcolor{comment}{! Adjust chain length for writing.}}
\DoxyCodeLine{666                         \textcolor{comment}{! Allocate temporary arrays}}
\DoxyCodeLine{667                         \textcolor{keyword}{allocate}(trimmed\_pos\_chain(max\_chain\_len))}
\DoxyCodeLine{668                         \textcolor{keyword}{allocate}(trimmed\_energy\_chain(max\_chain\_len))}
\DoxyCodeLine{669                         \textcolor{comment}{! Fill in the temporary arrays}}
\DoxyCodeLine{670                         trimmed\_pos\_chain(:) = pos\_chain(1:max\_chain\_len\textcolor{comment}{)}}
\DoxyCodeLine{671 \textcolor{comment}{}                        trimmed\_energy\_chain(:) = energy\_chain(1:max\_chain\_len\textcolor{comment}{)}}
\DoxyCodeLine{672 \textcolor{comment}{}                        \textcolor{comment}{! Write the trimmed temporary arrays}}
\DoxyCodeLine{673                         \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Writing trimmed Markov chain to from rank 0 to'}\textcolor{comment}{, chainfile}}
\DoxyCodeLine{674 \textcolor{comment}{}                        \textcolor{keyword}{call }write\_qho\_equilibration(trimmed\_pos\_chain, trimmed\_energy\_chain\textcolor{comment}{, chainfile, ierr, \&}}
\DoxyCodeLine{675 \textcolor{comment}{}                            qho, accept\_rate, alpha\_array(i))}
\DoxyCodeLine{676                         \textcolor{comment}{! Deallocate the temporary arrays}}
\DoxyCodeLine{677                         \textcolor{keyword}{deallocate}(trimmed\_pos\_chain)}
\DoxyCodeLine{678                         \textcolor{keyword}{deallocate}(trimmed\_energy\_chain)}
\DoxyCodeLine{679 \textcolor{keywordflow}{                    endif}}
\DoxyCodeLine{680 \textcolor{keywordflow}{                end if}}
\DoxyCodeLine{681 }
\DoxyCodeLine{682                 \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{683                 \textcolor{keywordflow}{if} (write\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{684                     \textcolor{keywordflow}{if} (mod(i,restart\_num)==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{685                         \textcolor{comment}{! Write res\_nml.txt}}
\DoxyCodeLine{686                         \textcolor{keyword}{call }write\_res\_nml(i+1)}
\DoxyCodeLine{687                         \textcolor{comment}{! Store energy, variance \& accept\_rate arrays}}
\DoxyCodeLine{688                         \textcolor{keyword}{call }write\_qho\_main(alpha\_array, energies, variances\textcolor{comment}{, resfile\_etot, ierr, qho, acc\_rates)}}
\DoxyCodeLine{689 \textcolor{comment}{}\textcolor{keywordflow}{                    endif}}
\DoxyCodeLine{690 \textcolor{keywordflow}{                endif}}
\DoxyCodeLine{691 }
\DoxyCodeLine{692 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{693 }
\DoxyCodeLine{694 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{695 }
\DoxyCodeLine{696         \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{697 }
\DoxyCodeLine{698             \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/  End VQMC Runs  -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{699 \textcolor{comment}{}            \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{700                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/  End VQMC Runs  -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{701 \textcolor{comment}{}                \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Results:')"{}})}
\DoxyCodeLine{702                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('alpha            Energy')"{}})}
\DoxyCodeLine{703                 \textcolor{keywordflow}{do} i = 1, \textcolor{keyword}{size}(alpha\_array)}
\DoxyCodeLine{704                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(F12.8, '    ', F12.8)"{}}) alpha\_array(i\textcolor{comment}{), energies(i)}}
\DoxyCodeLine{705 \textcolor{comment}{}\textcolor{keywordflow}{                end do}}
\DoxyCodeLine{706                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{707                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Min Energy = ', F12.8, ' at c = ', F12.8)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{708 \textcolor{comment}{}                    minval(energies), alpha\_array(minloc(energies, 1))}
\DoxyCodeLine{709                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{710 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{711 }
\DoxyCodeLine{712             \textcolor{comment}{! Write main results file.}}
\DoxyCodeLine{713             \textcolor{keyword}{write}(*, *) \textcolor{stringliteral}{'Calculations finished, writing results to NetCDF output file '}\textcolor{comment}{, \&}}
\DoxyCodeLine{714 \textcolor{comment}{}                        outfile}
\DoxyCodeLine{715             \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{716                 \textcolor{keyword}{write}(logid, *) \textcolor{stringliteral}{'Calculations finished, writing results to NetCDF \&}}
\DoxyCodeLine{717 \textcolor{stringliteral}{}\textcolor{stringliteral}{                    \&output file '}, outfile}
\DoxyCodeLine{718 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{719             \textcolor{keyword}{call }write\_qho\_main(alpha\_array, energies, variances, outfile\textcolor{comment}{, ierr, qho, acc\_rates)}}
\DoxyCodeLine{720 \textcolor{comment}{}}
\DoxyCodeLine{721 \textcolor{keywordflow}{        endif} }
\DoxyCodeLine{722 }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a726aff689b64924586b655d2e8a846d1_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=313pt]{namespacevqmc_a726aff689b64924586b655d2e8a846d1_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_a5d73324fcbe9c3ef7fe11309581af529}\label{namespacevqmc_a5d73324fcbe9c3ef7fe11309581af529}} 
\index{vqmc@{vqmc}!equil\_qho@{equil\_qho}}
\index{equil\_qho@{equil\_qho}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{equil\_qho()}{equil\_qho()}}
{\footnotesize\ttfamily subroutine vqmc\+::equil\+\_\+qho (\begin{DoxyParamCaption}\item[{real(real64), dimension(\+:), intent(in)}]{alpha\+\_\+array }\end{DoxyParamCaption})}



Performs VQMC on an array of values for the variational parameter $ \alpha $, outputting energy traces for each. 

Generates VQMC position and energy traces of the QHO trial wavefunction at each value of the parameter $ \alpha $ in {\bfseries{alpha\+\_\+array}}. Outputs each of these traces to a separate Net\+CDF file, to be used in determining optimal burning/thinning paramters for an accurate full VQMC run. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em alpha\+\_\+array} & The array of alpha values to obtain energies for \\
\hline
\mbox{\texttt{ in,out}}  & {\em energies} & The energies \\
\hline
\end{DoxyParams}


Definition at line 742 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{743 }
\DoxyCodeLine{744         \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{745 }
\DoxyCodeLine{746 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{intent(in)}    :: alpha\_array}
\DoxyCodeLine{747 }
\DoxyCodeLine{748 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energy\_chain}
\DoxyCodeLine{749 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: pos\_chain}
\DoxyCodeLine{750 \textcolor{keywordtype}{        real}(real64) :: energy}
\DoxyCodeLine{751 \textcolor{keywordtype}{        real}(real64) :: accept\_rate}
\DoxyCodeLine{752 \textcolor{keywordtype}{        real}(real64) :: variance}
\DoxyCodeLine{753         \textcolor{keywordtype}{integer} :: i, ierr}
\DoxyCodeLine{754         \textcolor{keywordtype}{character(len=3)} :: str\_i}
\DoxyCodeLine{755         \textcolor{keywordtype}{character(len=40)} :: equilfile}
\DoxyCodeLine{756 }
\DoxyCodeLine{757         \textcolor{comment}{! Set up printed output for the loop.}}
\DoxyCodeLine{758         \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Begin VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{759         \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Alpha       Energy            Acceptance Rate')"{}})}
\DoxyCodeLine{760         \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{761             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Begin VQMC Runs -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{762 \textcolor{comment}{}\textcolor{keywordflow}{        end if} }
\DoxyCodeLine{763 }
\DoxyCodeLine{764         \textcolor{comment}{! Loop over values of alpha}}
\DoxyCodeLine{765         \textcolor{keywordflow}{do} i = alpha\_start, \textcolor{keyword}{size}(alpha\_array)}
\DoxyCodeLine{766 }
\DoxyCodeLine{767             \textcolor{comment}{! Calculate energy at current value of alpha}}
\DoxyCodeLine{768             \textcolor{keyword}{call }vqmc\_qho(qho\%sigma,qho\%steps, qho\%burn\_step, qho\%thin\_step\textcolor{comment}{, \&}}
\DoxyCodeLine{769 \textcolor{comment}{}                alpha\_array(i), pos\_chain, accept\_rate, energy\_chain, energy\textcolor{comment}{, \&}}
\DoxyCodeLine{770 \textcolor{comment}{}                variance)}
\DoxyCodeLine{771 }
\DoxyCodeLine{772             \textcolor{comment}{! Report the energy }}
\DoxyCodeLine{773             \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(F7.4, '     ', F12.8, '      ', F12.8)"{}}) alpha\_array\textcolor{comment}{(i), \&}}
\DoxyCodeLine{774 \textcolor{comment}{}            energy, accept\_rate}
\DoxyCodeLine{775             \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{776                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{777                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Results:')"{}})}
\DoxyCodeLine{778                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('alpha = ', F12.8, ', Energy = ', F12.8)"{}}\textcolor{comment}{) alpha\_array(i), energy}}
\DoxyCodeLine{779 \textcolor{comment}{}                \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{780 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{781         }
\DoxyCodeLine{782             \textcolor{comment}{! Save the energy trace for each value of alpha.}}
\DoxyCodeLine{783             \textcolor{keyword}{write}(str\_i, \textcolor{stringliteral}{"{}(I3)"{}}) i}
\DoxyCodeLine{784             \textcolor{keyword}{write}(equilfile, \textcolor{stringliteral}{"{}(3A)"{}}) \textcolor{stringliteral}{'./equil\_out/alpha\_'}, trim(adjustl(str\_i\textcolor{comment}{)),}\textcolor{stringliteral}{'.nc'}}
\DoxyCodeLine{785             \textcolor{keyword}{write}(*, *) \textcolor{stringliteral}{'Writing equilibration outfile to '}, equilfile}
\DoxyCodeLine{786             \textcolor{keyword}{call }write\_qho\_equilibration(pos\_chain, energy\_chain, equilfile\textcolor{comment}{, ierr, qho, \&}}
\DoxyCodeLine{787 \textcolor{comment}{}                accept\_rate, alpha\_array(i))}
\DoxyCodeLine{788 }
\DoxyCodeLine{789             \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{790             \textcolor{keywordflow}{if} (write\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{791                 \textcolor{keywordflow}{if} (mod(i,restart\_num)==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{792                     \textcolor{comment}{! Write res\_nml.txt}}
\DoxyCodeLine{793                     \textcolor{keyword}{call }write\_res\_nml(i+1)}
\DoxyCodeLine{794 \textcolor{keywordflow}{                endif}}
\DoxyCodeLine{795 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{796 }
\DoxyCodeLine{797 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{798 }
\DoxyCodeLine{799         \textcolor{comment}{! Closing print statements}}
\DoxyCodeLine{800 }
\DoxyCodeLine{801         \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/  End VQMC Runs  -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}})}
\DoxyCodeLine{802         \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{803             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/  End VQMC Runs  -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{804 \textcolor{comment}{}\textcolor{keywordflow}{        end if}}
\DoxyCodeLine{805 }
\DoxyCodeLine{806         \textcolor{comment}{!if (write\_log) then}}
\DoxyCodeLine{807         \textcolor{comment}{!    write(logid, "{}('Results:')"{})}}
\DoxyCodeLine{808         \textcolor{comment}{!     write(logid, "{}('alpha            Energy')"{})}}
\DoxyCodeLine{809         \textcolor{comment}{!    do i = 1, size(alpha\_array)}}
\DoxyCodeLine{810         \textcolor{comment}{!        write(logid, "{}(F12.8, '    ', F12.8)"{}) alpha\_array(i), energies(i)}}
\DoxyCodeLine{811         \textcolor{comment}{!    end do}}
\DoxyCodeLine{812         \textcolor{comment}{!    write(logid, "{}('')"{})}}
\DoxyCodeLine{813         \textcolor{comment}{!end if}}
\DoxyCodeLine{814     }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a5d73324fcbe9c3ef7fe11309581af529_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=317pt]{namespacevqmc_a5d73324fcbe9c3ef7fe11309581af529_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_a8213f95bb390d7a9eff8260f527c00b8}\label{namespacevqmc_a8213f95bb390d7a9eff8260f527c00b8}} 
\index{vqmc@{vqmc}!vqmc\_h\_2\_plus@{vqmc\_h\_2\_plus}}
\index{vqmc\_h\_2\_plus@{vqmc\_h\_2\_plus}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{vqmc\_h\_2\_plus()}{vqmc\_h\_2\_plus()}}
{\footnotesize\ttfamily subroutine vqmc\+::vqmc\+\_\+h\+\_\+2\+\_\+plus (\begin{DoxyParamCaption}\item[{real(real64), intent(in)}]{sigma,  }\item[{integer, intent(in)}]{N,  }\item[{integer, intent(in)}]{burn,  }\item[{integer, intent(in)}]{thin,  }\item[{real(real64), intent(in)}]{c\+\_\+const,  }\item[{real(real64), dimension(3), intent(in)}]{R\+\_\+a,  }\item[{real(real64), dimension(3), intent(in)}]{R\+\_\+b,  }\item[{real(real64), dimension(\+:, \+:), intent(out), allocatable}]{X\+\_\+burnt,  }\item[{real(real64), intent(out)}]{accept\+\_\+rate,  }\item[{real(real64), dimension(\+:), intent(out), allocatable}]{energy\+\_\+chain,  }\item[{real(real64), intent(out)}]{energy\+\_\+mean,  }\item[{real(real64), intent(out)}]{energy\+\_\+variance,  }\item[{real(real64), dimension(\+:), intent(out), allocatable}]{Dphi\+Dc\+\_\+chain,  }\item[{real(real64), dimension(3), optional}]{x\+\_\+start }\end{DoxyParamCaption})}



Performs VQMC for the $ H_{2}^{+} $ system. ~\newline
 

Computes the total energy of a trial wavefunction by averaging over a Markov chain of local energies generated by \mbox{\hyperlink{namespacesolvers_a9cc5ffb282a9d15708307d84f6cf147f}{H\+\_\+2\+\_\+plus\+\_\+\+Energy}}, with random move acceptance/rejection probability determined by \mbox{\hyperlink{namespacesolvers_a5695d107239a7a8fb1f8b096786af028}{H\+\_\+2\+\_\+plus\+\_\+\+Prob}}. The H-\/H bond length can be changed by modifying the hydrogen atom positions {\bfseries{R\+\_\+a}} and {\bfseries{R\+\_\+b}}. Also outputs the gradient with respect to the variational parameter $ c $ at each step in the chain, to be used in \mbox{\hyperlink{namespacevqmc_a0a07ef5b098cdc478b253de26c49aadc}{Auto\+\_\+\+H\+\_\+2\+\_\+plus}}.

Allows for modification of total Markov chain length, as well as the number of steps to be \textquotesingle{}burned\textquotesingle{} while the chain is equilibrating and the interval to \textquotesingle{}thin\textquotesingle{} the chain over to reduce correlation of samples. The size of the proposed random moves can be controlled by modifying the {\bfseries{sigma}} parameter to get an ideal move acceptance rate. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em sigma} & Step size \\
\hline
\mbox{\texttt{ in}}  & {\em N} & Number of steps to take \\
\hline
\mbox{\texttt{ in}}  & {\em burn} & Number of sample to discard at the beginning \\
\hline
\mbox{\texttt{ in}}  & {\em thin} & The frequency at which we discard the samples from the MCMC chain after burning ~\newline
 \\
\hline
\mbox{\texttt{ in}}  & {\em c\+\_\+const} & Parameter(s) of trial wavefunction \\
\hline
\mbox{\texttt{ in}}  & {\em R\+\_\+a} & Position of hydrogen atom A \\
\hline
\mbox{\texttt{ in}}  & {\em R\+\_\+b} & Position of hydrogen atom B \\
\hline
\mbox{\texttt{ in}}  & {\em x\+\_\+start} & Starting point of MCMC chain (optional, default is randomly generated) \\
\hline
\mbox{\texttt{ out}}  & {\em X\+\_\+burnt} & The burnt and thinned MCMC chain for the random walker \\
\hline
\mbox{\texttt{ out}}  & {\em accept\+\_\+rate} & The acceptance rate of the MCMC chain \\
\hline
\mbox{\texttt{ out}}  & {\em energy\+\_\+chain} & An array with the local energies of the each points in the MCMC chain \\
\hline
\mbox{\texttt{ out}}  & {\em energy\+\_\+mean} & The average of the local energies recorded in {\bfseries{energy\+\_\+chain}} \\
\hline
\mbox{\texttt{ out}}  & {\em energy\+\_\+variance} & The variance of the local energies recorded in {\bfseries{energy\+\_\+chain}} \\
\hline
\mbox{\texttt{ out}}  & {\em Dphi\+Dc\+\_\+chain} & Array of the gradients with respect to $ c $ at each point in the MCMC chain \\
\hline
\end{DoxyParams}


Definition at line 857 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{860 }
\DoxyCodeLine{861         \textcolor{keywordtype}{implicit none} }
\DoxyCodeLine{862 }
\DoxyCodeLine{863 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)}, \textcolor{keywordtype}{dimension(3)} :: R\_a, R\_b}
\DoxyCodeLine{864 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: sigma}
\DoxyCodeLine{865 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: c\_const}
\DoxyCodeLine{866 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)}, \textcolor{keywordtype}{optional} :: x\_start}
\DoxyCodeLine{867         \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: N, burn, thin }
\DoxyCodeLine{868         }
\DoxyCodeLine{869          }
\DoxyCodeLine{870 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: accept\_rate, energy\_mean, energy\_variance}
\DoxyCodeLine{871 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)}, \textcolor{keywordtype}{dimension(:, :)}, \textcolor{keywordtype}{allocatable} :: X\_burnt}
\DoxyCodeLine{872 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energy\_chain}
\DoxyCodeLine{873 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: DphiDc\_chain}
\DoxyCodeLine{874 }
\DoxyCodeLine{875 \textcolor{keywordtype}{        real}(real64) :: E\_loc                               \textcolor{comment}{! Local energy at current MCMC walker position}}
\DoxyCodeLine{876 \textcolor{keywordtype}{        real}(real64) :: DphiDc                              \textcolor{comment}{! Gradient wrt c at current MCMC walker position}}
\DoxyCodeLine{877 \textcolor{keywordtype}{        real}(real64) :: log\_prob\_n                          \textcolor{comment}{! The natural logarithm of the transition proability}}
\DoxyCodeLine{878 \textcolor{keywordtype}{        real}(real64) :: a\_prob\_trans                        \textcolor{comment}{! Acceptance ratio of the transitional probability }}
\DoxyCodeLine{879 \textcolor{keywordtype}{        real}(real64) :: unif\_num                            \textcolor{comment}{! A random sample from the uniform distribution}}
\DoxyCodeLine{880 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)} :: start                 \textcolor{comment}{! Starting point of MCMC chain}}
\DoxyCodeLine{881 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:, :)}, \textcolor{keywordtype}{allocatable} :: X     \textcolor{comment}{! Unburnt and thinned MCMC chain }}
\DoxyCodeLine{882 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)} :: X\_n                   \textcolor{comment}{! The proposed step }}
\DoxyCodeLine{883 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)} :: sample\_normal         \textcolor{comment}{! A sample from the normal distribution }}
\DoxyCodeLine{884         \textcolor{keywordtype}{integer} :: accept                                   \textcolor{comment}{! Number of accepted steps }}
\DoxyCodeLine{885         \textcolor{keywordtype}{integer} :: thin\_counter                             \textcolor{comment}{! Counter to keep track of the thinning process}}
\DoxyCodeLine{886         \textcolor{keywordtype}{integer} :: reset\_counter                            \textcolor{comment}{! Counts how many times thin counter was reset}}
\DoxyCodeLine{887         \textcolor{keywordtype}{integer} :: re\_size                                  \textcolor{comment}{! The size of the burnt and thinned array}}
\DoxyCodeLine{888         \textcolor{keywordtype}{integer} :: i\_bt                                     \textcolor{comment}{! Burned/thinned value of i}}
\DoxyCodeLine{889         \textcolor{keywordtype}{integer} :: i                                        \textcolor{comment}{! Loop variable }}
\DoxyCodeLine{890         \textcolor{keywordtype}{character(len=1)} :: acceptance                      \textcolor{comment}{! Yes/No signpost for acceptance}}
\DoxyCodeLine{891 }
\DoxyCodeLine{892         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{893             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Markov chain for c = ', F7.4)"{}}) c\_const}
\DoxyCodeLine{894             \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Logging the chain from Rank 0.')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{895 \textcolor{comment}{}\textcolor{keywordflow}{        endif} }
\DoxyCodeLine{896 }
\DoxyCodeLine{897         \textcolor{comment}{! Adjust the output array to be of the burnt and thinned array}}
\DoxyCodeLine{898         re\_size = (n -\/ burn) / thin}
\DoxyCodeLine{899 }
\DoxyCodeLine{900         \textcolor{keyword}{allocate}(x(3, 1:n+1)); x(:, :) = 0.0\_real64}
\DoxyCodeLine{901         \textcolor{keyword}{allocate}(x\_burnt(3, 1:re\_size)); x\_burnt(:, :) = 0.0\_real64}
\DoxyCodeLine{902         \textcolor{keyword}{allocate}(energy\_chain(1:re\_size)); energy\_chain(:) = 0.0\_real64}
\DoxyCodeLine{903         \textcolor{keyword}{allocate}(dphidc\_chain(1:re\_size)); dphidc\_chain(:) = 0.0\_real64}
\DoxyCodeLine{904 }
\DoxyCodeLine{905         \textcolor{comment}{! Allow the starting position to take on the default value}}
\DoxyCodeLine{906         \textcolor{keywordflow}{if} (\textcolor{keyword}{present}(x\_start)) \textcolor{keywordflow}{then} }
\DoxyCodeLine{907             start = x\_start}
\DoxyCodeLine{908             x(:,1) = start}
\DoxyCodeLine{909             \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{910                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Starting from provided Markov chain position:')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{911 \textcolor{comment}{}                \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('    x = ', F12.8, ' y = ', F12.8, ' z = ', F12.8)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{912 \textcolor{comment}{}                    x(1, 1), x(2, 1), x(3, 1)}
\DoxyCodeLine{913 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{914         \textcolor{keywordflow}{else} }
\DoxyCodeLine{915             \textcolor{comment}{! Create the initial position of the random walker that is within a certain radius}}
\DoxyCodeLine{916             \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{917             \textcolor{keywordflow}{do} \textcolor{keywordflow}{while}(norm2(sample\_normal) >= h2plus\%rcut)}
\DoxyCodeLine{918                 \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{919 \textcolor{keywordflow}{            end do} }
\DoxyCodeLine{920             start = sample\_normal}
\DoxyCodeLine{921             x(:,1) = start }
\DoxyCodeLine{922             \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{923                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Generated random Markov chain start position:')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{924 \textcolor{comment}{}                \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('X = ', F12.8, ', Y = ', F12.8, ', Z = ', F12.8)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{925 \textcolor{comment}{}                    x(1, 1), x(2, 1), x(3, 1)}
\DoxyCodeLine{926 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{927 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{928         }
\DoxyCodeLine{929         \textcolor{comment}{! Start the counter for the number of accepted moves}}
\DoxyCodeLine{930         accept = 0  }
\DoxyCodeLine{931         \textcolor{comment}{! Start the counter for the thinning process }}
\DoxyCodeLine{932         thin\_counter = 0}
\DoxyCodeLine{933         \textcolor{comment}{! Start the reset\_counter }}
\DoxyCodeLine{934         reset\_counter = 0}
\DoxyCodeLine{935         }
\DoxyCodeLine{936         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{937             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Sample      X               Y              Z              \&}}
\DoxyCodeLine{938 \textcolor{stringliteral}{}\textcolor{stringliteral}{                \&Local Energy     Accepted?')"{}})}
\DoxyCodeLine{939             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.8, '   ', F12.8, ' ', F12.6)"{}}\textcolor{comment}{)\&}}
\DoxyCodeLine{940 \textcolor{comment}{}                1, x(1, 1), x(2, 1), x(3, 1), energy\_chain(1)}
\DoxyCodeLine{941 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{942         }
\DoxyCodeLine{943         \textcolor{comment}{! Calculate the local energy of the initial step if not burnt}}
\DoxyCodeLine{944         \textcolor{keywordflow}{if} (burn == 0) \textcolor{keywordflow}{then} }
\DoxyCodeLine{945             \textcolor{keyword}{call }h\_2\_plus\_energy(c\_const, x(:, 1), r\_a, r\_b, e\_loc, dphidc\textcolor{comment}{)}}
\DoxyCodeLine{946 \textcolor{comment}{}            energy\_chain(1) = e\_loc}
\DoxyCodeLine{947             dphidc\_chain(1) = dphidc}
\DoxyCodeLine{948             x\_burnt(:, 1) = x(:, 1)}
\DoxyCodeLine{949 }
\DoxyCodeLine{950             \textcolor{keywordflow}{do} i = 2, n}
\DoxyCodeLine{951                 \textcolor{comment}{! Add one to the thin counter }}
\DoxyCodeLine{952                 thin\_counter = 1 + thin\_counter}
\DoxyCodeLine{953                 \textcolor{comment}{! Propose the next step }}
\DoxyCodeLine{954                 \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{955                 x\_n = x(:, i-\/1) + sigma * sample\_normal}
\DoxyCodeLine{956 }
\DoxyCodeLine{957                 \textcolor{comment}{! Calculate the transition probability between proposed step and current step }}
\DoxyCodeLine{958                 log\_prob\_n = log(h\_2\_plus\_prob(c\_const, x(:, i-\/1), x\_n, r\_a\textcolor{comment}{, r\_b))}}
\DoxyCodeLine{959 \textcolor{comment}{}           }
\DoxyCodeLine{960                 \textcolor{comment}{! Calculate the acceptance ratio }}
\DoxyCodeLine{961                 a\_prob\_trans = min(1.0\_real64, exp(log\_prob\_n))}
\DoxyCodeLine{962             }
\DoxyCodeLine{963                 \textcolor{comment}{! Generate sample from uniform distribution}}
\DoxyCodeLine{964                 \textcolor{keyword}{call }ran1(unif\_num, seed)}
\DoxyCodeLine{965 }
\DoxyCodeLine{966                 \textcolor{comment}{! Compare the drawn sample from the uniform distribution with the acceptance ratio}}
\DoxyCodeLine{967                 \textcolor{keywordflow}{if} (a\_prob\_trans >= unif\_num) \textcolor{keywordflow}{then} }
\DoxyCodeLine{968                     \textcolor{comment}{! If accepted add proposed position to the MCMC chain}}
\DoxyCodeLine{969                     x(:, i) = x\_n }
\DoxyCodeLine{970 }
\DoxyCodeLine{971                     \textcolor{comment}{! To determine whether this point should be added to the burnt and thinned MCMC chain}}
\DoxyCodeLine{972                     \textcolor{keywordflow}{if} ((i > (burn + 1)) .and. (thin\_counter == thin)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{973                         \textcolor{comment}{! Increment the reset counter }}
\DoxyCodeLine{974                         reset\_counter = 1 + reset\_counter}
\DoxyCodeLine{975                         \textcolor{comment}{! Precalculate i\_bt for shorthand}}
\DoxyCodeLine{976                         i\_bt = i -\/ burn -\/ (reset\_counter * (thin -\/ 1))}
\DoxyCodeLine{977                         \textcolor{comment}{! Add to the burn and thinned MCMC chain}}
\DoxyCodeLine{978                         x\_burnt(:, i\_bt) = x\_n}
\DoxyCodeLine{979                         \textcolor{comment}{! Calculate the local energy at this point }}
\DoxyCodeLine{980                         \textcolor{keyword}{call }h\_2\_plus\_energy(c\_const, x\_n, r\_a, r\_b, e\_loc\textcolor{comment}{, dphidc)}}
\DoxyCodeLine{981 \textcolor{comment}{}                        energy\_chain(i\_bt) = e\_loc}
\DoxyCodeLine{982                         dphidc\_chain(i\_bt) = dphidc}
\DoxyCodeLine{983                         \textcolor{comment}{! Resetting the thin counter }}
\DoxyCodeLine{984                         thin\_counter = 0}
\DoxyCodeLine{985 }
\DoxyCodeLine{986                         acceptance = \textcolor{stringliteral}{'Y'}}
\DoxyCodeLine{987                         \textcolor{comment}{! Increment the number of accepted steps }}
\DoxyCodeLine{988                         accept = 1 + accept }
\DoxyCodeLine{989 }
\DoxyCodeLine{990                         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{991                             \textcolor{keywordflow}{if} (mod(i\_bt, re\_size/logfrac) .le. 1e-\/6\_real64\textcolor{comment}{) }\textcolor{keywordflow}{then}}
\DoxyCodeLine{992                                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.8, '   ', F12.8,\&}}
\DoxyCodeLine{993 \textcolor{stringliteral}{}\textcolor{stringliteral}{                                    \&' ', F12.6, '         ', A1)"{}}) (i\_bt\textcolor{comment}{), x\_burnt(1, i\_bt), \&}}
\DoxyCodeLine{994 \textcolor{comment}{}                                    x\_burnt(2, i\_bt), x\_burnt(2, i\_bt), energy\_chain\textcolor{comment}{(i\_bt), \&}}
\DoxyCodeLine{995 \textcolor{comment}{}                                    acceptance}
\DoxyCodeLine{996 \textcolor{keywordflow}{                            end if}}
\DoxyCodeLine{997 \textcolor{keywordflow}{                        end if}}
\DoxyCodeLine{998 \textcolor{keywordflow}{                    end if} }
\DoxyCodeLine{999                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{1000                     \textcolor{comment}{! If rejected the proposed step is the current step }}
\DoxyCodeLine{1001                     x(:, i) = x(:, i-\/1)}
\DoxyCodeLine{1002 }
\DoxyCodeLine{1003                     \textcolor{keywordflow}{if} ((i > (burn + 1)) .and. (thin\_counter == thin)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1004                         \textcolor{comment}{! Increment the reset counter }}
\DoxyCodeLine{1005                         reset\_counter = 1 + reset\_counter}
\DoxyCodeLine{1006                         \textcolor{comment}{! Precalculate i\_bt for shorthand}}
\DoxyCodeLine{1007                         i\_bt = i -\/ burn -\/ (reset\_counter * (thin -\/ 1))}
\DoxyCodeLine{1008                         \textcolor{comment}{! Add to the burn and thinned MCMC chain}}
\DoxyCodeLine{1009                         x\_burnt(:, i\_bt) = x(:, i-\/1)}
\DoxyCodeLine{1010                         \textcolor{comment}{! Calculate the local energy at this point }}
\DoxyCodeLine{1011                         \textcolor{keyword}{call }h\_2\_plus\_energy(c\_const, x(:, i-\/1), r\_a, r\_b\textcolor{comment}{, e\_loc, dphidc)}}
\DoxyCodeLine{1012 \textcolor{comment}{}                        energy\_chain(i\_bt) = e\_loc}
\DoxyCodeLine{1013                         dphidc\_chain(i\_bt) = dphidc}
\DoxyCodeLine{1014                         \textcolor{comment}{! Resetting the thin counter }}
\DoxyCodeLine{1015                         thin\_counter = 0}
\DoxyCodeLine{1016 }
\DoxyCodeLine{1017                         acceptance = \textcolor{stringliteral}{'N'}}
\DoxyCodeLine{1018 }
\DoxyCodeLine{1019                         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1020                             \textcolor{keywordflow}{if} (mod(i\_bt, re\_size/logfrac) .le. 1e-\/6\_real64\textcolor{comment}{) }\textcolor{keywordflow}{then}}
\DoxyCodeLine{1021                                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.8, '   ', F12.8,\&}}
\DoxyCodeLine{1022 \textcolor{stringliteral}{}\textcolor{stringliteral}{                                    \&' ', F12.6, '         ', A1)"{}}) (i\_bt\textcolor{comment}{), x\_burnt(1, i\_bt), \&}}
\DoxyCodeLine{1023 \textcolor{comment}{}                                    x\_burnt(2, i\_bt), x\_burnt(2, i\_bt), energy\_chain\textcolor{comment}{(i\_bt), \&}}
\DoxyCodeLine{1024 \textcolor{comment}{}                                    acceptance}
\DoxyCodeLine{1025 \textcolor{keywordflow}{                            end if}}
\DoxyCodeLine{1026 \textcolor{keywordflow}{                        end if}}
\DoxyCodeLine{1027 \textcolor{keywordflow}{                    end if} }
\DoxyCodeLine{1028 \textcolor{keywordflow}{                end if} }
\DoxyCodeLine{1029 \textcolor{keywordflow}{            end do} }
\DoxyCodeLine{1030         \textcolor{comment}{! Loop to advance the chain to the final burn step and not save any of the outputs}}
\DoxyCodeLine{1031         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (burn >= 2) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1032             \textcolor{keywordflow}{do} i = 2, burn}
\DoxyCodeLine{1033                 \textcolor{comment}{! Propose the next step }}
\DoxyCodeLine{1034                 \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{1035                 x\_n = x(:, i-\/1) + sigma * sample\_normal}
\DoxyCodeLine{1036 }
\DoxyCodeLine{1037                 \textcolor{comment}{! Calculate the transition probability between proposed step and current step }}
\DoxyCodeLine{1038                 log\_prob\_n = log(h\_2\_plus\_prob(c\_const, x(:, i-\/1), x\_n, r\_a\textcolor{comment}{, r\_b))}}
\DoxyCodeLine{1039 \textcolor{comment}{}           }
\DoxyCodeLine{1040                 \textcolor{comment}{! Calculate the acceptance ratio }}
\DoxyCodeLine{1041                 a\_prob\_trans = min(1.0\_real64, exp(log\_prob\_n))}
\DoxyCodeLine{1042             }
\DoxyCodeLine{1043                 \textcolor{comment}{! Generate sample from uniform distribution}}
\DoxyCodeLine{1044                 \textcolor{keyword}{call }ran1(unif\_num, seed)}
\DoxyCodeLine{1045 }
\DoxyCodeLine{1046                 \textcolor{comment}{! Compare the drawn sample from the uniform distribution with the acceptance ratio}}
\DoxyCodeLine{1047                 \textcolor{keywordflow}{if} (a\_prob\_trans >= unif\_num) \textcolor{keywordflow}{then} }
\DoxyCodeLine{1048                     \textcolor{comment}{! If accepted add proposed position to the MCMC chain}}
\DoxyCodeLine{1049                     x(:, i) = x\_n }
\DoxyCodeLine{1050                 \textcolor{keywordflow}{else} }
\DoxyCodeLine{1051                     \textcolor{comment}{! If rejected the proposed step is the current step }}
\DoxyCodeLine{1052                     x(:, i) = x(:, i-\/1)}
\DoxyCodeLine{1053 \textcolor{keywordflow}{                end if} }
\DoxyCodeLine{1054 \textcolor{keywordflow}{            end do} }
\DoxyCodeLine{1055 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{1056 }
\DoxyCodeLine{1057         \textcolor{comment}{! Metropolis Algorithm to calculate the burnt and thinned MCMC chain }}
\DoxyCodeLine{1058         \textcolor{keywordflow}{if} (burn >= 1) \textcolor{keywordflow}{then} }
\DoxyCodeLine{1059             \textcolor{comment}{! Metropolis algorithm }}
\DoxyCodeLine{1060             \textcolor{keywordflow}{do} i = burn + 1, n+1 }
\DoxyCodeLine{1061                 \textcolor{comment}{! Add one to the thin counter }}
\DoxyCodeLine{1062                 thin\_counter = 1 + thin\_counter}
\DoxyCodeLine{1063                 \textcolor{comment}{! Propose the next step }}
\DoxyCodeLine{1064                 \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{1065                 x\_n = x(:, i-\/1) + sigma * sample\_normal}
\DoxyCodeLine{1066 }
\DoxyCodeLine{1067                 \textcolor{comment}{! Calculate the transition probability between proposed step and current step }}
\DoxyCodeLine{1068                 log\_prob\_n = log(h\_2\_plus\_prob(c\_const, x(:, i-\/1), x\_n, r\_a\textcolor{comment}{, r\_b))}}
\DoxyCodeLine{1069 \textcolor{comment}{}                }
\DoxyCodeLine{1070                 \textcolor{comment}{! Calculate the acceptance ratio }}
\DoxyCodeLine{1071                 a\_prob\_trans = min(1.0\_real64, exp(log\_prob\_n))}
\DoxyCodeLine{1072             }
\DoxyCodeLine{1073                 \textcolor{comment}{! Generate sample from uniform distribution}}
\DoxyCodeLine{1074                 \textcolor{keyword}{call }ran1(unif\_num, seed)}
\DoxyCodeLine{1075 }
\DoxyCodeLine{1076                 \textcolor{comment}{! Compare the drawn sample from the uniform distribution with the acceptance ratio}}
\DoxyCodeLine{1077                 \textcolor{keywordflow}{if} (a\_prob\_trans >= unif\_num) \textcolor{keywordflow}{then} }
\DoxyCodeLine{1078                     \textcolor{comment}{! If accepted add proposed position to the MCMC chain}}
\DoxyCodeLine{1079                     x(:, i) = x\_n }
\DoxyCodeLine{1080 }
\DoxyCodeLine{1081                     \textcolor{comment}{! To determine whether this point should be added to the burnt and thinned MCMC chain}}
\DoxyCodeLine{1082                     \textcolor{keywordflow}{if} ((i > (burn + 1)) .and. (thin\_counter == thin)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1083                         \textcolor{comment}{! Increment the reset counter }}
\DoxyCodeLine{1084                         reset\_counter = 1 + reset\_counter}
\DoxyCodeLine{1085                         \textcolor{comment}{! Precalculate i\_bt for shorthand}}
\DoxyCodeLine{1086                         i\_bt = i -\/ burn -\/ (reset\_counter * (thin -\/ 1))}
\DoxyCodeLine{1087                         \textcolor{comment}{! Add to the burn and thinned MCMC chain}}
\DoxyCodeLine{1088                         x\_burnt(:, i\_bt) = x\_n}
\DoxyCodeLine{1089                         \textcolor{comment}{! Calculate the local energy at this point }}
\DoxyCodeLine{1090                         \textcolor{keyword}{call }h\_2\_plus\_energy(c\_const, x\_n, r\_a, r\_b, e\_loc\textcolor{comment}{, dphidc)}}
\DoxyCodeLine{1091 \textcolor{comment}{}                        energy\_chain(i\_bt) = e\_loc}
\DoxyCodeLine{1092                         dphidc\_chain(i\_bt) = dphidc}
\DoxyCodeLine{1093                         \textcolor{comment}{! Resetting the thin counter }}
\DoxyCodeLine{1094                         thin\_counter = 0}
\DoxyCodeLine{1095 }
\DoxyCodeLine{1096                         acceptance = \textcolor{stringliteral}{'Y'}}
\DoxyCodeLine{1097                         \textcolor{comment}{! Increment the number of accepted steps }}
\DoxyCodeLine{1098                         accept = 1 + accept }
\DoxyCodeLine{1099 }
\DoxyCodeLine{1100                         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1101                             \textcolor{keywordflow}{if} (mod(i\_bt, re\_size/logfrac) .le. 1e-\/6\_real64\textcolor{comment}{) }\textcolor{keywordflow}{then}}
\DoxyCodeLine{1102                                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.8, '   ', F12.8,\&}}
\DoxyCodeLine{1103 \textcolor{stringliteral}{}\textcolor{stringliteral}{                                    \&' ', F12.6, '         ', A1)"{}}) (i\_bt\textcolor{comment}{), x\_burnt(1, i\_bt), \&}}
\DoxyCodeLine{1104 \textcolor{comment}{}                                    x\_burnt(2, i\_bt), x\_burnt(2, i\_bt), energy\_chain\textcolor{comment}{(i\_bt), \&}}
\DoxyCodeLine{1105 \textcolor{comment}{}                                    acceptance}
\DoxyCodeLine{1106 \textcolor{keywordflow}{                            end if}}
\DoxyCodeLine{1107 \textcolor{keywordflow}{                        end if}}
\DoxyCodeLine{1108 \textcolor{keywordflow}{                    end if} }
\DoxyCodeLine{1109                  }
\DoxyCodeLine{1110                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{1111                     \textcolor{comment}{! If rejected the proposed step is the current step }}
\DoxyCodeLine{1112                     x(:, i) = x(:, i-\/1)}
\DoxyCodeLine{1113 }
\DoxyCodeLine{1114                     \textcolor{comment}{! To determine whether this point should be added to the burnt and thinned MCMC chain                   }}
\DoxyCodeLine{1115                     \textcolor{keywordflow}{if} ((i > (burn + 1)) .and. (thin\_counter == thin)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1116                         \textcolor{comment}{! Increment the reset counter }}
\DoxyCodeLine{1117                         reset\_counter = 1 + reset\_counter}
\DoxyCodeLine{1118                         \textcolor{comment}{! Precalculate i\_bt for shorthand}}
\DoxyCodeLine{1119                         i\_bt = i -\/ burn -\/ (reset\_counter * (thin -\/ 1))}
\DoxyCodeLine{1120                         \textcolor{comment}{! Add to the burn and thinned MCMC chain}}
\DoxyCodeLine{1121                         x\_burnt(:, i\_bt) = x(:, i-\/1)}
\DoxyCodeLine{1122                         \textcolor{comment}{! Calculate the local energy at this point }}
\DoxyCodeLine{1123                         \textcolor{keyword}{call }h\_2\_plus\_energy(c\_const, x(:, i-\/1), r\_a, r\_b\textcolor{comment}{, e\_loc, dphidc)}}
\DoxyCodeLine{1124 \textcolor{comment}{}                        energy\_chain(i\_bt) = e\_loc}
\DoxyCodeLine{1125                         dphidc\_chain(i\_bt) = dphidc}
\DoxyCodeLine{1126                         \textcolor{comment}{! Resetting the thin counter }}
\DoxyCodeLine{1127                         thin\_counter = 0}
\DoxyCodeLine{1128 }
\DoxyCodeLine{1129                         acceptance = \textcolor{stringliteral}{'N'}}
\DoxyCodeLine{1130 }
\DoxyCodeLine{1131                         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1132                             \textcolor{keywordflow}{if} (mod(i\_bt, re\_size/logfrac) .le. 1e-\/6\_real64\textcolor{comment}{) }\textcolor{keywordflow}{then}}
\DoxyCodeLine{1133                                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.8, '   ', F12.8,\&}}
\DoxyCodeLine{1134 \textcolor{stringliteral}{}\textcolor{stringliteral}{                                    \&' ', F12.6, '         ', A1)"{}}) (i\_bt\textcolor{comment}{), x\_burnt(1, i\_bt), \&}}
\DoxyCodeLine{1135 \textcolor{comment}{}                                    x\_burnt(2, i\_bt), x\_burnt(2, i\_bt), energy\_chain\textcolor{comment}{(i\_bt), \&}}
\DoxyCodeLine{1136 \textcolor{comment}{}                                    acceptance}
\DoxyCodeLine{1137 \textcolor{keywordflow}{                            end if}}
\DoxyCodeLine{1138 \textcolor{keywordflow}{                        end if}}
\DoxyCodeLine{1139 }
\DoxyCodeLine{1140 \textcolor{keywordflow}{                    end if} }
\DoxyCodeLine{1141 \textcolor{keywordflow}{                end if} }
\DoxyCodeLine{1142 \textcolor{keywordflow}{            end do}}
\DoxyCodeLine{1143 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{1144 }
\DoxyCodeLine{1145         \textcolor{comment}{! Calculate the acceptance ratio}}
\DoxyCodeLine{1146         accept\_rate = (real(accept, kind=real64) / real(re\_size, kind=real64\textcolor{comment}{))}}
\DoxyCodeLine{1147 \textcolor{comment}{}}
\DoxyCodeLine{1148         \textcolor{comment}{! Calculate the mean energy and the variance in the energy}}
\DoxyCodeLine{1149         energy\_mean = sum(energy\_chain) / real(re\_size, kind=real64)}
\DoxyCodeLine{1150         energy\_variance = 0.0\_real64}
\DoxyCodeLine{1151         \textcolor{keywordflow}{do} i = 1, re\_size}
\DoxyCodeLine{1152             energy\_variance = energy\_variance + ((1.0\_real64 / real(re\_size\textcolor{comment}{ -\/ 1, kind=real64)) * \&}}
\DoxyCodeLine{1153 \textcolor{comment}{}            (energy\_chain(i) -\/ energy\_mean) * (energy\_chain(i) -\/ energy\_mean\textcolor{comment}{)) }}
\DoxyCodeLine{1154 \textcolor{comment}{}\textcolor{keywordflow}{        end do}}
\DoxyCodeLine{1155         energy\_variance = (1.0\_real64 / real(re\_size, kind=real64)) * energy\_variance}
\DoxyCodeLine{1156 }
\DoxyCodeLine{1157         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1158             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Local energy = ', F12.8)"{}}) energy\_mean}
\DoxyCodeLine{1159             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Variance = ', F12.8)"{}}) energy\_variance}
\DoxyCodeLine{1160             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Acceptance rate = ', F12.8)"{}}) accept\_rate}
\DoxyCodeLine{1161             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{1162 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{1163 }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a8213f95bb390d7a9eff8260f527c00b8_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a8213f95bb390d7a9eff8260f527c00b8_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_a0a07ef5b098cdc478b253de26c49aadc}\label{namespacevqmc_a0a07ef5b098cdc478b253de26c49aadc}} 
\index{vqmc@{vqmc}!auto\_h\_2\_plus@{auto\_h\_2\_plus}}
\index{auto\_h\_2\_plus@{auto\_h\_2\_plus}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{auto\_h\_2\_plus()}{auto\_h\_2\_plus()}}
{\footnotesize\ttfamily subroutine vqmc\+::auto\+\_\+h\+\_\+2\+\_\+plus (\begin{DoxyParamCaption}\item[{real(real64), intent(in)}]{c\+\_\+in,  }\item[{real(real64), intent(in)}]{bond\+\_\+length,  }\item[{real(real64), intent(out)}]{c\+\_\+out,  }\item[{real(real64), intent(out)}]{energy\+\_\+out,  }\item[{real(real64), intent(out)}]{variance\+\_\+out,  }\item[{real(real64), intent(out)}]{accept\+\_\+out,  }\item[{character(len=1), intent(out)}]{converged }\end{DoxyParamCaption})}



Automatically finds the best variational parameter $ c $ for the $ H_{2}^{+} $ problem at given bond length. 

Determines the optimum value of $ c $ at a given bond length from a guess value by utilising the gradient with respect to $ c $ (calculated by first order central difference) in a \mbox{\hyperlink{namespacesolvers_acb91c2bfc7ae441b3e24f83d0f49d55a}{dampened steepest descent optimisation}}. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em c\+\_\+in} & Guess value for c \\
\hline
\mbox{\texttt{ in}}  & {\em bond\+\_\+length} & H-\/H bond length \\
\hline
\mbox{\texttt{ out}}  & {\em c\+\_\+out} & Optimised value for c at this bond length \\
\hline
\mbox{\texttt{ out}}  & {\em energy\+\_\+out} & Energy of wavefunction at optimal c \\
\hline
\mbox{\texttt{ out}}  & {\em variance\+\_\+out} & Variance of energy at optimal c \\
\hline
\mbox{\texttt{ out}}  & {\em accept\+\_\+out} & Acceptance rate of MCMC chain at optimal c \\
\hline
\mbox{\texttt{ out}}  & {\em converged} & Y/N convergence status \\
\hline
\end{DoxyParams}


Definition at line 1188 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{1190 }
\DoxyCodeLine{1191         \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{1192 }
\DoxyCodeLine{1193 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: c\_in}
\DoxyCodeLine{1194 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: bond\_length}
\DoxyCodeLine{1195 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: c\_out}
\DoxyCodeLine{1196 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: energy\_out}
\DoxyCodeLine{1197 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: variance\_out}
\DoxyCodeLine{1198 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: accept\_out}
\DoxyCodeLine{1199         \textcolor{keywordtype}{character(len=1)}, \textcolor{keywordtype}{intent(out)} :: converged}
\DoxyCodeLine{1200 }
\DoxyCodeLine{1201 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)} :: R\_a, R\_b}
\DoxyCodeLine{1202 \textcolor{keywordtype}{        real}(real64) :: c\_current, c\_new}
\DoxyCodeLine{1203 \textcolor{keywordtype}{        real}(real64) :: c\_grad}
\DoxyCodeLine{1204 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:, :)}, \textcolor{keywordtype}{allocatable} :: pos\_chain}
\DoxyCodeLine{1205 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energy\_chain}
\DoxyCodeLine{1206 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: DphiDc\_chain}
\DoxyCodeLine{1207         \textcolor{keywordtype}{integer} :: viz\_steps}
\DoxyCodeLine{1208         \textcolor{keywordtype}{integer} :: k}
\DoxyCodeLine{1209         \textcolor{keywordtype}{integer} :: ierr}
\DoxyCodeLine{1210         \textcolor{keywordtype}{integer} :: maxiter = 200}
\DoxyCodeLine{1211 \textcolor{keywordtype}{        real}(real64) :: tol = 1e-\/4\_real64}
\DoxyCodeLine{1212         \textcolor{keywordtype}{character(len=6)} :: str\_b}
\DoxyCodeLine{1213         \textcolor{keywordtype}{character(len=40)} :: chainfile}
\DoxyCodeLine{1214 }
\DoxyCodeLine{1215         \textcolor{comment}{! MPI Variables}}
\DoxyCodeLine{1216 \textcolor{keywordtype}{        real}(real64) :: my\_c\_grad, my\_ensum}
\DoxyCodeLine{1217 \textcolor{keywordtype}{        real}(real64) :: sum\_var, sum\_acc}
\DoxyCodeLine{1218 }
\DoxyCodeLine{1219         \textcolor{comment}{! Initialise}}
\DoxyCodeLine{1220         c\_current = c\_in}
\DoxyCodeLine{1221         r\_a = (/-\/bond\_length/2, 0.0\_real64, 0.0\_real64/)}
\DoxyCodeLine{1222         r\_b = (/bond\_length/2, 0.0\_real64, 0.0\_real64/)}
\DoxyCodeLine{1223 }
\DoxyCodeLine{1224         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1225             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Starting parameter search for c...')"{}})}
\DoxyCodeLine{1226 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{1227 }
\DoxyCodeLine{1228         \textcolor{comment}{! Main iteration loop}}
\DoxyCodeLine{1229         \textcolor{keywordflow}{do} k = auto\_start, maxiter}
\DoxyCodeLine{1230 }
\DoxyCodeLine{1231             \textcolor{comment}{! Calculate gradient at current c}}
\DoxyCodeLine{1232             \textcolor{keyword}{call }vqmc\_h\_2\_plus(h2plus\%sigma, my\_steps+h2plus\%burn\_step, h2plus\%burn\_step\textcolor{comment}{, h2plus\%thin\_step, \&}}
\DoxyCodeLine{1233 \textcolor{comment}{}                    c\_current, r\_a, r\_b, pos\_chain, accept\_out, energy\_chain\textcolor{comment}{, energy\_out, \& }}
\DoxyCodeLine{1234 \textcolor{comment}{}                    variance\_out, dphidc\_chain)}
\DoxyCodeLine{1235             }
\DoxyCodeLine{1236             \textcolor{comment}{! Find gradient     }}
\DoxyCodeLine{1237             my\_c\_grad = 2.0\_real64 * (sum(energy\_chain * dphidc\_chain) /\textcolor{comment}{ }\textcolor{keyword}{size}\textcolor{comment}{(energy\_chain)) \&}}
\DoxyCodeLine{1238 \textcolor{comment}{}                -\/ (energy\_out * (sum(dphidc\_chain) / \textcolor{keyword}{size}(dphidc\_chain))\textcolor{comment}{)}}
\DoxyCodeLine{1239 \textcolor{comment}{}}
\DoxyCodeLine{1240             \textcolor{comment}{! Find average c\_grad across ranks, on all ranks.}}
\DoxyCodeLine{1241             \textcolor{keyword}{call }mpi\_allreduce(my\_c\_grad,c\_grad,1,mpi\_double\_precision,mpi\_sum\textcolor{comment}{,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{1242 \textcolor{comment}{}            c\_grad = c\_grad * per\_proc}
\DoxyCodeLine{1243 }
\DoxyCodeLine{1244             \textcolor{comment}{! Update the log}}
\DoxyCodeLine{1245             \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1246                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('c            Gradient')"{}})}
\DoxyCodeLine{1247                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(F13.7, '       ', F13.7)"{}}) c\_current, c\_grad}
\DoxyCodeLine{1248 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{1249 }
\DoxyCodeLine{1250             \textcolor{comment}{! Check if gradient is within tolerance.}}
\DoxyCodeLine{1251             \textcolor{keywordflow}{if} (abs(c\_grad) .le. tol) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1252 }
\DoxyCodeLine{1253                 \textcolor{comment}{! Update c\_out, and note convergence, on all ranks.}}
\DoxyCodeLine{1254                 c\_out = c\_current}
\DoxyCodeLine{1255                 converged = \textcolor{stringliteral}{'Y'}}
\DoxyCodeLine{1256 }
\DoxyCodeLine{1257                 \textcolor{comment}{! Sum the chain energy-\/sums and store in rank 0}}
\DoxyCodeLine{1258                 my\_ensum = sum(energy\_chain)}
\DoxyCodeLine{1259                 \textcolor{keyword}{call }mpi\_reduce(my\_ensum,energy\_out,1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{1260 \textcolor{comment}{}}
\DoxyCodeLine{1261                 \textcolor{comment}{! Sum the chain variances and store in rank 0}}
\DoxyCodeLine{1262                 \textcolor{keyword}{call }mpi\_reduce(variance\_out, sum\_var,1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{1263 \textcolor{comment}{}}
\DoxyCodeLine{1264                 \textcolor{comment}{! Sum the chain acceptance rates and store in rank 0}}
\DoxyCodeLine{1265                 \textcolor{keyword}{call }mpi\_reduce(accept\_out, sum\_acc,1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{1266 \textcolor{comment}{}}
\DoxyCodeLine{1267                 \textcolor{comment}{! Calculate averages on rank 0}}
\DoxyCodeLine{1268                 \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1269 }
\DoxyCodeLine{1270                     energy\_out = energy\_out * per\_step}
\DoxyCodeLine{1271                     variance\_out = sum\_var * per\_proc2 }
\DoxyCodeLine{1272                     accept\_out = sum\_acc * per\_proc}
\DoxyCodeLine{1273 }
\DoxyCodeLine{1274                     \textcolor{comment}{! Update the log}}
\DoxyCodeLine{1275                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1276                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Parameter search converged!')"{}})}
\DoxyCodeLine{1277                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Results:')"{}})}
\DoxyCodeLine{1278                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('c = ', F13.7, ', Energy = ', F12.8, ', Variance = ', F12.8)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{1279 \textcolor{comment}{}                            c\_current, energy\_out, variance\_out}
\DoxyCodeLine{1280                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{1281 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{1282 }
\DoxyCodeLine{1283 \textcolor{keywordflow}{                end if} }
\DoxyCodeLine{1284 }
\DoxyCodeLine{1285                 \textcolor{comment}{! Exit subroutine, as convergence is reached.}}
\DoxyCodeLine{1286                 \textcolor{comment}{! Note: Only rank 0 has the correct array outputs. All ranks have correct c\_out and 'converged'.}}
\DoxyCodeLine{1287                 \textcolor{keywordflow}{exit}}
\DoxyCodeLine{1288 }
\DoxyCodeLine{1289 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{1290 }
\DoxyCodeLine{1291             \textcolor{comment}{! If not, update c by steepest descent, on all ranks.}}
\DoxyCodeLine{1292             \textcolor{keyword}{call }h\_2\_plus\_update\_c(c\_current, c\_grad, c\_new)}
\DoxyCodeLine{1293             c\_current = c\_new}
\DoxyCodeLine{1294 }
\DoxyCodeLine{1295             \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{1296             \textcolor{keywordflow}{if} (write\_restart .and. my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1297                 \textcolor{keywordflow}{if} (mod(k,restart\_num)==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1298                     \textcolor{keyword}{call }write\_res\_nml(i\_bond,k+1,h2plus\%auto\_params,c\_current\textcolor{comment}{)}}
\DoxyCodeLine{1299 \textcolor{comment}{}\textcolor{keywordflow}{                endif}}
\DoxyCodeLine{1300 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{1301 }
\DoxyCodeLine{1302 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{1303 }
\DoxyCodeLine{1304         \textcolor{comment}{! Deal with non-\/convergence}}
\DoxyCodeLine{1305         \textcolor{keywordflow}{if} (k .ge. maxiter) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1306             converged = \textcolor{stringliteral}{'N'}}
\DoxyCodeLine{1307             c\_out = c\_current}
\DoxyCodeLine{1308             \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then} }
\DoxyCodeLine{1309                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Parameter search NOT converged! Consider changing\&}}
\DoxyCodeLine{1310 \textcolor{stringliteral}{}\textcolor{stringliteral}{                    \& the starting value of c, or the damping in the H\_2\_update\_c\&}}
\DoxyCodeLine{1311 \textcolor{stringliteral}{}\textcolor{stringliteral}{                    \& function.')"{}})}
\DoxyCodeLine{1312 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{1313 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{1314 }
\DoxyCodeLine{1315         \textcolor{comment}{! Report results}}
\DoxyCodeLine{1316         \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1317 }
\DoxyCodeLine{1318             \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(F12.8, '   ', A, '             ', F13.7, '      ', F12.8)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{1319 \textcolor{comment}{}                bond\_length, converged, c\_out, energy\_out}
\DoxyCodeLine{1320 }
\DoxyCodeLine{1321             \textcolor{comment}{! Run a new visualisation chain at the optimised parameter if write\_chains is enabled.}}
\DoxyCodeLine{1322             \textcolor{keywordflow}{if} (write\_chains) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1323                 \textcolor{keyword}{write}(str\_b, \textcolor{stringliteral}{"{}(F6.3)"{}}) bond\_length}
\DoxyCodeLine{1324                 \textcolor{keyword}{write}(chainfile, \textcolor{stringliteral}{"{}(3A)"{}}) \textcolor{stringliteral}{'./chains\_out/bond\_'}, trim(adjustl\textcolor{comment}{(str\_b)), }\textcolor{stringliteral}{'.nc'}}
\DoxyCodeLine{1325                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Running VQMC at c = ', F12.7, ' to produce single Markov chain...')"{}}\textcolor{comment}{) c\_out}}
\DoxyCodeLine{1326 \textcolor{comment}{}                viz\_steps = min(h2plus\%steps,max\_chain\_len)}
\DoxyCodeLine{1327                 \textcolor{keyword}{call }vqmc\_h\_2\_plus(h2plus\%sigma, viz\_steps, h2plus\%burn\_step\textcolor{comment}{, h2plus\%thin\_step, \&}}
\DoxyCodeLine{1328 \textcolor{comment}{}                    c\_out, r\_a, r\_b, pos\_chain, accept\_out, energy\_chain\textcolor{comment}{, energy\_out, \& }}
\DoxyCodeLine{1329 \textcolor{comment}{}                    variance\_out, dphidc\_chain)}
\DoxyCodeLine{1330                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Writing Markov chain to '}, chainfile}
\DoxyCodeLine{1331                 \textcolor{keyword}{call }write\_h2plus\_equilibration(pos\_chain, energy\_chain,\textcolor{comment}{ chainfile, ierr, h2plus, \&}}
\DoxyCodeLine{1332 \textcolor{comment}{}                    accept\_out, c\_out, bond\_length)}
\DoxyCodeLine{1333 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{1334 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{1335         }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a0a07ef5b098cdc478b253de26c49aadc_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=339pt]{namespacevqmc_a0a07ef5b098cdc478b253de26c49aadc_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_a70c9fcecdf5f2a6ffea7dd3c4f0c1eeb}\label{namespacevqmc_a70c9fcecdf5f2a6ffea7dd3c4f0c1eeb}} 
\index{vqmc@{vqmc}!grid\_h\_2\_plus@{grid\_h\_2\_plus}}
\index{grid\_h\_2\_plus@{grid\_h\_2\_plus}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{grid\_h\_2\_plus()}{grid\_h\_2\_plus()}}
{\footnotesize\ttfamily subroutine vqmc\+::grid\+\_\+h\+\_\+2\+\_\+plus (\begin{DoxyParamCaption}\item[{real(real64), dimension(\+:), intent(in)}]{c\+\_\+array,  }\item[{real(real64), intent(in)}]{bond\+\_\+length,  }\item[{real(real64), intent(out)}]{c\+\_\+out,  }\item[{real(real64), intent(out)}]{energy\+\_\+out,  }\item[{real(real64), intent(out)}]{variance\+\_\+out,  }\item[{real(real64), intent(out)}]{accept\+\_\+out }\end{DoxyParamCaption})}



Performs a grid search to find the optimal value for the variational parameter $ c $ in the $ H_{2}^{+} $ problem. 

Evaluates energy of the $ H_{2}^{+} $ trial wavefunction at each value of the parameter $ c $ in {\bfseries{c\+\_\+array}}. Determines the best energy, and reports its corresponding $ c $ as the optimal value at this bond length. Also returns the variance of this energy as a measure of uncertainty, as well as the acceptance rate of the MCMC chain. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em c\+\_\+array} & Array of c values to be tested \\
\hline
\mbox{\texttt{ in}}  & {\em bond\+\_\+length} & H-\/H bond length \\
\hline
\mbox{\texttt{ out}}  & {\em c\+\_\+out} & Optimised value for c at this bond length \\
\hline
\mbox{\texttt{ out}}  & {\em energy\+\_\+out} & Energy of wavefunction at optimal c \\
\hline
\mbox{\texttt{ out}}  & {\em variance\+\_\+out} & Variance of energy at optimal c \\
\hline
\mbox{\texttt{ out}}  & {\em accept\+\_\+out} & Acceptance rate of MCMC chain at optimal c \\
\hline
\end{DoxyParams}


Definition at line 1359 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{1361     }
\DoxyCodeLine{1362         \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{1363 }
\DoxyCodeLine{1364 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{intent(in)} :: c\_array}
\DoxyCodeLine{1365 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: bond\_length}
\DoxyCodeLine{1366 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: c\_out}
\DoxyCodeLine{1367 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: energy\_out}
\DoxyCodeLine{1368 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: variance\_out}
\DoxyCodeLine{1369 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: accept\_out}
\DoxyCodeLine{1370 }
\DoxyCodeLine{1371 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)} :: R\_a, R\_b}
\DoxyCodeLine{1372 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:, :)}, \textcolor{keywordtype}{allocatable} :: pos\_chain}
\DoxyCodeLine{1373 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energy\_chain, DphiDc\_chain}
\DoxyCodeLine{1374 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: param\_energies, param\_accepts\textcolor{comment}{, param\_variances}}
\DoxyCodeLine{1375 \textcolor{comment}{        }\textcolor{keywordtype}{integer} :: viz\_steps}
\DoxyCodeLine{1376         \textcolor{keywordtype}{integer} :: i}
\DoxyCodeLine{1377         \textcolor{keywordtype}{integer} :: ierr}
\DoxyCodeLine{1378         \textcolor{keywordtype}{character(len=6)} :: str\_b}
\DoxyCodeLine{1379         \textcolor{keywordtype}{character(len=40)} :: chainfile}
\DoxyCodeLine{1380 }
\DoxyCodeLine{1381         \textcolor{comment}{! MPI variables}}
\DoxyCodeLine{1382 \textcolor{keywordtype}{        real}(real64)  :: my\_ensum}
\DoxyCodeLine{1383 }
\DoxyCodeLine{1384         \textcolor{comment}{! Initialise}}
\DoxyCodeLine{1385         r\_a = (/-\/bond\_length/2, 0.0\_real64, 0.0\_real64/)}
\DoxyCodeLine{1386         r\_b = (/bond\_length/2, 0.0\_real64, 0.0\_real64/)}
\DoxyCodeLine{1387         \textcolor{keyword}{allocate}(param\_energies(\textcolor{keyword}{size}(c\_array))); param\_energies(:)= 0.0\_real64}
\DoxyCodeLine{1388         \textcolor{keyword}{allocate}(param\_accepts(\textcolor{keyword}{size}(c\_array))); param\_accepts(:) = 0.0\_real64}
\DoxyCodeLine{1389         \textcolor{keyword}{allocate}(param\_variances(\textcolor{keyword}{size}(c\_array))); param\_variances(:) = 0\textcolor{comment}{.0\_real64}}
\DoxyCodeLine{1390 \textcolor{comment}{}}
\DoxyCodeLine{1391         \textcolor{comment}{! Sort out restarting}}
\DoxyCodeLine{1392         \textcolor{keywordflow}{if} (run\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1393             \textcolor{comment}{! Read in array values}}
\DoxyCodeLine{1394             \textcolor{keyword}{call }read\_energies(resfile\_epar, param\_energies, param\_variances\textcolor{comment}{, param\_accepts)}}
\DoxyCodeLine{1395 \textcolor{comment}{}            \textcolor{comment}{! Reset the tag}}
\DoxyCodeLine{1396             run\_restart = .false.}
\DoxyCodeLine{1397 \textcolor{keywordflow}{        endif} }
\DoxyCodeLine{1398 }
\DoxyCodeLine{1399         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1400             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Starting parameter search for c...')"{}})}
\DoxyCodeLine{1401 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{1402 }
\DoxyCodeLine{1403         \textcolor{comment}{! Loop over c values}}
\DoxyCodeLine{1404         \textcolor{keywordflow}{do} i = grid\_start, \textcolor{keyword}{size}(c\_array)}
\DoxyCodeLine{1405 }
\DoxyCodeLine{1406             \textcolor{comment}{! Calculate energy at current value of c}}
\DoxyCodeLine{1407             \textcolor{keyword}{call }vqmc\_h\_2\_plus(h2plus\%sigma, my\_steps+h2plus\%burn\_step, h2plus\%burn\_step\textcolor{comment}{, h2plus\%thin\_step, \&}}
\DoxyCodeLine{1408 \textcolor{comment}{}                c\_array(i), r\_a, r\_b, pos\_chain, accept\_out, energy\_chain\textcolor{comment}{, energy\_out, \&}}
\DoxyCodeLine{1409 \textcolor{comment}{}                variance\_out, dphidc\_chain)}
\DoxyCodeLine{1410 }
\DoxyCodeLine{1411             \textcolor{comment}{! Save energy -\/ serial version}}
\DoxyCodeLine{1412             \textcolor{comment}{!param\_energies(i) = energy}}
\DoxyCodeLine{1413             \textcolor{comment}{!param\_variances(i) = variance}}
\DoxyCodeLine{1414             \textcolor{comment}{!param\_accepts(i) = accept\_rate}}
\DoxyCodeLine{1415 }
\DoxyCodeLine{1416             \textcolor{comment}{! Sum the chain energy-\/sums and store in rank 0}}
\DoxyCodeLine{1417             my\_ensum = sum(energy\_chain)}
\DoxyCodeLine{1418             \textcolor{keyword}{call }mpi\_reduce(my\_ensum,param\_energies(i),1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{1419 \textcolor{comment}{}}
\DoxyCodeLine{1420             \textcolor{comment}{! Sum the chain variances and store in rank 0}}
\DoxyCodeLine{1421             \textcolor{keyword}{call }mpi\_reduce(variance\_out,param\_variances(i),1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{1422 \textcolor{comment}{}}
\DoxyCodeLine{1423             \textcolor{comment}{! Sum the chain acceptance rates and store in rank 0}}
\DoxyCodeLine{1424             \textcolor{keyword}{call }mpi\_reduce(accept\_out,param\_accepts(i),1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{1425 \textcolor{comment}{}}
\DoxyCodeLine{1426             \textcolor{comment}{! Calculate averages on rank 0}}
\DoxyCodeLine{1427             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1428                 param\_energies(i) = param\_energies(i) * per\_step}
\DoxyCodeLine{1429                 param\_variances(i) = param\_variances(i) * per\_proc2 }
\DoxyCodeLine{1430                 param\_accepts(i) = param\_accepts(i) * per\_proc}
\DoxyCodeLine{1431 }
\DoxyCodeLine{1432                 \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{1433                 \textcolor{keywordflow}{if} (write\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1434                     \textcolor{keywordflow}{if} (mod(i,restart\_num)==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1435                         \textcolor{comment}{! Write res\_nml.txt}}
\DoxyCodeLine{1436                         \textcolor{keyword}{call }write\_res\_nml(i\_bond,i+1,h2plus\%auto\_params\textcolor{comment}{)}}
\DoxyCodeLine{1437 \textcolor{comment}{}                        \textcolor{comment}{! Write param energies, variances and acceptance rates}}
\DoxyCodeLine{1438                         \textcolor{keyword}{call }write\_qho\_main(c\_array, param\_energies, param\_variances\textcolor{comment}{, resfile\_epar, ierr, qho, param\_accepts)}}
\DoxyCodeLine{1439 \textcolor{comment}{}\textcolor{keywordflow}{                    endif}}
\DoxyCodeLine{1440 \textcolor{keywordflow}{                endif} }
\DoxyCodeLine{1441 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{1442 }
\DoxyCodeLine{1443 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{1444 }
\DoxyCodeLine{1445         \textcolor{comment}{! Compile final results of grid search on rank 0}}
\DoxyCodeLine{1446         \textcolor{comment}{! Note: Only rank 0 has the correct \_out values.}}
\DoxyCodeLine{1447         \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1448 }
\DoxyCodeLine{1449             \textcolor{comment}{! Select lowest energy and corresponding c value}}
\DoxyCodeLine{1450             energy\_out = minval(param\_energies)}
\DoxyCodeLine{1451             c\_out = c\_array(minloc(param\_energies, 1))}
\DoxyCodeLine{1452             variance\_out = param\_variances(minloc(param\_energies, 1))}
\DoxyCodeLine{1453             accept\_out = param\_accepts(minloc(param\_energies, 1))}
\DoxyCodeLine{1454 }
\DoxyCodeLine{1455             \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(F12.8, '   -\/             ', F13.7, '      ', F12.8)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{1456 \textcolor{comment}{}                bond\_length, c\_out, energy\_out}
\DoxyCodeLine{1457 }
\DoxyCodeLine{1458             \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1459                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Results:')"{}})}
\DoxyCodeLine{1460                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('c                Energy')"{}})}
\DoxyCodeLine{1461                 \textcolor{keywordflow}{do} i = 1, \textcolor{keyword}{size}(c\_array)}
\DoxyCodeLine{1462                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(F12.8, '    ', F12.8)"{}}) c\_array(i), param\_energies\textcolor{comment}{(i)}}
\DoxyCodeLine{1463 \textcolor{comment}{}\textcolor{keywordflow}{                end do}}
\DoxyCodeLine{1464                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{1465                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Min Energy = ', F12.8, ' at c = ', F12.8)"{}}\textcolor{comment}{) energy\_out, c\_out}}
\DoxyCodeLine{1466 \textcolor{comment}{}                \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{1467 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{1468 }
\DoxyCodeLine{1469             \textcolor{comment}{! Run a new visualisation chain at the optimised parameter if write\_chains is enabled.}}
\DoxyCodeLine{1470             \textcolor{keywordflow}{if} (write\_chains) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1471                 \textcolor{keyword}{write}(str\_b, \textcolor{stringliteral}{"{}(F6.3)"{}}) bond\_length}
\DoxyCodeLine{1472                 \textcolor{keyword}{write}(chainfile, \textcolor{stringliteral}{"{}(3A)"{}}) \textcolor{stringliteral}{'./chains\_out/bond\_'}, trim(adjustl\textcolor{comment}{(str\_b)), }\textcolor{stringliteral}{'.nc'}}
\DoxyCodeLine{1473                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Running VQMC at c = ', F12.7, ' to produce single Markov chain...')"{}}\textcolor{comment}{) c\_out}}
\DoxyCodeLine{1474 \textcolor{comment}{}                viz\_steps = min(h2plus\%steps,max\_chain\_len)}
\DoxyCodeLine{1475                 \textcolor{keyword}{call }vqmc\_h\_2\_plus(h2plus\%sigma, viz\_steps, h2plus\%burn\_step\textcolor{comment}{, h2plus\%thin\_step, \&}}
\DoxyCodeLine{1476 \textcolor{comment}{}                    c\_out, r\_a, r\_b, pos\_chain, accept\_out, energy\_chain\textcolor{comment}{, energy\_out, \& }}
\DoxyCodeLine{1477 \textcolor{comment}{}                    variance\_out, dphidc\_chain)}
\DoxyCodeLine{1478                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Writing Markov chain to '}, chainfile}
\DoxyCodeLine{1479                 \textcolor{keyword}{call }write\_h2plus\_equilibration(pos\_chain, energy\_chain,\textcolor{comment}{ chainfile, ierr, h2plus, \&}}
\DoxyCodeLine{1480 \textcolor{comment}{}                    accept\_out, c\_out, bond\_length)}
\DoxyCodeLine{1481 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{1482 }
\DoxyCodeLine{1483 \textcolor{keywordflow}{        endif} }
\DoxyCodeLine{1484     }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a70c9fcecdf5f2a6ffea7dd3c4f0c1eeb_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=336pt]{namespacevqmc_a70c9fcecdf5f2a6ffea7dd3c4f0c1eeb_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_a169c06cb168984ca6285231ad80a0243}\label{namespacevqmc_a169c06cb168984ca6285231ad80a0243}} 
\index{vqmc@{vqmc}!equil\_h\_2\_plus@{equil\_h\_2\_plus}}
\index{equil\_h\_2\_plus@{equil\_h\_2\_plus}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{equil\_h\_2\_plus()}{equil\_h\_2\_plus()}}
{\footnotesize\ttfamily subroutine vqmc\+::equil\+\_\+h\+\_\+2\+\_\+plus (\begin{DoxyParamCaption}\item[{real(real64), dimension(\+:), intent(in)}]{c\+\_\+array,  }\item[{real(real64), intent(in)}]{bond\+\_\+length,  }\item[{integer, intent(in)}]{bonds\+\_\+pos }\end{DoxyParamCaption})}



Performs VQMC on an array of values for the variational parameter $ c $, outputting energy traces for each. 

Generates VQMC position and energy traces of the $ H_{2}^{+} $ trial wavefunction at each value of the parameter $ c $ in {\bfseries{c\+\_\+array}}. Outputs each of these traces to a separate Net\+CDF file, to be used in determining optimal burning/thinning paramters for an accurate full VQMC run. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em c\+\_\+array} & The array of c values to obtain energy traces for \\
\hline
\mbox{\texttt{ in}}  & {\em bond\+\_\+length} & The current H-\/H bond length \\
\hline
\mbox{\texttt{ in}}  & {\em bonds\+\_\+pos} & The position in the array of bond lengths, to be used in designating output files \\
\hline
\end{DoxyParams}


Definition at line 1505 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{1506 }
\DoxyCodeLine{1507         \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{1508 }
\DoxyCodeLine{1509 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{intent(in)} :: c\_array}
\DoxyCodeLine{1510 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: bond\_length}
\DoxyCodeLine{1511         \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: bonds\_pos}
\DoxyCodeLine{1512 }
\DoxyCodeLine{1513 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)} :: R\_a, R\_b}
\DoxyCodeLine{1514 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: variances}
\DoxyCodeLine{1515 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energies}
\DoxyCodeLine{1516 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energy\_chain}
\DoxyCodeLine{1517 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:, :)}, \textcolor{keywordtype}{allocatable} :: pos\_chain}
\DoxyCodeLine{1518 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: DphiDc\_chain}
\DoxyCodeLine{1519 \textcolor{keywordtype}{        real}(real64) :: accept\_rate}
\DoxyCodeLine{1520 \textcolor{keywordtype}{        real}(real64) :: energy\_variance}
\DoxyCodeLine{1521         \textcolor{keywordtype}{integer} :: i, ierr}
\DoxyCodeLine{1522         \textcolor{keywordtype}{character(len=3)} :: str\_i, str\_b}
\DoxyCodeLine{1523         \textcolor{keywordtype}{character(len=40)} :: equilfile}
\DoxyCodeLine{1524 }
\DoxyCodeLine{1525         \textcolor{comment}{! Initialise}}
\DoxyCodeLine{1526         r\_a = (/-\/bond\_length/2, 0.0\_real64, 0.0\_real64/)}
\DoxyCodeLine{1527         r\_b = (/bond\_length/2, 0.0\_real64, 0.0\_real64/)}
\DoxyCodeLine{1528         \textcolor{keyword}{allocate}(energies(\textcolor{keyword}{size}(c\_array))); energies(:) = 0.0\_real64}
\DoxyCodeLine{1529         \textcolor{keyword}{allocate}(variances(\textcolor{keyword}{size}(c\_array)))}
\DoxyCodeLine{1530 }
\DoxyCodeLine{1531         \textcolor{comment}{! Loop over values of c}}
\DoxyCodeLine{1532         \textcolor{keywordflow}{do} i = grid\_start, \textcolor{keyword}{size}(c\_array)}
\DoxyCodeLine{1533 }
\DoxyCodeLine{1534             \textcolor{comment}{! Calculate energy at current value of c}}
\DoxyCodeLine{1535             \textcolor{keyword}{call }vqmc\_h\_2\_plus(h2plus\%sigma, h2plus\%steps, h2plus\%burn\_step\textcolor{comment}{, h2plus\%thin\_step, \&}}
\DoxyCodeLine{1536 \textcolor{comment}{}                c\_array(i), r\_a, r\_b, pos\_chain, accept\_rate, energy\_chain\textcolor{comment}{,energies(i), \&}}
\DoxyCodeLine{1537 \textcolor{comment}{}                energy\_variance, dphidc\_chain)}
\DoxyCodeLine{1538 }
\DoxyCodeLine{1539             \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(F12.8, '   -\/             ', F13.7, '      ', F12.8)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{1540 \textcolor{comment}{}                bond\_length, c\_array(i), energies(i)}
\DoxyCodeLine{1541 }
\DoxyCodeLine{1542             \textcolor{comment}{! Save the energy trace for each value of c}}
\DoxyCodeLine{1543             \textcolor{keyword}{write}(str\_i, \textcolor{stringliteral}{"{}(I3)"{}}) i}
\DoxyCodeLine{1544             \textcolor{keyword}{write}(str\_b, \textcolor{stringliteral}{"{}(I3)"{}}) bonds\_pos}
\DoxyCodeLine{1545             \textcolor{keyword}{write}(equilfile, \textcolor{stringliteral}{"{}(5A)"{}}) \textcolor{stringliteral}{'./equil\_out/b'}, trim(adjustl(str\_b\textcolor{comment}{)), \&}}
\DoxyCodeLine{1546 \textcolor{comment}{}                \textcolor{stringliteral}{'\_c'}, trim(adjustl(str\_i)), \textcolor{stringliteral}{'.nc'}}
\DoxyCodeLine{1547             \textcolor{keyword}{write}(*, *) \textcolor{stringliteral}{'Writing equilibration outfile to '}, equilfile}
\DoxyCodeLine{1548             \textcolor{keyword}{call }write\_h2plus\_equilibration(pos\_chain, energy\_chain, equilfile\textcolor{comment}{, ierr, h2plus, \&}}
\DoxyCodeLine{1549 \textcolor{comment}{}                accept\_rate, c\_array(i), bond\_length)}
\DoxyCodeLine{1550 }
\DoxyCodeLine{1551             \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{1552             \textcolor{keywordflow}{if} (write\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1553                 \textcolor{keywordflow}{if} (mod(i,restart\_num)==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1554                     \textcolor{keyword}{call }write\_res\_nml(i\_bond,i+1,h2\%auto\_params)}
\DoxyCodeLine{1555 \textcolor{keywordflow}{                endif}}
\DoxyCodeLine{1556 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{1557 }
\DoxyCodeLine{1558 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{1559 }
\DoxyCodeLine{1560         \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1561             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Results:')"{}})}
\DoxyCodeLine{1562             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('c                Energy')"{}})}
\DoxyCodeLine{1563             \textcolor{keywordflow}{do} i = 1, \textcolor{keyword}{size}(c\_array)}
\DoxyCodeLine{1564                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(F12.8, '    ', F12.8)"{}}) c\_array(i), energies\textcolor{comment}{(i)}}
\DoxyCodeLine{1565 \textcolor{comment}{}\textcolor{keywordflow}{            end do}}
\DoxyCodeLine{1566             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{1567 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{1568 }
\DoxyCodeLine{1569         \textcolor{keyword}{deallocate}(energies)}
\DoxyCodeLine{1570         \textcolor{keyword}{deallocate}(variances)}
\DoxyCodeLine{1571     }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a169c06cb168984ca6285231ad80a0243_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=341pt]{namespacevqmc_a169c06cb168984ca6285231ad80a0243_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_a12f60b20a934a7eb8c6e3cdaaac0b1cc}\label{namespacevqmc_a12f60b20a934a7eb8c6e3cdaaac0b1cc}} 
\index{vqmc@{vqmc}!vqmc\_h\_2@{vqmc\_h\_2}}
\index{vqmc\_h\_2@{vqmc\_h\_2}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{vqmc\_h\_2()}{vqmc\_h\_2()}}
{\footnotesize\ttfamily subroutine vqmc\+::vqmc\+\_\+h\+\_\+2 (\begin{DoxyParamCaption}\item[{real(real64), intent(in)}]{sigma,  }\item[{integer, intent(in)}]{N,  }\item[{integer, intent(in)}]{burn,  }\item[{integer, intent(in)}]{thin,  }\item[{real(real64), intent(in)}]{a,  }\item[{real(real64), intent(in)}]{beta,  }\item[{real(real64), dimension(3), intent(in)}]{R\+\_\+a,  }\item[{real(real64), dimension(3), intent(in)}]{R\+\_\+b,  }\item[{real(real64), dimension(\+:, \+:), intent(out), allocatable}]{X\+\_\+1\+\_\+burnt,  }\item[{real(real64), dimension(\+:, \+:), intent(out), allocatable}]{X\+\_\+2\+\_\+burnt,  }\item[{real(real64), intent(out)}]{accept\+\_\+rate,  }\item[{real(real64), dimension(\+:), intent(out), allocatable}]{energy\+\_\+chain,  }\item[{real(real64), intent(out)}]{energy\+\_\+mean,  }\item[{real(real64), intent(out)}]{energy\+\_\+variance,  }\item[{real(real64), dimension(\+:), intent(out), allocatable}]{Dphi\+Dbeta\+\_\+chain,  }\item[{real(real64), dimension(3), optional}]{x\+\_\+start\+\_\+1,  }\item[{real(real64), dimension(3), optional}]{x\+\_\+start\+\_\+2 }\end{DoxyParamCaption})}



Performs VQMC for the $ H_{2}^{+} $ system. ~\newline
 

Computes the total energy of a trial wavefunction by averaging over a Markov chain of local energies generated by \mbox{\hyperlink{namespacesolvers_a9afbcdcc0405d544d4441e9786f440a2}{H\+\_\+2\+\_\+\+Energy}}, with random move acceptance/rejection probability determined by \mbox{\hyperlink{namespacesolvers_ac30d1c7141f673647e837524ecb26b07}{H\+\_\+2\+\_\+\+Prob}}. The H-\/H bond length can be changed by modifying the hydrogen atom positions {\bfseries{R\+\_\+a}} and {\bfseries{R\+\_\+b}}. Also outputs the gradient with respect to the variational parameter $ \beta $ at each step in the chain, to be used in \mbox{\hyperlink{namespacevqmc_a70dc752a6b037f137c1264dd8753bac2}{Auto\+\_\+\+H\+\_\+2}}.

Allows for modification of total Markov chain length, as well as the number of steps to be \textquotesingle{}burned\textquotesingle{} while the chain is equilibrating and the interval to \textquotesingle{}thin\textquotesingle{} the chain over to reduce correlation of samples. The size of the proposed random moves can be controlled by modifying the {\bfseries{sigma}} parameter to get an ideal move acceptance rate. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em sigma} & Step size \\
\hline
\mbox{\texttt{ in}}  & {\em N} & Number of steps to take \\
\hline
\mbox{\texttt{ in}}  & {\em burn} & Number of sample to discard at the beginning \\
\hline
\mbox{\texttt{ in}}  & {\em thin} & The frequency at which we discard the samples from the MCMC chain after burning ~\newline
 \\
\hline
\mbox{\texttt{ in}}  & {\em a} & Parameter a of trial wavefunction \\
\hline
\mbox{\texttt{ in}}  & {\em beta} & Parameter beta of trial wavefunction \\
\hline
\mbox{\texttt{ in}}  & {\em R\+\_\+a} & Position of hydrogen atom A \\
\hline
\mbox{\texttt{ in}}  & {\em R\+\_\+b} & Position of hydrogen atom B \\
\hline
\mbox{\texttt{ in}}  & {\em x\+\_\+start\+\_\+1} & Starting point of 1st MCMC chain (optional, default is randomly generated) \\
\hline
\mbox{\texttt{ in}}  & {\em x\+\_\+start\+\_\+2} & Starting point of 2nd MCMC chain (optional, default is randomly generated) \\
\hline
\mbox{\texttt{ out}}  & {\em X\+\_\+1\+\_\+burnt} & The burnt and thinned MCMC chain for random walker 1 \\
\hline
\mbox{\texttt{ out}}  & {\em X\+\_\+2\+\_\+burnt} & The burnt and thinned MCMC chain for random walker 2 \\
\hline
\mbox{\texttt{ out}}  & {\em accept\+\_\+rate} & The acceptance rate of the MCMC chain \\
\hline
\mbox{\texttt{ out}}  & {\em energy\+\_\+chain} & An array with the local energies of the each points in the MCMC chains \\
\hline
\mbox{\texttt{ out}}  & {\em energy\+\_\+mean} & The average of the local energies recorded in {\bfseries{energy\+\_\+chain}} \\
\hline
\mbox{\texttt{ out}}  & {\em energy\+\_\+variance} & The variance of the local energies recorded in {\bfseries{energy\+\_\+chain}} \\
\hline
\mbox{\texttt{ out}}  & {\em Dphi\+Dbeta\+\_\+chain} & Array of the gradients with respect to $ \beta $ at each point in the MCMC chain \\
\hline
\end{DoxyParams}


Definition at line 1617 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{1620 }
\DoxyCodeLine{1621         \textcolor{keywordtype}{implicit none} }
\DoxyCodeLine{1622 }
\DoxyCodeLine{1623 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)}, \textcolor{keywordtype}{dimension(3)} :: R\_a, R\_b}
\DoxyCodeLine{1624 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: sigma}
\DoxyCodeLine{1625 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: a, beta}
\DoxyCodeLine{1626 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)}, \textcolor{keywordtype}{optional} :: x\_start\_1, x\_start\_2}
\DoxyCodeLine{1627         \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: N, burn, thin }
\DoxyCodeLine{1628         }
\DoxyCodeLine{1629          }
\DoxyCodeLine{1630 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: accept\_rate, energy\_mean, energy\_variance}
\DoxyCodeLine{1631 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)}, \textcolor{keywordtype}{dimension(:, :)}, \textcolor{keywordtype}{allocatable} :: X\_1\_burnt\textcolor{comment}{, X\_2\_burnt}}
\DoxyCodeLine{1632 \textcolor{comment}{}\textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energy\_chain}
\DoxyCodeLine{1633 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)}, \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: DphiDbeta\_chain}
\DoxyCodeLine{1634 }
\DoxyCodeLine{1635 \textcolor{keywordtype}{        real}(real64) :: E\_loc                                    \textcolor{comment}{! Local energy at current MCMC walker position}}
\DoxyCodeLine{1636 \textcolor{keywordtype}{        real}(real64) :: DphiDbeta                                \textcolor{comment}{! Gradient wrt beta at current MCMC walker position}}
\DoxyCodeLine{1637 \textcolor{keywordtype}{        real}(real64) :: log\_prob\_n                               \textcolor{comment}{! The natural logarithm of the transition proability }}
\DoxyCodeLine{1638 \textcolor{keywordtype}{        real}(real64) :: a\_prob\_trans                             \textcolor{comment}{! Acceptance ratio of the transitional probability                   }}
\DoxyCodeLine{1639 \textcolor{keywordtype}{        real}(real64) :: unif\_num                                 \textcolor{comment}{! A random sample from the uniform distribution}}
\DoxyCodeLine{1640 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)} :: start\_1, start\_2           \textcolor{comment}{! Starting points for the random walkers }}
\DoxyCodeLine{1641 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)} :: X\_n\_1, X\_n\_2               \textcolor{comment}{! The propsed steps for the random walkers }}
\DoxyCodeLine{1642 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)} :: sample\_normal              \textcolor{comment}{! Sample from the normal distribution }}
\DoxyCodeLine{1643 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:, :)}, \textcolor{keywordtype}{allocatable} :: X\_1, X\_2   \textcolor{comment}{! Full MCMC chains }}
\DoxyCodeLine{1644         \textcolor{keywordtype}{integer} :: accept                                        \textcolor{comment}{! Number of accepted steps }}
\DoxyCodeLine{1645         \textcolor{keywordtype}{integer} :: thin\_counter                                  \textcolor{comment}{! Counter to keep track of the thinning process}}
\DoxyCodeLine{1646         \textcolor{keywordtype}{integer} :: reset\_counter                                 \textcolor{comment}{! Counts how many times thin counter was reset}}
\DoxyCodeLine{1647         \textcolor{keywordtype}{integer} :: re\_size                                       \textcolor{comment}{! The size of the burnt and thinned array}}
\DoxyCodeLine{1648         \textcolor{keywordtype}{integer} :: i\_bt                                          \textcolor{comment}{! Burned/thinned value of i}}
\DoxyCodeLine{1649         \textcolor{keywordtype}{integer} :: i                                             \textcolor{comment}{! Loop variable }}
\DoxyCodeLine{1650         \textcolor{keywordtype}{character(len=1)} :: acceptance                           \textcolor{comment}{! Yes/No signpost for acceptance}}
\DoxyCodeLine{1651         }
\DoxyCodeLine{1652         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1653             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Markov chain for beta = ', F7.4)"{}}) beta}
\DoxyCodeLine{1654             \textcolor{keywordflow}{if} (.not. run\_equil) \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Logging the chain from Rank 0.')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{1655 \textcolor{comment}{}\textcolor{keywordflow}{        endif} }
\DoxyCodeLine{1656 }
\DoxyCodeLine{1657         \textcolor{comment}{! Adjust the output array to be of the burnt and thinned array}}
\DoxyCodeLine{1658         re\_size = (n -\/ burn) / thin }
\DoxyCodeLine{1659 }
\DoxyCodeLine{1660         \textcolor{keyword}{allocate}(x\_1(3, 1:n+1)); x\_1(:, :) = 0.0\_real64}
\DoxyCodeLine{1661         \textcolor{keyword}{allocate}(x\_2(3, 1:n+1)); x\_2(:, :) = 0.0\_real64}
\DoxyCodeLine{1662         \textcolor{keyword}{allocate}(x\_1\_burnt(3, 1:re\_size)); x\_1\_burnt(:, :) = 0.0\_real64}
\DoxyCodeLine{1663         \textcolor{keyword}{allocate}(x\_2\_burnt(3, 1:re\_size)); x\_2\_burnt(:, :) = 0.0\_real64}
\DoxyCodeLine{1664         \textcolor{keyword}{allocate}(energy\_chain(1:re\_size)); energy\_chain(:) = 0.0\_real64}
\DoxyCodeLine{1665         \textcolor{keyword}{allocate}(dphidbeta\_chain(1:re\_size)); dphidbeta\_chain(:) = 0.0\_real64}
\DoxyCodeLine{1666 }
\DoxyCodeLine{1667         \textcolor{comment}{! Allow the starting position to take on the default value }}
\DoxyCodeLine{1668         \textcolor{keywordflow}{if} (\textcolor{keyword}{present}(x\_start\_1) .and. \textcolor{keyword}{present}(x\_start\_2)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1669             start\_1 = x\_start\_1}
\DoxyCodeLine{1670             x\_1(:,1) = start\_1}
\DoxyCodeLine{1671             }
\DoxyCodeLine{1672             start\_2 = x\_start\_2}
\DoxyCodeLine{1673             x\_2(:,1) = start\_2}
\DoxyCodeLine{1674 }
\DoxyCodeLine{1675             \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1676                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Starting from provided Markov chain position:')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{1677 \textcolor{comment}{}                \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('    x1 = ', F12.8, ' y1 = ', F12.8, ' z1 = ', F12.8)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{1678 \textcolor{comment}{}                    x\_1(1, 1), x\_1(2, 1), x\_1(3, 1)}
\DoxyCodeLine{1679                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('    x2 = ', F12.8, ' y2 = ', F12.8, ' z2 = ', F12.8)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{1680 \textcolor{comment}{}                    x\_2(1, 1), x\_2(2, 1), x\_2(3, 1)}
\DoxyCodeLine{1681 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{1682         \textcolor{keywordflow}{else} }
\DoxyCodeLine{1683             \textcolor{comment}{! Create the initial position of random walker 1 that is within a certain radius}}
\DoxyCodeLine{1684             \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{1685             \textcolor{keywordflow}{do} \textcolor{keywordflow}{while}(norm2(sample\_normal) >= h2\%rcut)}
\DoxyCodeLine{1686                 \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{1687 \textcolor{keywordflow}{            end do} }
\DoxyCodeLine{1688             start\_1 = sample\_normal}
\DoxyCodeLine{1689             x\_1(:,1) = start\_1}
\DoxyCodeLine{1690 }
\DoxyCodeLine{1691             \textcolor{comment}{! Create the initial position of random walker 2 that is within a certain radius}}
\DoxyCodeLine{1692             \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{1693             \textcolor{keywordflow}{do} \textcolor{keywordflow}{while}(norm2(sample\_normal) >= h2\%rcut)}
\DoxyCodeLine{1694                 \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{1695 \textcolor{keywordflow}{            end do} }
\DoxyCodeLine{1696             start\_2 = sample\_normal }
\DoxyCodeLine{1697             x\_2(:,1) = start\_2}
\DoxyCodeLine{1698 \textcolor{keywordflow}{        end if} }
\DoxyCodeLine{1699         }
\DoxyCodeLine{1700         \textcolor{comment}{! Start the counter for the number of accepted moves}}
\DoxyCodeLine{1701         accept = 0  }
\DoxyCodeLine{1702         \textcolor{comment}{! Start the counter for the thinning process}}
\DoxyCodeLine{1703         thin\_counter = 0}
\DoxyCodeLine{1704         \textcolor{comment}{! Start the reset counter }}
\DoxyCodeLine{1705         reset\_counter = 0}
\DoxyCodeLine{1706 }
\DoxyCodeLine{1707         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1708             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Sample      X1              Y1             Z1             \&}}
\DoxyCodeLine{1709 \textcolor{stringliteral}{}\textcolor{stringliteral}{                \&X2              Y2             Z2             \&}}
\DoxyCodeLine{1710 \textcolor{stringliteral}{}\textcolor{stringliteral}{                \&Local Energy     Accepted?')"{}})}
\DoxyCodeLine{1711             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.8, '   ', F12.8, '   ', F12.8, \&}}
\DoxyCodeLine{1712 \textcolor{stringliteral}{}\textcolor{stringliteral}{                \&'   ', F12.8, '   ', F12.8, ' ', F12.6)"{}}) 1, x\_1(1, 1),\textcolor{comment}{ x\_1(2, 1), x\_1(3, 1),\&}}
\DoxyCodeLine{1713 \textcolor{comment}{}                x\_2(1, 1), x\_2(2, 1), x\_2(3, 1), energy\_chain(1)}
\DoxyCodeLine{1714 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{1715 }
\DoxyCodeLine{1716         \textcolor{comment}{! Calculate the local energy of the initial step if not burnt}}
\DoxyCodeLine{1717         \textcolor{keywordflow}{if} (burn == 0) \textcolor{keywordflow}{then} }
\DoxyCodeLine{1718             \textcolor{keyword}{call }h\_2\_energy(a, beta, x\_1(:,1), x\_2(:,1), r\_a, r\_b, e\_loc\textcolor{comment}{, dphidbeta)}}
\DoxyCodeLine{1719 \textcolor{comment}{}            energy\_chain(1) = e\_loc}
\DoxyCodeLine{1720             dphidbeta\_chain(1) = dphidbeta}
\DoxyCodeLine{1721             x\_1\_burnt(:, 1) = x\_1(:, 1)}
\DoxyCodeLine{1722             x\_2\_burnt(:, 1) = x\_2(:, 1)}
\DoxyCodeLine{1723 }
\DoxyCodeLine{1724             \textcolor{keywordflow}{do} i = 2, n }
\DoxyCodeLine{1725                 \textcolor{comment}{! Initialize thin counter }}
\DoxyCodeLine{1726                 thin\_counter = 1 + thin\_counter}
\DoxyCodeLine{1727 }
\DoxyCodeLine{1728                 \textcolor{comment}{! Propose the next step for random walker 1 }}
\DoxyCodeLine{1729                 \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{1730                 x\_n\_1 = x\_1(:, i-\/1) + sigma * sample\_normal}
\DoxyCodeLine{1731 }
\DoxyCodeLine{1732                 \textcolor{comment}{! Propose the next step for random walker 2 }}
\DoxyCodeLine{1733                 \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{1734                 x\_n\_2 = x\_2(:, i-\/1) + sigma * sample\_normal}
\DoxyCodeLine{1735 }
\DoxyCodeLine{1736                 \textcolor{comment}{! Calculate the transition probability between the proposed steps and current steps}}
\DoxyCodeLine{1737                 log\_prob\_n = log(h\_2\_prob(a, beta, x\_1(:, i-\/1), x\_2(:, i\textcolor{comment}{-\/1), x\_n\_1, x\_n\_2, r\_a, r\_b))}}
\DoxyCodeLine{1738 \textcolor{comment}{}}
\DoxyCodeLine{1739                 \textcolor{comment}{! Calculate the acceptance ratio}}
\DoxyCodeLine{1740                 a\_prob\_trans = min(1.0\_real64, exp(log\_prob\_n))}
\DoxyCodeLine{1741 }
\DoxyCodeLine{1742                 \textcolor{comment}{! Generate sample from uniform distribution}}
\DoxyCodeLine{1743                 \textcolor{keyword}{call }ran1(unif\_num, seed)}
\DoxyCodeLine{1744 }
\DoxyCodeLine{1745                 \textcolor{comment}{! Compare the drawn sample from the uniform distribution with the acceptance ratio}}
\DoxyCodeLine{1746                 \textcolor{keywordflow}{if} (a\_prob\_trans >= unif\_num) \textcolor{keywordflow}{then} }
\DoxyCodeLine{1747                     \textcolor{comment}{! If accepted calculate local energy and add proposed position to the MCMC chain}}
\DoxyCodeLine{1748                     x\_1(:, i) = x\_n\_1}
\DoxyCodeLine{1749                     x\_2(:, i) = x\_n\_2 }
\DoxyCodeLine{1750 }
\DoxyCodeLine{1751                     \textcolor{comment}{! To determine whether this point should be added to the burnt and thinned MCMC chain                                        }}
\DoxyCodeLine{1752                     \textcolor{keywordflow}{if} ((i > (burn + 1)) .and. (thin\_counter == thin)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1753                         \textcolor{comment}{! Increment the reset counter }}
\DoxyCodeLine{1754                         reset\_counter = 1 + reset\_counter}
\DoxyCodeLine{1755                         \textcolor{comment}{! Precalculate i\_bt for shorthand}}
\DoxyCodeLine{1756                         i\_bt = i -\/ burn -\/ (reset\_counter * (thin -\/ 1))}
\DoxyCodeLine{1757                         \textcolor{comment}{! Add to the burn and thinned MCMC chain}}
\DoxyCodeLine{1758                         x\_1\_burnt(:, i\_bt) = x\_n\_1}
\DoxyCodeLine{1759                         x\_2\_burnt(:, i\_bt) = x\_n\_2}
\DoxyCodeLine{1760                         \textcolor{comment}{! Calculate the local energy at this point }}
\DoxyCodeLine{1761                         \textcolor{keyword}{call }h\_2\_energy(a, beta, x\_n\_1, x\_n\_2, r\_a, r\_b,\textcolor{comment}{ e\_loc, dphidbeta)}}
\DoxyCodeLine{1762 \textcolor{comment}{}                        energy\_chain(i\_bt) = e\_loc}
\DoxyCodeLine{1763                         dphidbeta\_chain(i\_bt) = dphidbeta}
\DoxyCodeLine{1764                         \textcolor{comment}{! Resetting the thin counter }}
\DoxyCodeLine{1765                         thin\_counter = 0}
\DoxyCodeLine{1766 }
\DoxyCodeLine{1767                         \textcolor{comment}{! Increment the number of accepted steps }}
\DoxyCodeLine{1768                         accept = 1 + accept }
\DoxyCodeLine{1769                         acceptance = \textcolor{stringliteral}{'Y'}}
\DoxyCodeLine{1770 }
\DoxyCodeLine{1771                         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1772                             \textcolor{keywordflow}{if} (mod(i\_bt, re\_size/logfrac) .le. 1e-\/6\_real64\textcolor{comment}{) }\textcolor{keywordflow}{then}}
\DoxyCodeLine{1773                                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.8, '   ', F12.8,\&}}
\DoxyCodeLine{1774 \textcolor{stringliteral}{}\textcolor{stringliteral}{                                    \& '   ', F12.8, '   ', F12.8, '   ', F12.8, ' ', F12.6, '         ', A1)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{1775 \textcolor{comment}{}                                    (i-\/burn), x\_1\_burnt(1, i-\/burn), x\_1\_burnt\textcolor{comment}{(2, i-\/burn), x\_1\_burnt(3, i-\/burn),\&}}
\DoxyCodeLine{1776 \textcolor{comment}{}                                    x\_2\_burnt(1, i-\/burn), x\_2\_burnt(2, i\textcolor{comment}{-\/burn), x\_2\_burnt(3, i-\/burn),\&}}
\DoxyCodeLine{1777 \textcolor{comment}{}                                    energy\_chain(i-\/burn), acceptance}
\DoxyCodeLine{1778 \textcolor{keywordflow}{                            end if}}
\DoxyCodeLine{1779 \textcolor{keywordflow}{                        end if}}
\DoxyCodeLine{1780 \textcolor{keywordflow}{                    end if} }
\DoxyCodeLine{1781                 \textcolor{keywordflow}{else} }
\DoxyCodeLine{1782                     \textcolor{comment}{! If rejected the proposed step is the current step }}
\DoxyCodeLine{1783                     x\_1(:, i) = x\_1(:, i-\/1)}
\DoxyCodeLine{1784                     x\_2(:, i) = x\_2(:, i-\/1) }
\DoxyCodeLine{1785                 }
\DoxyCodeLine{1786                     \textcolor{comment}{! To determine whether this point should be added to the burnt and thinned MCMC chain}}
\DoxyCodeLine{1787                     \textcolor{keywordflow}{if} ((i > (burn + 1)) .and. (thin\_counter == thin)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1788                         \textcolor{comment}{! Increment the reset counter }}
\DoxyCodeLine{1789                         reset\_counter = 1 + reset\_counter}
\DoxyCodeLine{1790                         \textcolor{comment}{! Precalculate i\_bt for shorthand}}
\DoxyCodeLine{1791                         i\_bt = i -\/ burn -\/ (reset\_counter * (thin -\/ 1))}
\DoxyCodeLine{1792                         \textcolor{comment}{! Add to the burn and thinned MCMC chain}}
\DoxyCodeLine{1793                         x\_1\_burnt(:, i\_bt) = x\_1(:, i-\/1)}
\DoxyCodeLine{1794                         x\_2\_burnt(:, i\_bt) = x\_2(:, i-\/1)}
\DoxyCodeLine{1795                         \textcolor{comment}{! Calculate the local energy at this point }}
\DoxyCodeLine{1796                         \textcolor{keyword}{call }h\_2\_energy(a, beta, x\_1(:, i-\/1), x\_2(:, i-\/1\textcolor{comment}{), r\_a, r\_b, e\_loc, dphidbeta)}}
\DoxyCodeLine{1797 \textcolor{comment}{}                        energy\_chain(i\_bt) = e\_loc}
\DoxyCodeLine{1798                         dphidbeta\_chain(i\_bt) = dphidbeta}
\DoxyCodeLine{1799                         \textcolor{comment}{! Resetting the thin counter }}
\DoxyCodeLine{1800                         thin\_counter = 0}
\DoxyCodeLine{1801 }
\DoxyCodeLine{1802                         acceptance = \textcolor{stringliteral}{'N'}}
\DoxyCodeLine{1803 }
\DoxyCodeLine{1804                         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1805                             \textcolor{keywordflow}{if} (mod(i\_bt, re\_size/logfrac) .le. 1e-\/6\_real64\textcolor{comment}{) }\textcolor{keywordflow}{then}}
\DoxyCodeLine{1806                                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.8, '   ', F12.8,\&}}
\DoxyCodeLine{1807 \textcolor{stringliteral}{}\textcolor{stringliteral}{                                    \& '   ', F12.8, '   ', F12.8, '   ', F12.8, ' ', F12.6, '         ', A1)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{1808 \textcolor{comment}{}                                    (i\_bt), x\_1\_burnt(1, i\_bt), x\_1\_burnt\textcolor{comment}{(2, i\_bt), x\_1\_burnt(3, i\_bt),\&}}
\DoxyCodeLine{1809 \textcolor{comment}{}                                    x\_2\_burnt(1, i\_bt), x\_2\_burnt(2, i\_bt\textcolor{comment}{), x\_2\_burnt(3, i\_bt),\&}}
\DoxyCodeLine{1810 \textcolor{comment}{}                                    energy\_chain(i\_bt), acceptance}
\DoxyCodeLine{1811 \textcolor{keywordflow}{                            end if}}
\DoxyCodeLine{1812 \textcolor{keywordflow}{                        end if}}
\DoxyCodeLine{1813 \textcolor{keywordflow}{                    end if} }
\DoxyCodeLine{1814 \textcolor{keywordflow}{                end if} }
\DoxyCodeLine{1815 \textcolor{keywordflow}{            end do} }
\DoxyCodeLine{1816         \textcolor{comment}{! Loop to advance the chain to the final burn step and not save any of the outputs}}
\DoxyCodeLine{1817         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (burn >= 2) \textcolor{keywordflow}{then} }
\DoxyCodeLine{1818             \textcolor{keywordflow}{do} i = 2, burn }
\DoxyCodeLine{1819                 \textcolor{comment}{! Propose the next step for random walker 1 }}
\DoxyCodeLine{1820                 \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{1821                 x\_n\_1 = x\_1(:, i-\/1) + sigma * sample\_normal}
\DoxyCodeLine{1822 }
\DoxyCodeLine{1823                 \textcolor{comment}{! Propose the next step for random walker 2 }}
\DoxyCodeLine{1824                 \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{1825                 x\_n\_2 = x\_2(:, i-\/1) + sigma * sample\_normal}
\DoxyCodeLine{1826 }
\DoxyCodeLine{1827                 \textcolor{comment}{! Calculate the transition probability between the proposed steps and current steps}}
\DoxyCodeLine{1828                 log\_prob\_n = log(h\_2\_prob(a, beta, x\_1(:, i-\/1), x\_2(:, i\textcolor{comment}{-\/1), x\_n\_1, x\_n\_2, r\_a, r\_b))}}
\DoxyCodeLine{1829 \textcolor{comment}{}}
\DoxyCodeLine{1830                 \textcolor{comment}{! Calculate the acceptance ratio}}
\DoxyCodeLine{1831                 a\_prob\_trans = min(1.0\_real64, exp(log\_prob\_n))}
\DoxyCodeLine{1832 }
\DoxyCodeLine{1833                 \textcolor{comment}{! Generate sample from uniform distribution}}
\DoxyCodeLine{1834                 \textcolor{keyword}{call }ran1(unif\_num, seed)}
\DoxyCodeLine{1835 }
\DoxyCodeLine{1836                 \textcolor{comment}{! Compare the drawn sample from the uniform distribution with the acceptance ratio}}
\DoxyCodeLine{1837                 \textcolor{keywordflow}{if} (a\_prob\_trans >= unif\_num) \textcolor{keywordflow}{then} }
\DoxyCodeLine{1838                     \textcolor{comment}{! If accepted calculate local energy and add proposed position to the MCMC chain}}
\DoxyCodeLine{1839                     x\_1(:, i) = x\_n\_1}
\DoxyCodeLine{1840                     x\_2(:, i) = x\_n\_2 }
\DoxyCodeLine{1841                 \textcolor{keywordflow}{else} }
\DoxyCodeLine{1842                     \textcolor{comment}{! If rejected the proposed step is the current step }}
\DoxyCodeLine{1843                     x\_1(:, i) = x\_1(:, i-\/1)}
\DoxyCodeLine{1844                     x\_2(:, i) = x\_2(:, i-\/1) }
\DoxyCodeLine{1845 \textcolor{keywordflow}{                end if} }
\DoxyCodeLine{1846 \textcolor{keywordflow}{            end do} }
\DoxyCodeLine{1847 }
\DoxyCodeLine{1848             \textcolor{keywordflow}{if} (i\_log) \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/ Burning steps completed. -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/')"{}}\textcolor{comment}{)}}
\DoxyCodeLine{1849 \textcolor{comment}{}}
\DoxyCodeLine{1850 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{1851 }
\DoxyCodeLine{1852         \textcolor{comment}{! Metropolis Algorithm to calculate the burnt and thinned MCMC chain }}
\DoxyCodeLine{1853         \textcolor{keywordflow}{if} (burn >= 1) \textcolor{keywordflow}{then} }
\DoxyCodeLine{1854             \textcolor{comment}{! Metropolis algorithm }}
\DoxyCodeLine{1855             \textcolor{keywordflow}{do} i = (burn + 1) , n+1 }
\DoxyCodeLine{1856                 \textcolor{comment}{! Initialize thin counter }}
\DoxyCodeLine{1857                 thin\_counter = 1 + thin\_counter}
\DoxyCodeLine{1858                 \textcolor{comment}{! Propose the next step for random walker 1 }}
\DoxyCodeLine{1859                 \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{1860                 x\_n\_1 = x\_1(:, i-\/1) + sigma * sample\_normal}
\DoxyCodeLine{1861 }
\DoxyCodeLine{1862                 \textcolor{comment}{! Propose the next step for random walker 2 }}
\DoxyCodeLine{1863                 \textcolor{keyword}{call }random\_normal(3, sample\_normal)}
\DoxyCodeLine{1864                 x\_n\_2 = x\_2(:, i-\/1) + sigma * sample\_normal}
\DoxyCodeLine{1865 }
\DoxyCodeLine{1866                 \textcolor{comment}{! Calculate the transition probability between the proposed steps and current steps}}
\DoxyCodeLine{1867                 log\_prob\_n = log(h\_2\_prob(a, beta, x\_1(:, i-\/1), x\_2(:, i\textcolor{comment}{-\/1), x\_n\_1, x\_n\_2, r\_a, r\_b))}}
\DoxyCodeLine{1868 \textcolor{comment}{}}
\DoxyCodeLine{1869                 \textcolor{comment}{! Calculate the acceptance ratio}}
\DoxyCodeLine{1870                 a\_prob\_trans = min(1.0\_real64, exp(log\_prob\_n))}
\DoxyCodeLine{1871 }
\DoxyCodeLine{1872                 \textcolor{comment}{! Generate sample from uniform distribution}}
\DoxyCodeLine{1873                 \textcolor{keyword}{call }ran1(unif\_num, seed)}
\DoxyCodeLine{1874 }
\DoxyCodeLine{1875                 \textcolor{comment}{! Compare the drawn sample from the uniform distribution with the acceptance ratio}}
\DoxyCodeLine{1876                 \textcolor{keywordflow}{if} (a\_prob\_trans >= unif\_num) \textcolor{keywordflow}{then} }
\DoxyCodeLine{1877                     \textcolor{comment}{! If accepted calculate local energy and add proposed position to the MCMC chain}}
\DoxyCodeLine{1878                     x\_1(:, i) = x\_n\_1}
\DoxyCodeLine{1879                     x\_2(:, i) = x\_n\_2 }
\DoxyCodeLine{1880 }
\DoxyCodeLine{1881                     \textcolor{comment}{! To determine whether this point should be added to the burnt and thinned MCMC chain                    }}
\DoxyCodeLine{1882                     \textcolor{keywordflow}{if} ((i > (burn + 1)) .and. (thin\_counter == thin)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1883                         \textcolor{comment}{! Increment the reset counter }}
\DoxyCodeLine{1884                         reset\_counter = 1 + reset\_counter}
\DoxyCodeLine{1885                         \textcolor{comment}{! Precalculate i\_bt for shorthand}}
\DoxyCodeLine{1886                         i\_bt = i -\/ burn -\/ (reset\_counter * (thin -\/ 1))}
\DoxyCodeLine{1887                         \textcolor{comment}{! Add to the burn and thinned MCMC chain}}
\DoxyCodeLine{1888                         x\_1\_burnt(:, i\_bt) = x\_n\_1}
\DoxyCodeLine{1889                         x\_2\_burnt(:, i\_bt) = x\_n\_2}
\DoxyCodeLine{1890                         \textcolor{comment}{! Calculate the local energy at this point }}
\DoxyCodeLine{1891                         \textcolor{keyword}{call }h\_2\_energy(a, beta, x\_n\_1, x\_n\_2, r\_a, r\_b,\textcolor{comment}{ e\_loc, dphidbeta)}}
\DoxyCodeLine{1892 \textcolor{comment}{}                        energy\_chain(i\_bt) = e\_loc}
\DoxyCodeLine{1893                         dphidbeta\_chain(i\_bt) = dphidbeta}
\DoxyCodeLine{1894                         \textcolor{comment}{! Resetting the thin counter }}
\DoxyCodeLine{1895                         thin\_counter = 0}
\DoxyCodeLine{1896 }
\DoxyCodeLine{1897                         \textcolor{comment}{! Increment the number of accepted steps }}
\DoxyCodeLine{1898                         accept = 1 + accept }
\DoxyCodeLine{1899                         acceptance = \textcolor{stringliteral}{'Y'}}
\DoxyCodeLine{1900 }
\DoxyCodeLine{1901                         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1902                             \textcolor{keywordflow}{if} (mod(i-\/burn, re\_size/logfrac) .le. 1e-\/6\_real64\textcolor{comment}{) }\textcolor{keywordflow}{then}}
\DoxyCodeLine{1903                                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(I8, '   ', F12.8, '   ', F12.8, '   ', F12.8,\&}}
\DoxyCodeLine{1904 \textcolor{stringliteral}{}\textcolor{stringliteral}{                                    \& '   ', F12.8, '   ', F12.8, '   ', F12.8, ' ', F12.6, '         ', A1)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{1905 \textcolor{comment}{}                                    (i\_bt), x\_1\_burnt(1, i\_bt), x\_1\_burnt\textcolor{comment}{(2, i\_bt), x\_1\_burnt(3, i\_bt),\&}}
\DoxyCodeLine{1906 \textcolor{comment}{}                                    x\_2\_burnt(1, i\_bt), x\_2\_burnt(2, i\_bt\textcolor{comment}{), x\_2\_burnt(3, i\_bt),\&}}
\DoxyCodeLine{1907 \textcolor{comment}{}                                    energy\_chain(i\_bt), acceptance}
\DoxyCodeLine{1908 \textcolor{keywordflow}{                            end if}}
\DoxyCodeLine{1909 \textcolor{keywordflow}{                        end if}}
\DoxyCodeLine{1910 \textcolor{keywordflow}{                    end if} }
\DoxyCodeLine{1911                 \textcolor{keywordflow}{else} }
\DoxyCodeLine{1912                     \textcolor{comment}{! If rejected the proposed step is the current step }}
\DoxyCodeLine{1913                     x\_1(:, i) = x\_1(:, i-\/1)}
\DoxyCodeLine{1914                     x\_2(:, i) = x\_2(:, i-\/1) }
\DoxyCodeLine{1915                 }
\DoxyCodeLine{1916                     \textcolor{comment}{! To determine whether this point should be added to the burnt and thinned MCMC chain                }}
\DoxyCodeLine{1917                     \textcolor{keywordflow}{if} ((i > (burn + 1)) .and. (thin\_counter == thin)) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1918                         \textcolor{comment}{! Increment the reset counter }}
\DoxyCodeLine{1919                         reset\_counter = 1 + reset\_counter}
\DoxyCodeLine{1920                         \textcolor{comment}{! Precalculate i\_bt for shorthand}}
\DoxyCodeLine{1921                         i\_bt = i -\/ burn -\/ (reset\_counter * (thin -\/ 1))}
\DoxyCodeLine{1922                         \textcolor{comment}{! Add to the burn and thinned MCMC chain}}
\DoxyCodeLine{1923                         x\_1\_burnt(:, i\_bt) = x\_1(:, i-\/1)}
\DoxyCodeLine{1924                         x\_2\_burnt(:, i\_bt) = x\_2(:, i-\/1)}
\DoxyCodeLine{1925                         \textcolor{comment}{! Calculate the local energy at this point }}
\DoxyCodeLine{1926                         \textcolor{keyword}{call }h\_2\_energy(a, beta, x\_1(:, i-\/1), x\_2(:, i-\/1\textcolor{comment}{), r\_a, r\_b, e\_loc, dphidbeta)}}
\DoxyCodeLine{1927 \textcolor{comment}{}                        energy\_chain(i\_bt) = e\_loc}
\DoxyCodeLine{1928                         dphidbeta\_chain(i\_bt) = dphidbeta}
\DoxyCodeLine{1929                         \textcolor{comment}{! Resetting the thin counter }}
\DoxyCodeLine{1930                         thin\_counter = 0}
\DoxyCodeLine{1931 \textcolor{keywordflow}{                    end if} }
\DoxyCodeLine{1932 \textcolor{keywordflow}{                end if} }
\DoxyCodeLine{1933 \textcolor{keywordflow}{            end do} }
\DoxyCodeLine{1934 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{1935 }
\DoxyCodeLine{1936         \textcolor{comment}{! Calculate the acceptance ratio}}
\DoxyCodeLine{1937         accept\_rate = (real(accept, kind=real64) / real(re\_size, kind=real64\textcolor{comment}{))}}
\DoxyCodeLine{1938 \textcolor{comment}{}}
\DoxyCodeLine{1939         \textcolor{comment}{! Calculate the mean energy and the variance in the energy}}
\DoxyCodeLine{1940         energy\_mean = sum(energy\_chain) / real(re\_size, kind=real64)}
\DoxyCodeLine{1941         energy\_variance = 0.0\_real64}
\DoxyCodeLine{1942         \textcolor{keywordflow}{do} i = 1, re\_size}
\DoxyCodeLine{1943             energy\_variance = energy\_variance + ((1.0\_real64 / real(re\_size\textcolor{comment}{ -\/ 1, kind=real64)) * \&}}
\DoxyCodeLine{1944 \textcolor{comment}{}            (energy\_chain(i) -\/ energy\_mean) * (energy\_chain(i) -\/ energy\_mean\textcolor{comment}{)) }}
\DoxyCodeLine{1945 \textcolor{comment}{}\textcolor{keywordflow}{        end do}}
\DoxyCodeLine{1946         energy\_variance = (1.0\_real64 / real(re\_size, kind=real64)) * energy\_variance}
\DoxyCodeLine{1947 }
\DoxyCodeLine{1948         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{1949             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Local energy = ', F12.8)"{}}) energy\_mean}
\DoxyCodeLine{1950             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Variance = ', F12.8)"{}}) energy\_variance}
\DoxyCodeLine{1951             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Acceptance rate = ', F12.8)"{}}) accept\_rate}
\DoxyCodeLine{1952             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{1953 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{1954 }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a12f60b20a934a7eb8c6e3cdaaac0b1cc_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a12f60b20a934a7eb8c6e3cdaaac0b1cc_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_a70dc752a6b037f137c1264dd8753bac2}\label{namespacevqmc_a70dc752a6b037f137c1264dd8753bac2}} 
\index{vqmc@{vqmc}!auto\_h\_2@{auto\_h\_2}}
\index{auto\_h\_2@{auto\_h\_2}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{auto\_h\_2()}{auto\_h\_2()}}
{\footnotesize\ttfamily subroutine vqmc\+::auto\+\_\+h\+\_\+2 (\begin{DoxyParamCaption}\item[{real(real64), intent(in)}]{a,  }\item[{real(real64), intent(in)}]{beta\+\_\+in,  }\item[{real(real64), intent(in)}]{bond\+\_\+length,  }\item[{real(real64), intent(out)}]{beta\+\_\+out,  }\item[{real(real64), intent(out)}]{energy\+\_\+out,  }\item[{real(real64), intent(out)}]{variance\+\_\+out,  }\item[{real(real64), intent(out)}]{accept\+\_\+out,  }\item[{character(len=1), intent(out)}]{converged }\end{DoxyParamCaption})}



Automatically finds the best variational parameter $ \beta $ for the $ H_{2}^{+} $ problem at a given bond length. 

Determines the optimum value of $ \beta $ at a given bond length from a guess value by utilising the gradient with respect to $ \beta $ (calculated by first order central difference) in a \mbox{\hyperlink{namespacesolvers_a4b4d370a4ee50b231f53058ab62e4084}{dampened steepest descent optimisation}}. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em a} & Value of parameter {\bfseries{a}} at current bond length, calculated by \mbox{\hyperlink{namespacesolvers_a38259c21a02a250a91f45d79e4165742}{H\+\_\+2\+\_\+cusp}} \\
\hline
\mbox{\texttt{ in}}  & {\em beta\+\_\+in} & Guess value for beta \\
\hline
\mbox{\texttt{ in}}  & {\em bond\+\_\+length} & H-\/H bond length \\
\hline
\mbox{\texttt{ out}}  & {\em beta\+\_\+out} & Optimised value for beta at this bond length \\
\hline
\mbox{\texttt{ out}}  & {\em energy\+\_\+out} & Energy of wavefunction at optimal beta \\
\hline
\mbox{\texttt{ out}}  & {\em variance\+\_\+out} & Variance of energy at optimal beta \\
\hline
\mbox{\texttt{ out}}  & {\em accept\+\_\+out} & Acceptance rate of MCMC chain at optimal beta \\
\hline
\mbox{\texttt{ out}}  & {\em converged} & Y/N convergence status \\
\hline
\end{DoxyParams}


Definition at line 1980 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{1982 }
\DoxyCodeLine{1983         \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{1984 }
\DoxyCodeLine{1985 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: a}
\DoxyCodeLine{1986 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: beta\_in}
\DoxyCodeLine{1987 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: bond\_length}
\DoxyCodeLine{1988 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: beta\_out}
\DoxyCodeLine{1989 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: energy\_out}
\DoxyCodeLine{1990 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: variance\_out}
\DoxyCodeLine{1991 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: accept\_out}
\DoxyCodeLine{1992         \textcolor{keywordtype}{character(len=1)}, \textcolor{keywordtype}{intent(out)} :: converged}
\DoxyCodeLine{1993 }
\DoxyCodeLine{1994 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)} :: R\_a, R\_b}
\DoxyCodeLine{1995 \textcolor{keywordtype}{        real}(real64) :: beta\_current, beta\_new}
\DoxyCodeLine{1996 \textcolor{keywordtype}{        real}(real64) :: beta\_grad}
\DoxyCodeLine{1997 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:, :)}, \textcolor{keywordtype}{allocatable} :: e1\_pos\_chain, e2\_pos\_chain}
\DoxyCodeLine{1998 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energy\_chain, DphiDbeta\_chain}
\DoxyCodeLine{1999         \textcolor{keywordtype}{integer} :: viz\_steps}
\DoxyCodeLine{2000         \textcolor{keywordtype}{integer} :: k}
\DoxyCodeLine{2001         \textcolor{keywordtype}{integer} :: ierr}
\DoxyCodeLine{2002         \textcolor{keywordtype}{integer} :: maxiter = 200}
\DoxyCodeLine{2003 \textcolor{keywordtype}{        real}(real64) :: tol = 1e-\/4\_real64}
\DoxyCodeLine{2004         \textcolor{keywordtype}{character(len=6)} :: str\_b}
\DoxyCodeLine{2005         \textcolor{keywordtype}{character(len=40)} :: chainfile}
\DoxyCodeLine{2006 }
\DoxyCodeLine{2007         \textcolor{comment}{! MPI Variables}}
\DoxyCodeLine{2008 \textcolor{keywordtype}{        real}(real64) :: my\_beta\_grad, my\_ensum}
\DoxyCodeLine{2009 \textcolor{keywordtype}{        real}(real64) :: sum\_var, sum\_acc}
\DoxyCodeLine{2010 }
\DoxyCodeLine{2011         \textcolor{comment}{! Initialise}}
\DoxyCodeLine{2012         beta\_current = beta\_in}
\DoxyCodeLine{2013         r\_a = (/-\/bond\_length/2, 0.0\_real64, 0.0\_real64/)}
\DoxyCodeLine{2014         r\_b = (/bond\_length/2, 0.0\_real64, 0.0\_real64/)}
\DoxyCodeLine{2015 }
\DoxyCodeLine{2016         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2017             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Starting parameter search for beta...')"{}})}
\DoxyCodeLine{2018 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{2019 }
\DoxyCodeLine{2020         \textcolor{comment}{! Main iteration loop}}
\DoxyCodeLine{2021         \textcolor{keywordflow}{do} k = auto\_start, maxiter}
\DoxyCodeLine{2022 }
\DoxyCodeLine{2023             \textcolor{comment}{! Calculate gradient at current beta}}
\DoxyCodeLine{2024             \textcolor{keyword}{call }vqmc\_h\_2(h2\%sigma, my\_steps+h2\%burn\_step, h2\%burn\_step,\textcolor{comment}{ h2\%thin\_step, a, \&}}
\DoxyCodeLine{2025 \textcolor{comment}{}                    beta\_current, r\_a, r\_b, e1\_pos\_chain, e2\_pos\_chain, accept\_out\textcolor{comment}{, \&}}
\DoxyCodeLine{2026 \textcolor{comment}{}                    energy\_chain, energy\_out, variance\_out, dphidbeta\_chain\textcolor{comment}{)}}
\DoxyCodeLine{2027 \textcolor{comment}{}}
\DoxyCodeLine{2028             \textcolor{comment}{! Find gradient }}
\DoxyCodeLine{2029             my\_beta\_grad = 2.0\_real64 * ((sum(energy\_chain * dphidbeta\_chain\textcolor{comment}{) / }\textcolor{keyword}{size}\textcolor{comment}{(energy\_chain)) \&}}
\DoxyCodeLine{2030 \textcolor{comment}{}                -\/ energy\_out * (sum(dphidbeta\_chain) / \textcolor{keyword}{size}(energy\_chain\textcolor{comment}{))) }}
\DoxyCodeLine{2031 \textcolor{comment}{}}
\DoxyCodeLine{2032             \textcolor{comment}{! Find average beta\_grad across ranks, on all ranks.}}
\DoxyCodeLine{2033             \textcolor{keyword}{call }mpi\_allreduce(my\_beta\_grad,beta\_grad,1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{2034 \textcolor{comment}{}            beta\_grad = beta\_grad * per\_proc}
\DoxyCodeLine{2035 }
\DoxyCodeLine{2036             \textcolor{comment}{! Update the log}}
\DoxyCodeLine{2037             \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2038                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Beta            Gradient')"{}})}
\DoxyCodeLine{2039                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(F13.7, '    ', F13.7)"{}}) beta\_current, beta\_grad}
\DoxyCodeLine{2040 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{2041                }
\DoxyCodeLine{2042             \textcolor{comment}{! Check if gradient is within tolerance.}}
\DoxyCodeLine{2043             \textcolor{keywordflow}{if} (abs(beta\_grad) .le. tol) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2044 }
\DoxyCodeLine{2045                 \textcolor{comment}{! Update beta\_out, and note convergence, on all ranks.}}
\DoxyCodeLine{2046                 beta\_out = beta\_current}
\DoxyCodeLine{2047                 converged = \textcolor{stringliteral}{'Y'}}
\DoxyCodeLine{2048 }
\DoxyCodeLine{2049                 \textcolor{comment}{! Sum the chain energy-\/sums and store in rank 0}}
\DoxyCodeLine{2050                 my\_ensum = sum(energy\_chain)}
\DoxyCodeLine{2051                 \textcolor{keyword}{call }mpi\_reduce(my\_ensum,energy\_out,1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{2052 \textcolor{comment}{}}
\DoxyCodeLine{2053                 \textcolor{comment}{! Sum the chain variances and store in rank 0}}
\DoxyCodeLine{2054                 \textcolor{keyword}{call }mpi\_reduce(variance\_out, sum\_var,1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{2055 \textcolor{comment}{}}
\DoxyCodeLine{2056                 \textcolor{comment}{! Sum the chain acceptance rates and store in rank 0}}
\DoxyCodeLine{2057                 \textcolor{keyword}{call }mpi\_reduce(accept\_out, sum\_acc,1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{2058 \textcolor{comment}{}}
\DoxyCodeLine{2059                 \textcolor{comment}{! Calculate averages on rank 0}}
\DoxyCodeLine{2060                 \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2061 }
\DoxyCodeLine{2062                     energy\_out = energy\_out * per\_step}
\DoxyCodeLine{2063                     variance\_out = sum\_var * per\_proc2}
\DoxyCodeLine{2064                     accept\_out = sum\_acc * per\_proc}
\DoxyCodeLine{2065 }
\DoxyCodeLine{2066                     \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2067                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Parameter search converged!')"{}})}
\DoxyCodeLine{2068                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Results:')"{}})}
\DoxyCodeLine{2069                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Beta = ', F13.7, ', Energy = ', F12.8, ', Variance = ', F12.8)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{2070 \textcolor{comment}{}                            beta\_current, energy\_out, variance\_out}
\DoxyCodeLine{2071                         \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{2072 \textcolor{keywordflow}{                    end if}}
\DoxyCodeLine{2073 }
\DoxyCodeLine{2074 \textcolor{keywordflow}{                endif} }
\DoxyCodeLine{2075 }
\DoxyCodeLine{2076                 \textcolor{comment}{! Exit subroutine, as convergence is reached.}}
\DoxyCodeLine{2077                 \textcolor{comment}{! Note: Only rank 0 has the correct array outputs. All ranks have correct beta\_out and 'converged'.}}
\DoxyCodeLine{2078                 \textcolor{keywordflow}{exit}}
\DoxyCodeLine{2079 }
\DoxyCodeLine{2080 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{2081 }
\DoxyCodeLine{2082             \textcolor{comment}{! If not, update beta by steepest descent, on all ranks.}}
\DoxyCodeLine{2083             \textcolor{keyword}{call }h\_2\_update\_beta(beta\_current, beta\_grad, beta\_new)}
\DoxyCodeLine{2084             beta\_current = beta\_new}
\DoxyCodeLine{2085 }
\DoxyCodeLine{2086             \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{2087             \textcolor{keywordflow}{if} (write\_restart .and. my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2088                 \textcolor{keywordflow}{if} (mod(k,restart\_num)==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2089                     \textcolor{comment}{! Write res\_nml.txt}}
\DoxyCodeLine{2090                     \textcolor{keyword}{call }write\_res\_nml(i\_bond,k+1,h2\%auto\_params,beta\_current\textcolor{comment}{)}}
\DoxyCodeLine{2091 \textcolor{comment}{}\textcolor{keywordflow}{                endif}}
\DoxyCodeLine{2092 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{2093 }
\DoxyCodeLine{2094 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{2095 }
\DoxyCodeLine{2096         \textcolor{comment}{! Deal with non-\/convergence}}
\DoxyCodeLine{2097         \textcolor{keywordflow}{if} (k .ge. maxiter) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2098             converged = \textcolor{stringliteral}{'N'}}
\DoxyCodeLine{2099             beta\_out = beta\_current}
\DoxyCodeLine{2100             \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then} }
\DoxyCodeLine{2101                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Parameter search NOT converged! Consider changing\&}}
\DoxyCodeLine{2102 \textcolor{stringliteral}{}\textcolor{stringliteral}{                    \& the starting value of beta, or the damping in the H\_2\_update\_beta\&}}
\DoxyCodeLine{2103 \textcolor{stringliteral}{}\textcolor{stringliteral}{                    \& function.')"{}})}
\DoxyCodeLine{2104 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{2105 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{2106 }
\DoxyCodeLine{2107         \textcolor{comment}{! Report results}}
\DoxyCodeLine{2108         \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2109             \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(F12.8, '   ', A, '             ', F13.7, '      ', F12.8)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{2110 \textcolor{comment}{}                bond\_length, converged, beta\_out, energy\_out}
\DoxyCodeLine{2111 \textcolor{keywordflow}{        endif}}
\DoxyCodeLine{2112 }
\DoxyCodeLine{2113         \textcolor{comment}{! Run a new visualisation chain at the optimised parameter if write\_chains is enabled.}}
\DoxyCodeLine{2114         \textcolor{keywordflow}{if} (my\_rank == 0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2115             \textcolor{keywordflow}{if} (write\_chains) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2116                 \textcolor{keyword}{write}(str\_b, \textcolor{stringliteral}{"{}(F6.3)"{}}) bond\_length}
\DoxyCodeLine{2117                 \textcolor{keyword}{write}(chainfile, \textcolor{stringliteral}{"{}(3A)"{}}) \textcolor{stringliteral}{'./chains\_out/bond\_'}, trim(adjustl\textcolor{comment}{(str\_b)), }\textcolor{stringliteral}{'.nc'}}
\DoxyCodeLine{2118                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Running VQMC at beta = ', F12.7, ' to produce single Markov chain...')"{}}\textcolor{comment}{) beta\_out}}
\DoxyCodeLine{2119 \textcolor{comment}{}                viz\_steps = min(h2plus\%steps,max\_chain\_len)}
\DoxyCodeLine{2120                 \textcolor{keyword}{call }vqmc\_h\_2(h2\%sigma, viz\_steps, h2\%burn\_step, h2\%thin\_step\textcolor{comment}{, a, \&}}
\DoxyCodeLine{2121 \textcolor{comment}{}                        beta\_out, r\_a, r\_b, e1\_pos\_chain, e2\_pos\_chain, accept\_out\textcolor{comment}{, \&}}
\DoxyCodeLine{2122 \textcolor{comment}{}                        energy\_chain, energy\_out, variance\_out, dphidbeta\_chain\textcolor{comment}{)}}
\DoxyCodeLine{2123 \textcolor{comment}{}                \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Writing Markov chain to '}, chainfile}
\DoxyCodeLine{2124                 \textcolor{keyword}{call }write\_h2\_equilibration(e1\_pos\_chain, energy\_chain, chainfile\textcolor{comment}{, ierr, \&}}
\DoxyCodeLine{2125 \textcolor{comment}{}                    h2, accept\_out, beta\_out, bond\_length)}
\DoxyCodeLine{2126 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{2127 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{2128         }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a70dc752a6b037f137c1264dd8753bac2_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=316pt]{namespacevqmc_a70dc752a6b037f137c1264dd8753bac2_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_a08bc46270707aab6c2d5114b589c176c}\label{namespacevqmc_a08bc46270707aab6c2d5114b589c176c}} 
\index{vqmc@{vqmc}!grid\_h\_2@{grid\_h\_2}}
\index{grid\_h\_2@{grid\_h\_2}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{grid\_h\_2()}{grid\_h\_2()}}
{\footnotesize\ttfamily subroutine vqmc\+::grid\+\_\+h\+\_\+2 (\begin{DoxyParamCaption}\item[{real(real64), intent(in)}]{a,  }\item[{real(real64), dimension(\+:), intent(in)}]{beta\+\_\+array,  }\item[{real(real64), intent(in)}]{bond\+\_\+length,  }\item[{real(real64), intent(out)}]{beta\+\_\+out,  }\item[{real(real64), intent(out)}]{energy\+\_\+out,  }\item[{real(real64), intent(out)}]{variance\+\_\+out,  }\item[{real(real64), intent(out)}]{accept\+\_\+out }\end{DoxyParamCaption})}



Performs a grid search to find the optimal value for the variational parameter $ \beta $ in the $ H_{2} $ problem. 

Evaluates energy of the $ H_{2} $ trial wavefunction at each value of the parameter $ \beta $ in {\bfseries{beta\+\_\+array}}. Determines the best energy, and reports its corresponding $ \beta $ as the optimal value at this bond length. Also returns the variance of this energy as a measure of uncertainty, as well as the acceptance rate of the MCMC chain. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em a} & Value of parameter {\bfseries{a}} at current bond length, calculated by \mbox{\hyperlink{namespacesolvers_a38259c21a02a250a91f45d79e4165742}{H\+\_\+2\+\_\+cusp}} \\
\hline
\mbox{\texttt{ in}}  & {\em beta\+\_\+array} & Array of beta values to be tested \\
\hline
\mbox{\texttt{ in}}  & {\em bond\+\_\+length} & H-\/H bond length \\
\hline
\mbox{\texttt{ out}}  & {\em beta\+\_\+out} & Optimised value for beta at this bond length \\
\hline
\mbox{\texttt{ out}}  & {\em energy\+\_\+out} & Energy of wavefunction at optimal beta \\
\hline
\mbox{\texttt{ out}}  & {\em variance\+\_\+out} & Variance of energy at optimal beta \\
\hline
\mbox{\texttt{ out}}  & {\em accept\+\_\+out} & Acceptance rate of MCMC chain at optimal beta \\
\hline
\end{DoxyParams}


Definition at line 2153 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{2155     }
\DoxyCodeLine{2156         \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{2157 }
\DoxyCodeLine{2158 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: a}
\DoxyCodeLine{2159 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{intent(in)} :: beta\_array}
\DoxyCodeLine{2160 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: bond\_length}
\DoxyCodeLine{2161 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: beta\_out}
\DoxyCodeLine{2162 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: energy\_out}
\DoxyCodeLine{2163 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: variance\_out}
\DoxyCodeLine{2164 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(out)} :: accept\_out}
\DoxyCodeLine{2165 }
\DoxyCodeLine{2166 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)} :: R\_a, R\_b}
\DoxyCodeLine{2167 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:, :)}, \textcolor{keywordtype}{allocatable} :: e1\_pos\_chain, e2\_pos\_chain}
\DoxyCodeLine{2168 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energy\_chain, DphiDbeta\_chain}
\DoxyCodeLine{2169 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: param\_energies, param\_accepts\textcolor{comment}{, param\_variances}}
\DoxyCodeLine{2170 \textcolor{comment}{        }\textcolor{keywordtype}{integer} :: viz\_steps}
\DoxyCodeLine{2171         \textcolor{keywordtype}{integer} :: i}
\DoxyCodeLine{2172         \textcolor{keywordtype}{integer} :: ierr}
\DoxyCodeLine{2173         \textcolor{keywordtype}{character(len=6)} :: str\_b}
\DoxyCodeLine{2174         \textcolor{keywordtype}{character(len=40)} :: chainfile}
\DoxyCodeLine{2175 }
\DoxyCodeLine{2176         \textcolor{comment}{! MPI variables}}
\DoxyCodeLine{2177 \textcolor{keywordtype}{        real}(real64) :: my\_ensum}
\DoxyCodeLine{2178 }
\DoxyCodeLine{2179         \textcolor{comment}{! Initialise}}
\DoxyCodeLine{2180         r\_a = (/-\/bond\_length/2, 0.0\_real64, 0.0\_real64/)}
\DoxyCodeLine{2181         r\_b = (/bond\_length/2, 0.0\_real64, 0.0\_real64/)}
\DoxyCodeLine{2182         \textcolor{keyword}{allocate}(param\_energies(\textcolor{keyword}{size}(beta\_array))); param\_energies(:)= 0\textcolor{comment}{.0\_real64}}
\DoxyCodeLine{2183 \textcolor{comment}{}        \textcolor{keyword}{allocate}(param\_accepts(\textcolor{keyword}{size}(beta\_array))); param\_accepts(:) = 0.\textcolor{comment}{0\_real64}}
\DoxyCodeLine{2184 \textcolor{comment}{}        \textcolor{keyword}{allocate}(param\_variances(\textcolor{keyword}{size}(beta\_array))) ; param\_variances(:)\textcolor{comment}{ = 0.0\_real64}}
\DoxyCodeLine{2185 \textcolor{comment}{}}
\DoxyCodeLine{2186         \textcolor{comment}{! Sort out restarting}}
\DoxyCodeLine{2187         \textcolor{keywordflow}{if} (run\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2188             \textcolor{comment}{! Read in array values}}
\DoxyCodeLine{2189             \textcolor{keyword}{call }read\_energies(resfile\_epar, param\_energies, param\_variances\textcolor{comment}{, param\_accepts)}}
\DoxyCodeLine{2190 \textcolor{comment}{}            \textcolor{comment}{! Reset the tag}}
\DoxyCodeLine{2191             run\_restart = .false.}
\DoxyCodeLine{2192 \textcolor{keywordflow}{        endif} }
\DoxyCodeLine{2193 }
\DoxyCodeLine{2194         \textcolor{keywordflow}{if} (i\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2195             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Starting parameter search for beta...')"{}})}
\DoxyCodeLine{2196 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{2197 }
\DoxyCodeLine{2198         \textcolor{comment}{! Loop over beta values}}
\DoxyCodeLine{2199         \textcolor{keywordflow}{do} i = grid\_start, \textcolor{keyword}{size}(beta\_array)}
\DoxyCodeLine{2200 }
\DoxyCodeLine{2201             \textcolor{comment}{! Calculate energy at current value of beta}}
\DoxyCodeLine{2202             \textcolor{keyword}{call }vqmc\_h\_2(h2\%sigma, my\_steps+h2\%burn\_step, h2\%burn\_step,\textcolor{comment}{ h2\%thin\_step, a, \&}}
\DoxyCodeLine{2203 \textcolor{comment}{}                    beta\_array(i), r\_a, r\_b, e1\_pos\_chain, e2\_pos\_chain,\textcolor{comment}{ accept\_out, \&}}
\DoxyCodeLine{2204 \textcolor{comment}{}                    energy\_chain, energy\_out, variance\_out, dphidbeta\_chain\textcolor{comment}{)}}
\DoxyCodeLine{2205 \textcolor{comment}{}            }
\DoxyCodeLine{2206             \textcolor{comment}{! Save energy -\/ serial version}}
\DoxyCodeLine{2207             \textcolor{comment}{!param\_energies(i) = energy}}
\DoxyCodeLine{2208             \textcolor{comment}{!param\_variances(i) = variance}}
\DoxyCodeLine{2209             \textcolor{comment}{!param\_accepts(i) = accept\_rate}}
\DoxyCodeLine{2210 }
\DoxyCodeLine{2211             \textcolor{comment}{! Sum the chain energy-\/sums and store in rank 0}}
\DoxyCodeLine{2212             my\_ensum = sum(energy\_chain)}
\DoxyCodeLine{2213             \textcolor{keyword}{call }mpi\_reduce(my\_ensum,param\_energies(i),1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{2214 \textcolor{comment}{}}
\DoxyCodeLine{2215             \textcolor{comment}{! Sum the chain variances and store in rank 0}}
\DoxyCodeLine{2216             \textcolor{keyword}{call }mpi\_reduce(variance\_out,param\_variances(i),1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{2217 \textcolor{comment}{}}
\DoxyCodeLine{2218             \textcolor{comment}{! Sum the chain acceptance rates and store in rank 0}}
\DoxyCodeLine{2219             \textcolor{keyword}{call }mpi\_reduce(accept\_out,param\_accepts(i),1,mpi\_double\_precision\textcolor{comment}{,mpi\_sum,0,mpi\_comm\_world,mpierr)}}
\DoxyCodeLine{2220 \textcolor{comment}{}}
\DoxyCodeLine{2221             \textcolor{comment}{! Calculate averages on rank 0}}
\DoxyCodeLine{2222             \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2223                 param\_energies(i) = param\_energies(i) * per\_step}
\DoxyCodeLine{2224                 param\_variances(i) = param\_variances(i) * per\_proc2}
\DoxyCodeLine{2225                 param\_accepts(i) = param\_accepts(i) * per\_proc}
\DoxyCodeLine{2226 }
\DoxyCodeLine{2227                 \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{2228                 \textcolor{keywordflow}{if} (write\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2229                     \textcolor{comment}{! Write res\_nml.txt}}
\DoxyCodeLine{2230                     \textcolor{keyword}{call }write\_res\_nml(i\_bond,i+1,h2\%auto\_params)}
\DoxyCodeLine{2231                     \textcolor{comment}{! Write param energies, variances and acceptance rates}}
\DoxyCodeLine{2232                     \textcolor{keyword}{call }write\_qho\_main(beta\_array, param\_energies, param\_variances\textcolor{comment}{, resfile\_epar, ierr, qho, param\_accepts)}}
\DoxyCodeLine{2233 \textcolor{comment}{}\textcolor{keywordflow}{                endif} }
\DoxyCodeLine{2234 \textcolor{keywordflow}{            endif} }
\DoxyCodeLine{2235 }
\DoxyCodeLine{2236 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{2237 }
\DoxyCodeLine{2238         \textcolor{comment}{! Note: Only rank 0 has the correct \_out values.}}
\DoxyCodeLine{2239         \textcolor{keywordflow}{if} (my\_rank==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2240 }
\DoxyCodeLine{2241             \textcolor{comment}{! Select lowest energy and corresponding beta value}}
\DoxyCodeLine{2242             energy\_out = minval(param\_energies)}
\DoxyCodeLine{2243             beta\_out = beta\_array(minloc(param\_energies, 1))}
\DoxyCodeLine{2244             variance\_out = param\_variances(minloc(param\_energies, 1))}
\DoxyCodeLine{2245             accept\_out = param\_accepts(minloc(param\_energies, 1))}
\DoxyCodeLine{2246 }
\DoxyCodeLine{2247             \textcolor{comment}{! Report results}}
\DoxyCodeLine{2248             \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(F12.8, '   -\/             ', F13.7, '      ', F12.8)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{2249 \textcolor{comment}{}                bond\_length, beta\_out, energy\_out}
\DoxyCodeLine{2250 }
\DoxyCodeLine{2251             \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2252                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Results:')"{}})}
\DoxyCodeLine{2253                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('beta             Energy')"{}})}
\DoxyCodeLine{2254                 \textcolor{keywordflow}{do} i = 1, \textcolor{keyword}{size}(beta\_array)}
\DoxyCodeLine{2255                     \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(F12.8, '    ', F12.8)"{}}) beta\_array(i)\textcolor{comment}{, param\_energies(i)}}
\DoxyCodeLine{2256 \textcolor{comment}{}\textcolor{keywordflow}{                end do}}
\DoxyCodeLine{2257                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{2258                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Min Energy = ', F12.8, ' at c = ', F12.8)"{}}\textcolor{comment}{) energy\_out, beta\_out}}
\DoxyCodeLine{2259 \textcolor{comment}{}                \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{2260 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{2261 }
\DoxyCodeLine{2262             \textcolor{comment}{! Run a new visualisation chain at the optimised parameter if write\_chains is enabled.}}
\DoxyCodeLine{2263             \textcolor{keywordflow}{if} (write\_chains) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2264                 \textcolor{keyword}{write}(str\_b, \textcolor{stringliteral}{"{}(F6.3)"{}}) bond\_length}
\DoxyCodeLine{2265                 \textcolor{keyword}{write}(chainfile, \textcolor{stringliteral}{"{}(3A)"{}}) \textcolor{stringliteral}{'./chains\_out/bond\_'}, trim(adjustl\textcolor{comment}{(str\_b)), }\textcolor{stringliteral}{'.nc'}}
\DoxyCodeLine{2266                 \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}('Running VQMC at beta = ', F12.7, ' to produce single Markov chain...')"{}}\textcolor{comment}{) beta\_out}}
\DoxyCodeLine{2267 \textcolor{comment}{}                viz\_steps = min(h2plus\%steps,max\_chain\_len)}
\DoxyCodeLine{2268                 \textcolor{keyword}{call }vqmc\_h\_2(h2\%sigma, viz\_steps, h2\%burn\_step, h2\%thin\_step\textcolor{comment}{, a, \&}}
\DoxyCodeLine{2269 \textcolor{comment}{}                        beta\_out, r\_a, r\_b, e1\_pos\_chain, e2\_pos\_chain, accept\_out\textcolor{comment}{, \&}}
\DoxyCodeLine{2270 \textcolor{comment}{}                        energy\_chain, energy\_out, variance\_out, dphidbeta\_chain\textcolor{comment}{)}}
\DoxyCodeLine{2271 \textcolor{comment}{}                \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(2A)"{}}) \textcolor{stringliteral}{'Writing Markov chain to '}, chainfile}
\DoxyCodeLine{2272                 \textcolor{keyword}{call }write\_h2\_equilibration(e1\_pos\_chain, energy\_chain, chainfile\textcolor{comment}{, ierr, \&}}
\DoxyCodeLine{2273 \textcolor{comment}{}                    h2, accept\_out, beta\_out, bond\_length)}
\DoxyCodeLine{2274 \textcolor{keywordflow}{            end if}}
\DoxyCodeLine{2275 }
\DoxyCodeLine{2276 \textcolor{keywordflow}{        endif}  }
\DoxyCodeLine{2277     }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_a08bc46270707aab6c2d5114b589c176c_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=313pt]{namespacevqmc_a08bc46270707aab6c2d5114b589c176c_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{namespacevqmc_ab066adc59fec1fcaaba764a46128c935}\label{namespacevqmc_ab066adc59fec1fcaaba764a46128c935}} 
\index{vqmc@{vqmc}!equil\_h\_2@{equil\_h\_2}}
\index{equil\_h\_2@{equil\_h\_2}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{equil\_h\_2()}{equil\_h\_2()}}
{\footnotesize\ttfamily subroutine vqmc\+::equil\+\_\+h\+\_\+2 (\begin{DoxyParamCaption}\item[{real(real64), intent(in)}]{a,  }\item[{real(real64), dimension(\+:), intent(in)}]{beta\+\_\+array,  }\item[{real(real64), intent(in)}]{bond\+\_\+length,  }\item[{integer, intent(in)}]{bonds\+\_\+pos }\end{DoxyParamCaption})}



Performs VQMC on an array of values for the variational parameter $ \beta $, outputting energy traces for each. 

Generates VQMC position and energy traces of the $ H_{2} $ trial wavefunction at each value of the parameter $ \beta $ in {\bfseries{beta\+\_\+array}}. Outputs each of these traces to a separate Net\+CDF file, to be used in determining optimal burning/thinning paramters for an accurate full VQMC run. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em a} & Value of parameter {\bfseries{a}} at current bond length, calculated by \mbox{\hyperlink{namespacesolvers_a38259c21a02a250a91f45d79e4165742}{H\+\_\+2\+\_\+cusp}} \\
\hline
\mbox{\texttt{ in}}  & {\em beta\+\_\+array} & The array of beta values to obtain energy traces for \\
\hline
\mbox{\texttt{ in}}  & {\em bond\+\_\+length} & The current H-\/H bond length \\
\hline
\mbox{\texttt{ in}}  & {\em bonds\+\_\+pos} & The position in the array of bond lengths, to be used in designating output files \\
\hline
\end{DoxyParams}


Definition at line 2299 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{2300 }
\DoxyCodeLine{2301         \textcolor{keywordtype}{implicit none}}
\DoxyCodeLine{2302 }
\DoxyCodeLine{2303 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: a}
\DoxyCodeLine{2304 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{intent(in)} :: beta\_array}
\DoxyCodeLine{2305 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{intent(in)} :: bond\_length}
\DoxyCodeLine{2306         \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{intent(in)} :: bonds\_pos}
\DoxyCodeLine{2307 }
\DoxyCodeLine{2308 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(3)} :: R\_a, R\_b}
\DoxyCodeLine{2309 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: variances}
\DoxyCodeLine{2310 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energies}
\DoxyCodeLine{2311 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:, :)}, \textcolor{keywordtype}{allocatable} :: e1\_pos\_chain, e2\_pos\_chain}
\DoxyCodeLine{2312 \textcolor{keywordtype}{        real}(real64), \textcolor{keywordtype}{dimension(:)}, \textcolor{keywordtype}{allocatable} :: energy\_chain, DphiDbeta\_chain}
\DoxyCodeLine{2313 \textcolor{keywordtype}{        real}(real64) :: accept\_rate}
\DoxyCodeLine{2314 \textcolor{keywordtype}{        real}(real64) :: energy\_mean}
\DoxyCodeLine{2315 \textcolor{keywordtype}{        real}(real64) :: energy\_variance}
\DoxyCodeLine{2316         \textcolor{keywordtype}{integer} :: i, ierr}
\DoxyCodeLine{2317         \textcolor{keywordtype}{character(len=3)} :: str\_i, str\_b}
\DoxyCodeLine{2318         \textcolor{keywordtype}{character(len=40)} :: equilfile}
\DoxyCodeLine{2319 }
\DoxyCodeLine{2320         \textcolor{comment}{! Initialise}}
\DoxyCodeLine{2321         r\_a = (/-\/bond\_length/2, 0.0\_real64, 0.0\_real64/)}
\DoxyCodeLine{2322         r\_b = (/bond\_length/2, 0.0\_real64, 0.0\_real64/)}
\DoxyCodeLine{2323         \textcolor{keyword}{allocate}(energies(\textcolor{keyword}{size}(beta\_array))); energies(:) = 0.0\_real64}
\DoxyCodeLine{2324         \textcolor{keyword}{allocate}(variances(\textcolor{keyword}{size}(beta\_array)))}
\DoxyCodeLine{2325 }
\DoxyCodeLine{2326         \textcolor{comment}{! Loop over values of beta}}
\DoxyCodeLine{2327         \textcolor{keywordflow}{do} i = 1, \textcolor{keyword}{size}(beta\_array)}
\DoxyCodeLine{2328 }
\DoxyCodeLine{2329             \textcolor{comment}{! Calculate energy at current value of beta}}
\DoxyCodeLine{2330             \textcolor{keyword}{call }vqmc\_h\_2(h2\%sigma, h2\%steps, h2\%burn\_step, h2\%thin\_step\textcolor{comment}{, a, \&}}
\DoxyCodeLine{2331 \textcolor{comment}{}                    beta\_array(i), r\_a, r\_b, e1\_pos\_chain, e2\_pos\_chain,\textcolor{comment}{ accept\_rate, \&}}
\DoxyCodeLine{2332 \textcolor{comment}{}                    energy\_chain, energy\_mean, energy\_variance, dphidbeta\_chain\textcolor{comment}{)}}
\DoxyCodeLine{2333 \textcolor{comment}{}            \textcolor{comment}{! Save energy}}
\DoxyCodeLine{2334             energies(i) = energy\_mean}
\DoxyCodeLine{2335 }
\DoxyCodeLine{2336             \textcolor{keyword}{write}(*, \textcolor{stringliteral}{"{}(F12.8, '   -\/             ', F13.7, '      ', F12.8)"{}}\textcolor{comment}{) \&}}
\DoxyCodeLine{2337 \textcolor{comment}{}                bond\_length, beta\_array(i), energies(i)}
\DoxyCodeLine{2338 }
\DoxyCodeLine{2339             \textcolor{comment}{! Save the energy trace for each value of c}}
\DoxyCodeLine{2340             \textcolor{keyword}{write}(str\_i, \textcolor{stringliteral}{"{}(I3)"{}}) i}
\DoxyCodeLine{2341             \textcolor{keyword}{write}(str\_b, \textcolor{stringliteral}{"{}(I3)"{}}) bonds\_pos}
\DoxyCodeLine{2342             \textcolor{keyword}{write}(equilfile, \textcolor{stringliteral}{"{}(5A)"{}}) \textcolor{stringliteral}{'./equil\_out/b'}, trim(adjustl(str\_b\textcolor{comment}{)), \&}}
\DoxyCodeLine{2343 \textcolor{comment}{}                \textcolor{stringliteral}{'\_beta'}, trim(adjustl(str\_i)), \textcolor{stringliteral}{'.nc'}}
\DoxyCodeLine{2344             \textcolor{keyword}{write}(*, *) \textcolor{stringliteral}{'Writing equilibration outfile to '}, equilfile}
\DoxyCodeLine{2345             \textcolor{keyword}{call }write\_h2\_equilibration(e1\_pos\_chain, energy\_chain, equilfile\textcolor{comment}{, ierr, \&}}
\DoxyCodeLine{2346 \textcolor{comment}{}                h2, accept\_rate, beta\_array(i), bond\_length)}
\DoxyCodeLine{2347 }
\DoxyCodeLine{2348             \textcolor{comment}{! Write restart files, if required}}
\DoxyCodeLine{2349             \textcolor{keywordflow}{if} (write\_restart) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2350                 \textcolor{keywordflow}{if} (mod(i,restart\_num)==0) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2351                     \textcolor{keyword}{call }write\_res\_nml(i\_bond,i+1,h2\%auto\_params)}
\DoxyCodeLine{2352 \textcolor{keywordflow}{                endif}}
\DoxyCodeLine{2353 \textcolor{keywordflow}{            endif}}
\DoxyCodeLine{2354 }
\DoxyCodeLine{2355 \textcolor{keywordflow}{        end do}}
\DoxyCodeLine{2356 }
\DoxyCodeLine{2357         \textcolor{keywordflow}{if} (write\_log) \textcolor{keywordflow}{then}}
\DoxyCodeLine{2358             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('Results:')"{}})}
\DoxyCodeLine{2359             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('beta             Energy')"{}})}
\DoxyCodeLine{2360             \textcolor{keywordflow}{do} i = 1, \textcolor{keyword}{size}(beta\_array)}
\DoxyCodeLine{2361                 \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}(F12.8, '    ', F12.8)"{}}) beta\_array(i), energies\textcolor{comment}{(i)}}
\DoxyCodeLine{2362 \textcolor{comment}{}\textcolor{keywordflow}{            end do}}
\DoxyCodeLine{2363             \textcolor{keyword}{write}(logid, \textcolor{stringliteral}{"{}('')"{}})}
\DoxyCodeLine{2364 \textcolor{keywordflow}{        end if}}
\DoxyCodeLine{2365 }
\DoxyCodeLine{2366         \textcolor{keyword}{deallocate}(energies)}
\DoxyCodeLine{2367         \textcolor{keyword}{deallocate}(variances)}
\DoxyCodeLine{2368     }

\end{DoxyCode}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{namespacevqmc_ab066adc59fec1fcaaba764a46128c935_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=317pt]{namespacevqmc_ab066adc59fec1fcaaba764a46128c935_icgraph}
\end{center}
\end{figure}


\doxysubsection{Variable Documentation}
\mbox{\Hypertarget{namespacevqmc_a4acb6b64bbac5c4684654d00393f7f24}\label{namespacevqmc_a4acb6b64bbac5c4684654d00393f7f24}} 
\index{vqmc@{vqmc}!ntab@{ntab}}
\index{ntab@{ntab}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{ntab}{ntab}}
{\footnotesize\ttfamily integer, parameter vqmc\+::ntab = 32}



Variable controlling the RNG sequence. 



Definition at line 44 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{44     \textcolor{keywordtype}{integer}, \textcolor{keywordtype}{parameter} :: ntab = 32}

\end{DoxyCode}
\mbox{\Hypertarget{namespacevqmc_a86db46440794b9ef7cfd9fbf1fd69930}\label{namespacevqmc_a86db46440794b9ef7cfd9fbf1fd69930}} 
\index{vqmc@{vqmc}!iv@{iv}}
\index{iv@{iv}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{iv}{iv}}
{\footnotesize\ttfamily integer(int64), dimension(\mbox{\hyperlink{namespacevqmc_a4acb6b64bbac5c4684654d00393f7f24}{ntab}}), save vqmc\+::iv = 0}



Variable controlling the RNG sequence. 



Definition at line 45 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{45     \textcolor{keywordtype}{integer(int64)}, \textcolor{keywordtype}{dimension(ntab)}, \textcolor{keywordtype}{save} :: iv = 0}

\end{DoxyCode}
\mbox{\Hypertarget{namespacevqmc_a1608372d703310a49afc4243ccf27368}\label{namespacevqmc_a1608372d703310a49afc4243ccf27368}} 
\index{vqmc@{vqmc}!iy@{iy}}
\index{iy@{iy}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{iy}{iy}}
{\footnotesize\ttfamily integer(int64), save vqmc\+::iy = 0}



Variable controlling the RNG sequence. 



Definition at line 46 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{46     \textcolor{keywordtype}{integer(int64)}, \textcolor{keywordtype}{save} :: iy = 0}

\end{DoxyCode}
\mbox{\Hypertarget{namespacevqmc_a4f41e2c494f06da125bf9a56314161b5}\label{namespacevqmc_a4f41e2c494f06da125bf9a56314161b5}} 
\index{vqmc@{vqmc}!logfrac@{logfrac}}
\index{logfrac@{logfrac}!vqmc@{vqmc}}
\doxysubsubsection{\texorpdfstring{logfrac}{logfrac}}
{\footnotesize\ttfamily integer vqmc\+::logfrac = 10}



1/logfrac is the fraction of samples to report in the log, if \mbox{\hyperlink{namespaceshared__data_acf2cbacc5b2b4d8ee26c96dc7062aa9b}{shared\+\_\+data\+::write\+\_\+log}} is {\itshape TRUE}. 



Definition at line 49 of file vqmc.\+f90.


\begin{DoxyCode}{0}
\DoxyCodeLine{49     \textcolor{keywordtype}{integer} :: logfrac = 10}

\end{DoxyCode}
